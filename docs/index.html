<!--
APP: AI Strategy Room Viewer
Version: v0.1.1
Date(JST): 2025-12-15 00:29
Title: 画像重複排除修正（内部実装のみ）
Changes:
 - URL正規化キーで重複排除（表示URLは元のまま保持）
 - 画像配列をカードごとに1回生成して保持
 - サムネも拡大も同一配列参照
 - ?raw=1等のクエリパラメータは表示URLで保持
 - ?debug=1時にカード内に画像数と正規化キー一覧を表示
Policy:
 - UI/文言/配置は一切変更しない（内部実装のみ）
 - extractImages()はカードごとに1回だけ実行し、同一配列を参照
 - 正規化は"キー生成のみ"に使い、表示URLは保持
BuildParam(b): ?b=2025-12-15_0029_imgdedupe-v0.1.1
DebugParam: &debug=1
-->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI戦略会議室ビューア</title>
  <style>
    :root { --bg:#0b0d10; --card:#12161c; --text:#e8eef7; --muted:#aab6c6; --line:#222a35; }
    body{ margin:0; font-family: system-ui, -apple-system, "Segoe UI", "Noto Sans JP", sans-serif; background:var(--bg); color:var(--text); }
    header{ position:sticky; top:0; background:rgba(11,13,16,.92); backdrop-filter: blur(10px); border-bottom:1px solid var(--line); padding:12px 14px; z-index:5; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .title{ font-weight:700; }
    .pill{ font-size:12px; color:var(--muted); border:1px solid var(--line); padding:6px 10px; border-radius:999px; }
    input, select{ background:#0f1319; color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px 12px; outline:none; }
    button{ background:#1a2230; color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px 12px; cursor:pointer; }
    button:hover{ filter:brightness(1.08); }
    main{ padding:14px; max-width:1100px; margin:0 auto; }
    .grid{ display:grid; grid-template-columns: 1fr; gap:12px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:14px; }
    .meta{ color:var(--muted); font-size:12px; display:flex; gap:10px; flex-wrap:wrap; }
    .h{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .h a{ color:var(--text); text-decoration:none; }
    .h a:hover{ text-decoration:underline; }
    .body{ color:#d7e0ee; margin:10px 0 0; white-space:pre-wrap; line-height:1.6; font-size:14px; }
    .thumbs{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .thumb{ width:160px; height:100px; object-fit:cover; border-radius:12px; border:1px solid var(--line); background:#0f1319; cursor:pointer; }
    .thumb:hover{ outline:2px solid rgba(255,255,255,.12); }

    /* hover preview (枠なし・ウインドウなし) */
    #hoverPreview{ position:fixed; left:-9999px; top:-9999px; z-index:50; pointer-events:none; }
    #hoverPreview img{ max-width:420px; max-height:280px; display:block; border-radius:0; box-shadow:none; border:none; background:transparent; }

    /* modal dialog */
    #modal{ position:fixed; inset:0; z-index:60; display:none; }
    #modal.show{ display:block; }
    #modalBg{ position:absolute; inset:0; background:rgba(0,0,0,.72); }
    #modalBox{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:18px; }
    #modalInner{ position:relative; max-width:min(92vw, 1200px); max-height:92vh; }
    #modalImg{ display:block; max-width:100%; max-height:92vh; border-radius:14px; border:1px solid rgba(255,255,255,.10); background:#0f1319; }
    #closeBtn{ position:absolute; right:-10px; top:-10px; width:40px; height:40px; border-radius:999px; border:1px solid rgba(255,255,255,.16); background:rgba(10,12,15,.85); color:var(--text); font-size:20px; line-height:38px; text-align:center; cursor:pointer; }
    #closeBtn:hover{ filter:brightness(1.1); }

    .err{ color:#ffb4b4; border:1px solid rgba(255,80,80,.35); background:rgba(255,80,80,.08); padding:10px 12px; border-radius:12px; }
    .ok{ color:var(--muted); font-size:12px; }
  </style>
</head>
<body>
<header>
  <div class="row">
    <div class="title">AI戦略会議室ビューア</div>
    <div class="pill" id="badge">v0.1.1</div>
    <div class="pill" id="repoPill">repo: takecwatanabe-dev/ai-strategy-room</div>
    <div class="pill" id="buildPill">b: -</div>
  </div>
  <div class="row" style="margin-top:10px">
    <label class="pill">状態
      <select id="stateSel">
        <option value="open">open</option>
        <option value="closed">closed</option>
        <option value="all">all</option>
      </select>
    </label>
    <label class="pill">ラベル
      <input id="labelInp" value="task" style="width:140px" />
    </label>
    <label class="pill">検索
      <input id="qInp" placeholder="タイトル/本文" style="width:min(420px, 60vw)" />
    </label>
    <button id="reloadBtn">再読込</button>
    <span class="ok" id="status"></span>
  </div>
</header>

<main>
  <div id="msg"></div>
  <div class="grid" id="list"></div>
</main>

<div id="hoverPreview"><img alt=""></div>

<div id="modal">
  <div id="modalBg"></div>
  <div id="modalBox">
    <div id="modalInner">
      <div id="closeBtn" title="閉じる">×</div>
      <img id="modalImg" alt="">
    </div>
  </div>
</div>

<script>
(() => {
  const $ = (s)=>document.querySelector(s);
  const list = $("#list");
  const msg = $("#msg");
  const status = $("#status");
  const repoPill = $("#repoPill");
  const buildPill = $("#buildPill");

  const hover = $("#hoverPreview");
  const hoverImg = hover.querySelector("img");

  const modal = $("#modal");
  const modalImg = $("#modalImg");

  const params = new URLSearchParams(location.search);
  const b = params.get("b") || "-";
  const debug = params.get("debug") === "1";

  buildPill.textContent = "b: " + b;

  const defaultRepo = params.get("repo") || "takecwatanabe-dev/ai-strategy-room";
  repoPill.textContent = "repo: " + defaultRepo;

  const stateSel = $("#stateSel");
  const labelInp = $("#labelInp");
  const qInp = $("#qInp");
  const reloadBtn = $("#reloadBtn");

  stateSel.value = params.get("state") || "open";
  labelInp.value = params.get("label") || "task";
  qInp.value = params.get("q") || "";

  function setMsg(html, isErr=false){
    msg.innerHTML = html ? `<div class="${isErr?'err':''}">${html}</div>` : "";
  }

  /**
   * URLを正規化して同一画像判定のキーを生成
   * - クエリパラメータ（?以降）を除去
   * - アンカー（#以降）を除去
   * - パス末尾のサイズ指定（/w=400 など）を除去
   * 
   * 注意: 表示URLは元のまま保持（?raw=1等は残す）
   * この関数は重複判定のキー生成のみに使用
   */
  function normalizeImageUrlKey(url) {
    if (!url || typeof url !== 'string') return '';
    
    try {
      const u = new URL(url);
      // クエリパラメータを除去（キー生成用）
      u.search = '';
      // アンカーを除去
      u.hash = '';
      // パス末尾のサイズ指定を除去（例: /w=400, /h=300）
      u.pathname = u.pathname.replace(/\/[wh]=\d+$/i, '');
      
      return u.toString();
    } catch (e) {
      // URL解析に失敗した場合は簡易処理
      return url.split('?')[0].split('#')[0];
    }
  }

  /**
   * Issue本文から画像URLを抽出（重複排除済み）
   * @param {string} text - Issue本文
   * @returns {Array<{key: string, url: string}>} 正規化キーと元URLのペア配列（重複なし）
   */
  function extractImages(text) {
    const imageMap = new Map(); // key -> originalUrl のマップ
    if (!text) return [];
    
    // Markdown形式の画像: ![alt](url)
    const md = /!\[[^\]]*\]\((https?:\/\/[^\s)]+)\)/g;
    // HTML形式の画像: <img src="url">
    const html = /<img[^>]+src=["'](https?:\/\/[^"']+)["'][^>]*>/g;
    
    let m;
    // Markdown画像を抽出
    while ((m = md.exec(text)) !== null) {
      const originalUrl = m[1];
      const key = normalizeImageUrlKey(originalUrl);
      if (key && !imageMap.has(key)) {
        imageMap.set(key, originalUrl); // 最初に見つかった元URLを保持
      }
    }
    // HTML画像を抽出
    while ((m = html.exec(text)) !== null) {
      const originalUrl = m[1];
      const key = normalizeImageUrlKey(originalUrl);
      if (key && !imageMap.has(key)) {
        imageMap.set(key, originalUrl); // 最初に見つかった元URLを保持
      }
    }
    
    // 配列形式で返す（keyとurlのペア）
    return Array.from(imageMap.entries()).map(([key, url]) => ({ key, url }));
  }

  function clipText(s, n=220){
    s = (s || "").replace(/\r/g,"").trim();
    if(s.length <= n) return s;
    return s.slice(0, n) + "…";
  }

  function openModal(url){
    modal.classList.add("show");
    modalImg.src = url;
  }
  function closeModal(){
    modal.classList.remove("show");
    modalImg.src = "";
  }
  $("#modalBg").addEventListener("click", closeModal);
  $("#closeBtn").addEventListener("click", closeModal);
  window.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeModal(); });

  function showHover(url, x, y){
    hoverImg.src = url;
    hover.style.left = (x + 16) + "px";
    hover.style.top  = (y + 16) + "px";
  }
  function hideHover(){
    hover.style.left = "-9999px";
    hover.style.top  = "-9999px";
    hoverImg.src = "";
  }

  async function load(){
    setMsg("");
    list.innerHTML = "";
    status.textContent = "読込中…";

    const [owner, repo] = (defaultRepo || "").split("/");
    if(!owner || !repo){
      setMsg("repo パラメータが不正です。例：?repo=takecwatanabe-dev/ai-strategy-room", true);
      status.textContent = "";
      return;
    }

    const state = stateSel.value;
    const label = (labelInp.value || "").trim();
    const q = (qInp.value || "").trim().toLowerCase();

    const api = new URL(`https://api.github.com/repos/${owner}/${repo}/issues`);
    api.searchParams.set("state", state);
    api.searchParams.set("per_page", "30");
    if(label) api.searchParams.set("labels", label);

    try{
      const res = await fetch(api.toString(), { headers: { "Accept":"application/vnd.github+json" } });
      if(!res.ok){
        const t = await res.text();
        throw new Error(`GitHub API error ${res.status}: ${t}`);
      }
      const items = await res.json();
      const issues = (items || []).filter(x => !x.pull_request);

      const filtered = q
        ? issues.filter(it => (it.title||"").toLowerCase().includes(q) || (it.body||"").toLowerCase().includes(q))
        : issues;

      if(!filtered.length){
        setMsg("対象のIssueがありません（state/label/検索条件を見直してね）");
        status.textContent = "0件";
        return;
      }

      filtered.forEach(it => {
        const card = document.createElement("div");
        card.className = "card";

        // 【修正】画像配列を1回だけ生成して保持（重複排除済み）
        const allImages = extractImages(it.body);
        const topImgs = allImages.slice(0, 6); // サムネ用（先頭6枚）

        // 【修正】カードに画像リストを保存（サムネも拡大も同じ配列を参照）
        card.dataset.allImages = JSON.stringify(allImages.map(img => img.url));

        card.innerHTML = `
          <div class="h">
            <div>
              <div style="font-weight:700;font-size:16px">
                <a href="${it.html_url}" target="_blank" rel="noopener noreferrer">${it.title}</a>
              </div>
              <div class="meta">
                <span>#${it.number}</span>
                <span>state: ${it.state}</span>
                <span>by: ${it.user?.login || "-"}</span>
                <span>created: ${new Date(it.created_at).toLocaleString()}</span>
                ${it.labels?.length ? `<span>labels: ${it.labels.map(l=>l.name).join(", ")}</span>` : ""}
              </div>
            </div>
          </div>
          <div class="body">${clipText(it.body, 240) || "(本文なし)"}</div>
          ${topImgs.length ? `<div class="thumbs"></div>` : ""}
        `;

        if(topImgs.length){
          const thumbs = card.querySelector(".thumbs");
          
          // 【修正】サムネ表示（元のURLを使用、?raw=1等は保持）
          topImgs.forEach(imgObj => {
            const url = imgObj.url; // 元のURLを表示（?raw=1等は保持）
            const im = document.createElement("img");
            im.className = "thumb";
            im.src = url;
            im.loading = "lazy";
            im.alt = "thumb";

            im.addEventListener("mouseenter", (e)=> showHover(url, e.clientX, e.clientY));
            im.addEventListener("mousemove", (e)=> showHover(url, e.clientX, e.clientY));
            im.addEventListener("mouseleave", hideHover);

            // 【修正】モーダル表示も同じ配列を参照
            im.addEventListener("click", ()=> {
              // カードに保存された全画像配列を取得
              const allUrls = JSON.parse(card.dataset.allImages || "[]");
              // クリックされた画像のインデックスを取得
              const currentIndex = topImgs.findIndex(img => img.url === url);
              // モーダルで表示（同じ配列を参照）
              if (currentIndex >= 0 && allUrls.length > 0) {
                openModal(allUrls[currentIndex]);
              } else {
                openModal(url);
              }
            });
            
            thumbs.appendChild(im);
          });
          
          // 【デバッグ用】?debug=1 の場合はカード内に画像数と正規化キー一覧を表示
          if (debug) {
            const debugDiv = document.createElement("div");
            debugDiv.style.cssText = "margin-top:8px; padding:8px; font-size:11px; color:var(--muted); font-family:monospace; background:rgba(255,255,255,.03); border-radius:6px; border:1px solid var(--line);";
            const keysList = allImages.map(img => img.key).join(", ");
            debugDiv.innerHTML = `<strong style="color:#aab6c6;">[DEBUG]</strong> 画像: <strong>${allImages.length}枚</strong> (重複排除済み)<br>正規化キー: <span style="word-break:break-all;">${keysList || "(なし)"}</span>`;
            card.querySelector(".body").after(debugDiv);
          }
        }

        list.appendChild(card);
      });

      status.textContent = `${filtered.length}件`;

    }catch(err){
      setMsg(String(err && err.message ? err.message : err), true);
      status.textContent = "失敗";
    }
  }

  reloadBtn.addEventListener("click", load);

  // 画面URLにも現在条件を反映（ページ更新しても迷子にならない）
  [stateSel, labelInp, qInp].forEach(el => {
    el.addEventListener("change", ()=>{
      const p = new URLSearchParams(location.search);
      p.set("repo", defaultRepo);
      p.set("state", stateSel.value);
      p.set("label", (labelInp.value||"").trim());
      p.set("q", (qInp.value||"").trim());
      if(b && b !== "-") p.set("b", b);
      if(debug) p.set("debug","1");
      history.replaceState(null, "", "?" + p.toString());
    });
  });

  load();
})();
</script>
</body>
</html>

