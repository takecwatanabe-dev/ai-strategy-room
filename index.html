<!--
  APP: AI Strategy Room
  FILE: index.html (Client-side)
  VERSION: v0.2.8-conversation-ui-fix-v3
  BUILD: 2025-12-19_1305_conversation-display-fix
  AUTHOR: Yui (UI Fix) + Rex (Conversation Integration + Display Fix)
  
  TITLE: UI Fix + Conversation Integration + Display Fix
  DATE(JST): 2025-12-19 13:05 JST
  
  CHANGES:
  - UI Fix (Yui): ã‚¹ã‚¯ã‚·ãƒ§/è¤‡æ•°é¸æŠ/ãƒ•ã‚©ãƒ³ãƒˆã‚¹ã‚±ãƒ¼ãƒ«/AIé¸æŠSetç®¡ç†
  - Conversation (Rex): ãƒãƒ«ãƒã‚¿ãƒ¼ãƒ³ä¼šè©±å¯¾å¿œ + ãƒšãƒ«ã‚½ãƒŠå®Ÿè£…
  - Integration: ãƒ¦ã‚¤UI + ãƒ¬ãƒƒã‚¯ã‚¹ä¼šè©±æ©Ÿèƒ½ã®çµ±åˆ
  - Button Behavior Fix (Rex): AIé¸æŠãƒœã‚¿ãƒ³ã®å‹•ä½œå¤‰æ›´ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯è‰²ä»˜ãã§é¸æŠæ©Ÿèƒ½ã‚ªãƒ•ã€æŠ¼ã—ãŸã‚‰ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã§é¸æŠæ©Ÿèƒ½ã‚ªãƒ³ã€3ã¤æŠ¼ã—ãŸã‚‰å…¨å“¡é¸æŠã§ãƒªã‚»ãƒƒãƒˆï¼‰
  - Conversation Display Fix (Rex): ãƒ†ãƒ¼ãƒè¿½è¨˜æ™‚ã®è¡¨ç¤ºæ”¹å–„ï¼ˆè¿½è¨˜åˆ†ã ã‘è¡¨ç¤ºã€æœ€æ–°å›ç­”ã‚’ä¸Šã«è¡¨ç¤ºã€æ™‚é–“ã‚’å¤ªæ–‡å­—ã§è¡¨ç¤ºã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡ç¤ºã¨AIå›ç­”ã‚’è¦–è¦šçš„ã«åŒºåˆ¥ï¼‰
  
  BuildParam(b): ?b=2025-12-19_1043_conversation-persona
  DebugParam: &debug=1
  POLICY: UIã¯æ—¢å­˜é…ç½®ã‚’å¤§ããå´©ã•ãšã€æ“ä½œãƒŸã‚¹ãŒèµ·ãã«ãã„çŠ¶æ…‹ã‚’å„ªå…ˆ
-->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI Strategy Room</title>
  <style>
    :root{
      --bg:#f5f7fb;
      --panel:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;

      --yui:#ff4fa3;
      --gemini:#7c3aed;
      --rex:#8b5a2b;

      --btn:#111827;
      --btnText:#ffffff;

      --ok:#059669;
      --ng:#dc2626;

      --qaScale: 1;          /* Q/Aæ–‡å­—å€ç‡ */
      --qaBase: 14px;        /* åŸºæœ¬æ–‡å­— */
    }

    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", "Noto Sans JP", sans-serif;
    }

    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 18px 14px 32px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 12px 14px;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius: 14px;
    }
    .title{ font-weight:700; font-size:18px; line-height:1.2; }
    .sub{ margin-top:4px; font-size:12px; color:var(--muted); }

    .rightTools{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    select, button{ font-size: 14px; }
    button{ cursor:pointer; user-select:none; }

    .btn{
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      border-radius:10px;
      padding: 9px 12px;
    }
    .btn:hover{ filter:brightness(0.98); }

    .chip{
      font-size: 11px;
      color:var(--muted);
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 2px 8px;
      white-space:nowrap;
      background:#fff;
    }

    .panel{
      margin-top:12px;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
    }

    .label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }

    textarea{
      width:100%;
      min-height: 120px;
      resize: vertical;
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      font-size: 15px;
      line-height: 1.55;
      outline: none;
      background:#fff;
      box-sizing:border-box;
    }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .rowBetween{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }

    /* AIé¸æŠï¼ˆã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³â†’é¸æŠæ™‚ã¯å¡—ã‚Šï¼‰ */
    .agentBtn{
      background:#fff;
      border:2px solid var(--line);
      color:var(--text);
      font-weight:800;
      padding: 10px 14px;
      border-radius: 12px;
      min-width: 74px;
      text-align:center;
      transition: transform .06s ease, filter .12s ease;
    }
    .agentBtn:active{ transform: translateY(1px); }

    .agentBtn.all{
      background: #fff;
      border-color: var(--line);
      color: var(--text);
    }

    /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹ï¼šè‰²ä»˜ãï¼ˆé¸æŠæ©Ÿèƒ½ã‚ªãƒ•ï¼‰ */
    .agentBtn.yui{ background: var(--yui); color:#fff; }
    .agentBtn.gemini{ background: var(--gemini); color:#fff; }
    .agentBtn.rex{ background: var(--rex); color:#fff; }
    .agentBtn.all{ 
      background: var(--btn);
      border-color: var(--btn);
      color: var(--btnText);
    }

    /* é¸æŠçŠ¶æ…‹ï¼ˆis-selectedï¼‰ï¼šã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã§è‰²è¡¨ç¤ºï¼ˆé¸æŠæ©Ÿèƒ½ã‚ªãƒ³ï¼‰ */
    .agentBtn.is-selected.yui{ 
      background: #fff;
      border-color: var(--yui); 
      color: var(--yui); 
    }
    .agentBtn.is-selected.gemini{ 
      background: #fff;
      border-color: var(--gemini); 
      color: var(--gemini); 
    }
    .agentBtn.is-selected.rex{ 
      background: #fff;
      border-color: var(--rex); 
      color: var(--rex); 
    }
    .agentBtn.is-selected.all{ 
      background: #fff;
      border-color: var(--line);
      color: var(--text);
    }

    .btnDiscuss{
      background: #16a34a;
      border:2px solid #16a34a;
      color:#fff;
      font-weight:900;
      padding: 10px 16px;
      border-radius: 12px;
      min-width: 92px;
    }
    .btnDiscuss:disabled{ opacity:.55; cursor:not-allowed; }

    /* ã‚µãƒ ãƒ */
    .thumbs{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .imgPreviewItem{ position: relative; }
    .imgPreview{
      width: 120px;
      height: 120px;
      object-fit: cover;
      border:1px solid var(--line);
      border-radius: 8px;
      background:#fff;
    }
    .removeBtn{
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--ng);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 14px;
      line-height: 1;
    }
    .badge{
      position:absolute;
      left:6px;
      bottom:6px;
      background: rgba(0,0,0,.65);
      color:#fff;
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
    }

    .msg{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background:#fff;
      display:none;
      font-size: 13px;
      line-height: 1.5;
    }
    .msg.info{ display:block; border-color:#bfdbfe; background:#eff6ff; color:#1e3a8a; }
    .msg.warn{ display:block; border-color:#fed7aa; background:#fff7ed; color:#7c2d12; }
    .msg.err{ display:block; border-color:#fecaca; background:#fef2f2; color:#7f1d1d; }

    .apiBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background:#fff;
      display:none;
      font-size: 13px;
      line-height:1.55;
    }

    /* å‡ºåŠ›ã‚«ãƒ¼ãƒ‰ */
    .grid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(3, minmax(220px, 1fr));
      gap: 12px;
    }
    .card{
      background:var(--panel);
      border:2px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      min-height: 240px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .cardHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-weight:800;
    }

    /* æ è‰²ï¼ˆå›ºå®šHEXï¼‰ */
    .yuiFrame{ border-color: #ff9ecc; }
    .geminiFrame{ border-color: #b89df6; }
    .rexFrame{ border-color: #c4a87d; }

    /* Q/A */
    .qa{
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background:#fff;
    }
    .qaRow{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding: 6px 0;
    }
    .qaRow + .qaRow{
      border-top:1px dashed var(--line);
    }
    .qaTag{
      width:22px;
      height:22px;
      border-radius:999px;
      border:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      color:var(--muted);
      flex:0 0 auto;
      background:#fff;
    }
    .qaText{
      white-space: pre-wrap;
      line-height: 1.55;
      font-size: calc(var(--qaBase) * var(--qaScale));
      flex:1;
      color: var(--text);
    }
    .qaText.muted{ color: var(--muted); }
    
    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã¨AIå›ç­”ã®è¦–è¦šçš„åŒºåˆ¥ */
    .userInput{
      font-weight: 700;
      color: #2563eb;
    }
    .aiTime{
      font-weight: 900;
      color: var(--text);
      font-size: calc(var(--qaBase) * var(--qaScale) * 1.1);
    }
    .aiResponse{
      color: var(--text);
    }
    
    /* å¤ªæ–‡å­—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    strong.aiTime{
      font-weight: 900;
      color: var(--text);
    }

    /* è»¢é€ãƒœã‚¿ãƒ³ï¼ˆã‚«ãƒ¼ãƒ‰ä¸‹ï¼‰ */
    .forwardRow{
      margin-top:auto;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      padding-top:10px;
      border-top:1px dashed var(--line);
    }
    .labelTiny{
      font-size:11px;
      color:var(--muted);
      margin-right:6px;
    }
    .miniBtn{
      border:2px solid var(--line);
      background:#fff;
      color:var(--text);
      border-radius:999px;
      padding: 6px 10px;
      font-weight:800;
      font-size:12px;
    }
    .miniBtn.yui{ border-color: var(--yui); color: var(--yui); }
    .miniBtn.gemini{ border-color: var(--gemini); color: var(--gemini); }
    .miniBtn.rex{ border-color: var(--rex); color: var(--rex); }

    .miniBtn:active{ transform: translateY(1px); }

    @media (max-width: 920px){
      .grid{ grid-template-columns: 1fr; }
    }

    /* æ˜¼/å¤œ */
    body.night{
      --bg:#0b1220;
      --panel:#0f172a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --line:#243041;
      --btn:#111827;
      --btnText:#e5e7eb;
    }
    body.night textarea{ background:#0b1220; color:#e5e7eb; }
    body.night .apiBox, body.night .msg, body.night .qa{ background:#0b1220; }
    body.night .chip{ background:#0b1220; }

    /* ã‚¹ã‚¯ã‚·ãƒ§ã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ */
    #shotFlash{
      position:fixed;
      inset:0;
      background:#fff;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index:9999;
    }
    #shotFlash.on{ opacity:.35; }
  </style>
</head>
<body>
  <div id="shotFlash"></div>

  <div class="wrap">
    <!-- Topbar -->
    <div class="topbar">
      <div>
        <div class="title">AI Strategy Room</div>
        <div class="sub">
          Ver: <?= APP_VERSION ?> | UI: v0.2.8-conversation-ui | Build: <?= BUILD_ID ?> | <?= NOW_JST ?>
        </div>
      </div>
      <div class="rightTools">
        <select onchange="setTheme(this.value)">
          <option value="light">æ˜¼ (è¦‹ã‚„ã™ã„)</option>
          <option value="night">å¤œ</option>
        </select>

        <!-- Q/Aæ–‡å­—ã‚µã‚¤ã‚º -->
        <button class="btn" onclick="fontMinus()">A-</button>
        <span class="chip" id="fontPct">100%</span>
        <button class="btn" onclick="fontPlus()">A+</button>

        <button onclick="togglePing()">API Check</button>
        <button class="btn" onclick="clearConversationDisplay()" title="ä¼šè©±å±¥æ­´ã‚’ã‚¯ãƒªã‚¢">å±¥æ­´ã‚¯ãƒªã‚¢</button>
      </div>
    </div>

    <!-- Ping Result -->
    <div id="pingResult" class="apiBox"></div>

    <!-- Input Panel -->
    <div class="panel">
      <div class="label">ãƒ†ãƒ¼ãƒ (ã“ã“ã¯ãƒ­ã‚°ã«ã‚‚æ®‹ã‚Šã¾ã™)</div>
      <textarea id="userInput" placeholder="ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šãƒã‚°ä¿®æ­£ã®æ–¹é‡ã«ã¤ã„ã¦ï¼‰"></textarea>

      <div style="margin-top:10px;">
        <div class="label">ç”»åƒ(URLä¸è¦ã€‚ã“ã“ã§ç›´æ¥é¸ã³ã¾ã™/ã‚¹ã‚¯ã‚·ãƒ§ã‚‚OK) - æœ€å¤§10æšã¾ã§</div>
        <div class="row">
          <input type="file" id="fileInput" accept="image/*" multiple>
          <button class="btn" onclick="clearImages()">ã‚¯ãƒªã‚¢</button>
          <button class="btn" onclick="captureScreenshot()">ã‚¹ã‚¯ã‚·ãƒ§</button>
        </div>

        <!-- AIé¸æŠ + DISCUSS -->
        <div class="rowBetween" style="margin-top:10px;">
          <div class="row">
            <div class="label" style="margin-bottom:0; margin-right:8px;">AIé¸æŠ:</div>
            <button type="button" class="agentBtn all" data-agent="all" onclick="toggleAgent('all')">å…¨å“¡</button>
            <button type="button" class="agentBtn yui" data-agent="yui" onclick="toggleAgent('yui')">Yui</button>
            <button type="button" class="agentBtn gemini" data-agent="gemini" onclick="toggleAgent('gemini')">GEMINI</button>
            <button type="button" class="agentBtn rex" data-agent="rex" onclick="toggleAgent('rex')">Rex</button>
          </div>
          <button class="btnDiscuss" id="sendBtn" onclick="runDiscuss()">ğŸš€ DISCUSS</button>
        </div>

        <!-- ã‚µãƒ ãƒ -->
        <div id="thumbs" class="thumbs"></div>
      </div>

      <div id="status" class="msg info" style="display:none;"></div>
    </div>

    <!-- Output Grid -->
    <div class="grid">
      <div class="card yuiFrame" data-ai="yui">
        <div class="cardHead">
          <span>ğŸ¤ Yui</span>
          <span class="chip" id="time-yui" style="display:none;"></span>
        </div>
        <div class="qa">
          <div class="qaRow"><span class="qaTag">Q</span><div id="q-yui" class="qaText muted">-</div></div>
          <div class="qaRow"><span class="qaTag">A</span><div id="a-yui" class="qaText muted">-</div></div>
        </div>
        <div class="forwardRow">
          <span class="labelTiny">ã“ã®å›ç­”ã‚’é€ã‚‹:</span>
          <button class="miniBtn gemini" onclick="forwardAnswer('yui','gemini')">â†’ Gemini</button>
          <button class="miniBtn rex" onclick="forwardAnswer('yui','rex')">â†’ Rex</button>
        </div>
      </div>

      <div class="card geminiFrame" data-ai="gemini">
        <div class="cardHead">
          <span>âœ¨ Gemini</span>
          <span class="chip" id="time-gemini" style="display:none;"></span>
        </div>
        <div class="qa">
          <div class="qaRow"><span class="qaTag">Q</span><div id="q-gemini" class="qaText muted">-</div></div>
          <div class="qaRow"><span class="qaTag">A</span><div id="a-gemini" class="qaText muted">-</div></div>
        </div>
        <div class="forwardRow">
          <span class="labelTiny">ã“ã®å›ç­”ã‚’é€ã‚‹:</span>
          <button class="miniBtn yui" onclick="forwardAnswer('gemini','yui')">â†’ Yui</button>
          <button class="miniBtn rex" onclick="forwardAnswer('gemini','rex')">â†’ Rex</button>
        </div>
      </div>

      <div class="card rexFrame" data-ai="rex">
        <div class="cardHead">
          <span>ğŸ¦ Rex</span>
          <span class="chip" id="time-rex" style="display:none;"></span>
        </div>
        <div class="qa">
          <div class="qaRow"><span class="qaTag">Q</span><div id="q-rex" class="qaText muted">-</div></div>
          <div class="qaRow"><span class="qaTag">A</span><div id="a-rex" class="qaText muted">-</div></div>
        </div>
        <div class="forwardRow">
          <span class="labelTiny">ã“ã®å›ç­”ã‚’é€ã‚‹:</span>
          <button class="miniBtn yui" onclick="forwardAnswer('rex','yui')">â†’ Yui</button>
          <button class="miniBtn gemini" onclick="forwardAnswer('rex','gemini')">â†’ Gemini</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== è¨­å®š =====
    const UI_VERSION = "v0.2.8-conversation-ui";
    const MAX_IMAGES = 10;
    const AI_LIST = ["yui","gemini","rex"];
    const AI_LABEL = { yui:"Yui", gemini:"Gemini", rex:"Rex" };

    // ===== çŠ¶æ…‹ =====
    let images = []; // {id, kind:'file'|'shot', file?:File, base64, mime, name, createdAt}
    let selectedAgents = new Set(); // åˆæœŸã¯èª°ã‚‚é¸æŠã—ã¦ã„ãªã„ï¼ˆå…¨éƒ¨è‰²ãŒä»˜ã„ãŸçŠ¶æ…‹ = éé¸æŠï¼‰
    
    // â˜…v0.2.8è¿½åŠ ï¼šä¼šè©±å±¥æ­´ç®¡ç†ï¼ˆAPIç”¨ï¼‰
    let conversationHistory = {
      yui: [],   // [{ role: 'user'|'assistant'|'model', content: '...' }, ...]
      rex: [],   // ç›´è¿‘10å¾€å¾©ã¾ã§ä¿æŒ
      gemini: [] // å¤ã„ã‚‚ã®ã‹ã‚‰å‰Šé™¤
    };
    let roomSharedHistory = []; // ç›´è¿‘3ãƒ©ã‚¦ãƒ³ãƒ‰åˆ†ï¼ˆçŸ­ã‚ãƒ†ã‚­ã‚¹ãƒˆï¼‰
    const MAX_HISTORY_PER_AI = 10; // AIã”ã¨ã®æœ€å¤§å±¥æ­´æ•°
    const MAX_SHARED_ROUNDS = 3;   // å…±æœ‰ãƒ­ã‚°ã®æœ€å¤§ãƒ©ã‚¦ãƒ³ãƒ‰æ•°
    
    // UIè¡¨ç¤ºç”¨å±¥æ­´ï¼ˆãƒ¦ã‚¤UIå½¢å¼ï¼‰
    let histories = { yui:[], gemini:[], rex:[] }; // {t, q, a}

    // æ–‡å­—å€ç‡
    let qaScale = 1;

    // èµ·å‹•
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('fileInput').addEventListener('change', onFilePicked);
      applyFontScale();
      // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®šï¼ˆå…¨ã¦éé¸æŠçŠ¶æ…‹ = ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã§è‰²ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ï¼‰
      updateAgentButtons();
      updateSelectedTimeChips();
      // ä¼šè©±å±¥æ­´ã‚’å¾©å…ƒï¼ˆlocalStorageã‹ã‚‰ï¼‰
      loadConversationDisplay();
      // Driveæ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆã‚ã£ã¦ã‚‚ç„¡ãã¦ã‚‚å‹•ãï¼‰
      try{
        google.script.run
          .withSuccessHandler(()=>{})
          .withFailureHandler(()=>{})
          .checkDriveAuth();
      }catch(e){}
    });
    
    // ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹å‰ã«ä¼šè©±å±¥æ­´ã‚’ä¿å­˜
    window.addEventListener('beforeunload', () => {
      saveConversationDisplay();
    });

    // ===== ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ =====
    function setTheme(mode) {
      if(mode === 'night') document.body.classList.add('night');
      else document.body.classList.remove('night');
    }

    // ===== æ–‡å­—ã‚µã‚¤ã‚ºï¼ˆQ/Aã®ã¿ï¼‰ =====
    function applyFontScale(){
      document.documentElement.style.setProperty('--qaScale', String(qaScale));
      document.getElementById('fontPct').textContent = Math.round(qaScale*100) + "%";
    }
    function fontMinus(){
      qaScale = Math.max(0.85, Math.round((qaScale - 0.1)*100)/100);
      applyFontScale();
    }
    function fontPlus(){
      qaScale = Math.min(1.6, Math.round((qaScale + 0.1)*100)/100);
      applyFontScale();
    }

    // ===== AIé¸æŠï¼ˆè¤‡æ•°é¸æŠï¼‰ =====
    function toggleAgent(agent){
      if(agent === "all"){
        // å…¨å“¡ãƒœã‚¿ãƒ³ï¼šå…¨å“¡é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
        selectedAgents = new Set(AI_LIST);
        updateAgentButtons();
        updateSelectedTimeChips();
        return;
      }

      // å€‹åˆ¥AIãƒœã‚¿ãƒ³ï¼šæŠ¼ã—ãŸã‚‰é¸æŠã«ã™ã‚‹ï¼ˆãƒˆã‚°ãƒ«ï¼‰
      if(selectedAgents.has(agent)) {
        // æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯éé¸æŠã«
        selectedAgents.delete(agent);
      } else {
        // é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯é¸æŠã«
        selectedAgents.add(agent);
      }

      // 3ã¤é¸æŠã—ãŸæ™‚ç‚¹ã§å…¨å“¡é¸æŠçŠ¶æ…‹ã«ãªã‚Šã€å„ãƒœã‚¿ãƒ³ã¯éé¸æŠçŠ¶æ…‹ã«æˆ»ã‚‹
      if(selectedAgents.size === 3){
        selectedAgents = new Set(); // å…¨å“¡é¸æŠçŠ¶æ…‹ = èª°ã‚‚é¸æŠã—ã¦ã„ãªã„çŠ¶æ…‹
      }

      updateAgentButtons();
      updateSelectedTimeChips();
    }

    function updateAgentButtons(){
      const allBtn = document.querySelector('.agentBtn.all');
      const yuiBtn = document.querySelector('.agentBtn.yui');
      const gemBtn = document.querySelector('.agentBtn.gemini');
      const rexBtn = document.querySelector('.agentBtn.rex');

      const isAll = (selectedAgents.size === 0); // èª°ã‚‚é¸æŠã—ã¦ã„ãªã„ = å…¨å“¡é¸æŠçŠ¶æ…‹

      // å…¨å“¡ãƒœã‚¿ãƒ³ï¼šå…¨å“¡é¸æŠæ™‚ï¼ˆèª°ã‚‚é¸æŠã—ã¦ã„ãªã„æ™‚ï¼‰ã¯éé¸æŠçŠ¶æ…‹ï¼ˆè‰²ä»˜ãã€é¸æŠæ©Ÿèƒ½ã‚ªãƒ•ï¼‰
      allBtn.classList.toggle('is-selected', isAll);

      // å€‹åˆ¥AIãƒœã‚¿ãƒ³ï¼šé¸æŠã•ã‚Œã¦ã„ã‚‹AIã¯ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ï¼ˆis-selected = é¸æŠæ©Ÿèƒ½ã‚ªãƒ³ï¼‰ã€éé¸æŠã¯è‰²ä»˜ãï¼ˆé¸æŠæ©Ÿèƒ½ã‚ªãƒ•ï¼‰
      yuiBtn.classList.toggle('is-selected', selectedAgents.has('yui'));
      gemBtn.classList.toggle('is-selected', selectedAgents.has('gemini'));
      rexBtn.classList.toggle('is-selected', selectedAgents.has('rex'));
    }

    function updateSelectedTimeChips(){
      AI_LIST.forEach(ai=>{
        const chip = document.getElementById('time-'+ai);
        // ã€Œé¸ã‚“ã AIã ã‘ã€æ™‚åˆ»ã‚’è¦‹ã›ã‚‹
        chip.style.display = selectedAgents.has(ai) ? 'inline-flex' : 'none';
      });
    }

    // ===== API Check =====
    function togglePing() {
      const el = document.getElementById('pingResult');
      if (el.style.display === 'block') { el.style.display = 'none'; return; }

      el.style.display = 'block';
      el.textContent = "Checking connection...";
      google.script.run
        .withSuccessHandler(res => {
          el.innerHTML = `Success!<br>Keys: Yui=${res.keys?.yui?"OK":"NG"}, Rex=${res.keys?.rex?"OK":"NG"}, Gemini=${res.keys?.gemini?"OK":"NG"}`;
        })
        .withFailureHandler(err => { el.textContent = "Ping Error: " + err.message; })
        .testPing();
    }

    // ===== ç”»åƒï¼šãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ =====
    function onFilePicked(){
      const files = Array.from(document.getElementById('fileInput').files || []);
      // æ—¢å­˜ã®fileç”»åƒã ã‘æ¶ˆã™ï¼ˆã‚¹ã‚¯ã‚·ãƒ§ã¯æ®‹ã™ï¼‰
      images = images.filter(x => x.kind !== 'file');

      const room = MAX_IMAGES - images.length;
      const useFiles = files.slice(0, Math.max(0, room));

      if(files.length > useFiles.length){
        showStatus(`ç”»åƒã¯æœ€å¤§${MAX_IMAGES}æšã§ã™ã€‚è¶…ãˆãŸåˆ†ã¯èª­ã¿è¾¼ã¿ã¾ã›ã‚“ã€‚`, 'warn');
      }

      let pending = useFiles.length;
      if(pending === 0){ renderThumbs(); return; }

      useFiles.forEach(file=>{
        const id = makeId();
        const reader = new FileReader();
        reader.onload = (e)=>{
          images.push({
            id, kind:'file', file,
            base64: e.target.result,
            mime: file.type || 'image/jpeg',
            name: file.name || 'image',
            createdAt: Date.now()
          });
          pending--;
          if(pending === 0) renderThumbs();
        };
        reader.onerror = ()=>{
          pending--;
          if(pending === 0) renderThumbs();
        };
        reader.readAsDataURL(file);
      });
    }

    function clearImages(){
      images = [];
      document.getElementById('fileInput').value = '';
      renderThumbs();
      showStatus('ç”»åƒã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
    }

    function removeImage(id){
      const removed = images.find(x=>x.id===id);
      images = images.filter(x=>x.id!==id);

      // fileInputå´ã‚‚å†æ§‹ç¯‰ï¼ˆfileã ã‘ï¼‰
      try{
        const dt = new DataTransfer();
        images.filter(x=>x.kind==='file' && x.file).forEach(x=>dt.items.add(x.file));
        document.getElementById('fileInput').files = dt.files;
      }catch(e){}

      renderThumbs();
      if(removed) showStatus(`å‰Šé™¤ã—ã¾ã—ãŸ: ${removed.kind==='shot'?'ã‚¹ã‚¯ã‚·ãƒ§':'ç”»åƒ'}`, 'info');
    }

    function renderThumbs(){
      const box = document.getElementById('thumbs');
      box.innerHTML = '';
      images.forEach((img)=>{
        const item = document.createElement('div');
        item.className = 'imgPreviewItem';
        item.innerHTML = `
          <img src="${img.base64}" class="imgPreview" alt="thumb">
          <button class="removeBtn" onclick="removeImage('${img.id}')" title="å‰Šé™¤">Ã—</button>
          ${img.kind==='shot' ? `<div class="badge">SHOT</div>` : ``}
        `;
        box.appendChild(item);
      });
    }

    // ===== ã‚¹ã‚¯ã‚·ãƒ§ï¼ˆã“ã®ãƒšãƒ¼ã‚¸å†…ã ã‘ï¼‰ =====
    function flashShot(){
      const f = document.getElementById('shotFlash');
      f.classList.add('on');
      setTimeout(()=>f.classList.remove('on'), 180);
    }

    function loadScriptOnce(url, testGlobal){
      return new Promise((resolve, reject)=>{
        if(testGlobal && window[testGlobal]) return resolve();
        const existed = Array.from(document.scripts).some(s=>s.src===url);
        if(existed){
          // èª­ã¿è¾¼ã¿å¾…ã¡
          const t = setInterval(()=>{
            if(testGlobal && window[testGlobal]){
              clearInterval(t); resolve();
            }
          }, 60);
          setTimeout(()=>{ clearInterval(t); reject(new Error('script load timeout')); }, 5000);
          return;
        }
        const s = document.createElement('script');
        s.src = url;
        s.onload = ()=> resolve();
        s.onerror = ()=> reject(new Error('script load failed'));
        document.head.appendChild(s);
      });
    }

    async function captureScreenshot(){
      if(images.length >= MAX_IMAGES){
        showStatus(`ç”»åƒã¯æœ€å¤§${MAX_IMAGES}æšã§ã™ã€‚å…ˆã«å‰Šé™¤ã—ã¦ã­ã€‚`, 'warn');
        return;
      }
      showStatus('ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±ä¸­ï¼ˆä¼šè­°å®¤ç”»é¢ã®ã¿ï¼‰...', 'info');

      try{
        await loadScriptOnce(
          'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
          'html2canvas'
        );

        const target = document.querySelector('.wrap');
        const canvas = await html2canvas(target, {
          backgroundColor: '#ffffff',
          scale: 1,
          logging: false,
          useCORS: true
        });

        const base64 = canvas.toDataURL('image/png');
        images.push({
          id: makeId(),
          kind:'shot',
          base64,
          mime:'image/png',
          name:'screenshot.png',
          createdAt: Date.now()
        });
        renderThumbs();
        flashShot();
        showStatus('ã‚¹ã‚¯ã‚·ãƒ§ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆã‚µãƒ ãƒç¢ºèªOKï¼‰', 'info');

        // Driveä¿å­˜ã¯ã€Œã§ããŸã‚‰ã€ã ã‘ï¼ˆå¤±æ•—ã—ã¦ã‚‚OKï¼‰
        try{
          google.script.run
            .withSuccessHandler((url)=>{
              if(url) showStatus('ã‚¹ã‚¯ã‚·ãƒ§ä¿å­˜ï¼ˆDriveï¼‰: ' + url, 'info');
            })
            .withFailureHandler(()=>{})
            .saveImageToDrive(base64, 'image/png');
        }catch(e){}

      }catch(err){
        showStatus('ã‚¹ã‚¯ã‚·ãƒ§ã«å¤±æ•—: ' + err.message, 'err');
      }
    }

    // ===== å®Ÿè¡Œï¼šDISCUSS =====
    function runDiscuss(){
      const text = (document.getElementById('userInput').value || '').trim();
      if(!text){
        showStatus('ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warn');
        return;
      }

      // èª°ã‚‚é¸æŠã—ã¦ã„ãªã„å ´åˆã¯å…¨å“¡é¸æŠã¨ã—ã¦æ‰±ã†
      const targets = selectedAgents.size === 0 ? AI_LIST : Array.from(selectedAgents);

      const btn = document.getElementById('sendBtn');
      btn.disabled = true;
      btn.textContent = "Thinking...";

      showStatus(`Processing: ${targets.map(t=>AI_LABEL[t]).join(', ')} ...`, 'info');

      // ç”»åƒå‡¦ç†ï¼ˆç¸®å°ã—ã¦é€ã‚‹ï¼‰
      const payload = images.map(x=>({base64:x.base64, mime:x.mime}));
      if(payload.length > 0){
        showStatus(`Resizing Images (${payload.length}æš)...`, 'info');
        processMultipleImages(payload, (processed)=>{
          runForTargets(text, processed, targets, () => {
            btn.disabled = false;
            btn.textContent = "ğŸš€ DISCUSS";
          });
        });
      }else{
        runForTargets(text, [], targets, () => {
          btn.disabled = false;
          btn.textContent = "ğŸš€ DISCUSS";
        });
      }
    }

    function runForTargets(text, imagesArray, targets, done){
      let pending = targets.length;

      // â˜…v0.2.8è¿½åŠ ï¼šä¼šè©±å±¥æ­´ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æ§‹ç¯‰
      const historyPayload = {
        perAIHistory: {
          yui: conversationHistory.yui.slice(-MAX_HISTORY_PER_AI * 2),
          rex: conversationHistory.rex.slice(-MAX_HISTORY_PER_AI * 2),
          gemini: conversationHistory.gemini.slice(-MAX_HISTORY_PER_AI * 2)
        },
        roomSharedHistory: roomSharedHistory.slice(-MAX_SHARED_ROUNDS)
      };

      targets.forEach(ai=>{
        // UIï¼šQã‚’æ›´æ–°ï¼†Thinking
        setQA(ai, text, "Thinking...", true);

        // targetã‚’å˜ä¸€AIåã«å¤‰æ›ï¼ˆ'all'ã®å ´åˆã¯å„AIåï¼‰
        const target = ai;
        
        google.script.run
          .withSuccessHandler((res)=>{
            const ans = pickAnswer(ai, res);
            setQA(ai, text, ans || '-', false);
            stampTime(ai);
            appendHistory(ai, text, ans || '-');
            
            // â˜…v0.2.8è¿½åŠ ï¼šä¼šè©±å±¥æ­´ã‚’æ›´æ–°ï¼ˆAPIç”¨ï¼‰
            if (ans && ans !== '-') {
              conversationHistory[ai].push({ role: 'user', content: text });
              // Geminiã¯modelãƒ­ãƒ¼ãƒ«ã€ä»–ã¯assistantãƒ­ãƒ¼ãƒ«
              const assistantRole = (ai === 'gemini') ? 'model' : 'assistant';
              conversationHistory[ai].push({ role: assistantRole, content: ans });
              
              // ä¸Šé™è¶…éæ™‚ã¯å¤ã„ã‚‚ã®ã‹ã‚‰å‰Šé™¤
              if (conversationHistory[ai].length > MAX_HISTORY_PER_AI * 2) {
                conversationHistory[ai] = conversationHistory[ai].slice(-MAX_HISTORY_PER_AI * 2);
              }
            }
            
            // å…±æœ‰ãƒ­ã‚°ã‚’æ›´æ–°ï¼ˆç›´è¿‘3ãƒ©ã‚¦ãƒ³ãƒ‰åˆ†ï¼‰
            const roundText = `ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${text}\n`;
            let aiResponses = '';
            if (res?.data) {
              if (res.data.yui && res.data.yui !== '(ã‚¹ã‚­ãƒƒãƒ—)') {
                aiResponses += `Yui: ${res.data.yui.substring(0, 200)}...\n`;
              }
              if (res.data.rex && res.data.rex !== '(ã‚¹ã‚­ãƒƒãƒ—)') {
                aiResponses += `Rex: ${res.data.rex.substring(0, 200)}...\n`;
              }
              if (res.data.gemini && res.data.gemini !== '(ã‚¹ã‚­ãƒƒãƒ—)') {
                aiResponses += `Gemini: ${res.data.gemini.substring(0, 200)}...\n`;
              }
            }
            if (aiResponses) {
              roomSharedHistory.push(roundText + aiResponses);
              if (roomSharedHistory.length > MAX_SHARED_ROUNDS) {
                roomSharedHistory = roomSharedHistory.slice(-MAX_SHARED_ROUNDS);
              }
            }
            
            pending--;
            if(pending===0){
              showStatus('Complete', 'info');
              done();
            }
          })
          .withFailureHandler((err)=>{
            setQA(ai, text, '(Error) ' + (err?.message || 'unknown'), false);
            stampTime(ai);
            pending--;
            if(pending===0){
              showStatus('Complete (with errors)', 'warn');
              done();
            }
          })
          .runRelay(text, imagesArray, target, historyPayload);
      });
    }

    function pickAnswer(ai, res){
      // reså½¢å¼ã®æºã‚Œã«å¼·ã
      try{
        if(res?.data && typeof res.data === 'object'){
          if(res.data[ai]) return res.data[ai];
          // ä¸‡ä¸€ allå½¢å¼ã§ã‚‚æ‹¾ã†
          const k = ai;
          if(res.data[k]) return res.data[k];
        }
        if(res && typeof res === 'object'){
          if(res[ai]) return res[ai];
        }
        if(typeof res === 'string') return res;
        return JSON.stringify(res);
      }catch(e){
        return '(parse error)';
      }
    }

    // å„AIã®ä¼šè©±å±¥æ­´ã‚’ä¿æŒï¼ˆæœ€æ–°ã‚’ä¸Šã«è¡¨ç¤ºï¼‰
    let conversationDisplay = {
      yui: [],   // [{time, userInput, aiResponse}, ...] æœ€æ–°ãŒå…ˆé ­
      gemini: [],
      rex: []
    };
    
    // å‰å›ã®ãƒ†ãƒ¼ãƒã‚’ä¿æŒï¼ˆè¿½è¨˜éƒ¨åˆ†ã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ï¼‰
    let previousTheme = '';
    
    // â˜…ä¼šè©±å±¥æ­´ã®ä¿å­˜ãƒ»å¾©å…ƒï¼ˆlocalStorageä½¿ç”¨ï¼‰
    const STORAGE_KEY_CONVERSATION = 'ai_strategy_room_conversation';
    const STORAGE_KEY_THEME = 'ai_strategy_room_previous_theme';
    
    function saveConversationDisplay(){
      try{
        localStorage.setItem(STORAGE_KEY_CONVERSATION, JSON.stringify(conversationDisplay));
        localStorage.setItem(STORAGE_KEY_THEME, previousTheme);
      }catch(e){
        console.warn('ä¼šè©±å±¥æ­´ã®ä¿å­˜ã«å¤±æ•—:', e);
      }
    }
    
    function loadConversationDisplay(){
      try{
        const saved = localStorage.getItem(STORAGE_KEY_CONVERSATION);
        if(saved){
          const parsed = JSON.parse(saved);
          if(parsed.yui) conversationDisplay.yui = parsed.yui;
          if(parsed.gemini) conversationDisplay.gemini = parsed.gemini;
          if(parsed.rex) conversationDisplay.rex = parsed.rex;
        }
        
        const savedTheme = localStorage.getItem(STORAGE_KEY_THEME);
        if(savedTheme) previousTheme = savedTheme;
        
        // å¾©å…ƒã—ãŸä¼šè©±ã‚’ç”»é¢ã«è¡¨ç¤º
        AI_LIST.forEach(ai => {
          const qEl = document.getElementById('q-'+ai);
          const aEl = document.getElementById('a-'+ai);
          if(qEl && aEl) renderConversation(ai, qEl, aEl);
        });
      }catch(e){
        console.warn('ä¼šè©±å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
      }
    }
    
    function clearConversationDisplay(){
      conversationDisplay = { yui: [], gemini: [], rex: [] };
      previousTheme = '';
      localStorage.removeItem(STORAGE_KEY_CONVERSATION);
      localStorage.removeItem(STORAGE_KEY_THEME);
      AI_LIST.forEach(ai => {
        const qEl = document.getElementById('q-'+ai);
        const aEl = document.getElementById('a-'+ai);
        if(qEl) qEl.innerHTML = '-';
        if(aEl) aEl.innerHTML = '-';
      });
    }

    function setQA(ai, q, a, thinking){
      const qEl = document.getElementById('q-'+ai);
      const aEl = document.getElementById('a-'+ai);
      
      if(thinking){
        // Thinkingä¸­ï¼šè¿½è¨˜å†…å®¹ã ã‘ã‚’è¡¨ç¤º
        const currentTime = nowHHMMSS();
        
        // è¿½è¨˜éƒ¨åˆ†ã‚’æ¤œå‡ºï¼ˆå‰å›ã®ãƒ†ãƒ¼ãƒã¨æ¯”è¼ƒï¼‰
        let displayInput = q || '-';
        if(previousTheme && q && q.startsWith(previousTheme)){
          // å‰å›ã®ãƒ†ãƒ¼ãƒã§å§‹ã¾ã£ã¦ã„ã‚‹å ´åˆã¯è¿½è¨˜éƒ¨åˆ†ã ã‘ã‚’è¡¨ç¤º
          displayInput = q.substring(previousTheme.length).trim();
          if(!displayInput) displayInput = q; // è¿½è¨˜éƒ¨åˆ†ãŒãªã„å ´åˆã¯å…¨ä½“ã‚’è¡¨ç¤º
        }
        
        const newEntry = {
          time: currentTime,
          userInput: displayInput, // è¿½è¨˜éƒ¨åˆ†ã ã‘ã‚’ä¿å­˜
          aiResponse: 'Thinking...'
        };
        conversationDisplay[ai].unshift(newEntry); // æœ€æ–°ã‚’å…ˆé ­ã«
        
        // è¡¨ç¤ºï¼šæœ€æ–°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã ã‘ã‚’è¡¨ç¤ºï¼ˆè¿½è¨˜åˆ†ã®ã¿ï¼‰
        qEl.innerHTML = formatUserInput(newEntry.userInput);
        aEl.innerHTML = '<span class="muted">Thinking...</span>';
        aEl.classList.add('muted');
        
        // ãƒ†ãƒ¼ãƒã‚’æ›´æ–°ï¼ˆæ¬¡ã®è¿½è¨˜æ¤œå‡ºã®ãŸã‚ï¼‰
        if(q) previousTheme = q;
      } else {
        // å›ç­”ãŒè¿”ã£ã¦ããŸæ™‚
        const currentTime = nowHHMMSS();
        
        // æœ€æ–°ã®ã‚¨ãƒ³ãƒˆãƒªã‚’æ›´æ–°
        if(conversationDisplay[ai].length > 0 && conversationDisplay[ai][0].aiResponse === 'Thinking...'){
          conversationDisplay[ai][0].aiResponse = a || '-';
          conversationDisplay[ai][0].time = currentTime;
        } else {
          // æ–°ã—ã„ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ 
          let displayInput = q || '-';
          if(previousTheme && q && q.startsWith(previousTheme)){
            displayInput = q.substring(previousTheme.length).trim();
            if(!displayInput) displayInput = q;
          }
          conversationDisplay[ai].unshift({
            time: currentTime,
            userInput: displayInput,
            aiResponse: a || '-'
          });
        }
        
        // è¡¨ç¤ºï¼šæœ€æ–°ã®å›ç­”ã‚’ä¸Šã«ã€ä¼šè©±å½¢å¼ã§è¡¨ç¤º
        renderConversation(ai, qEl, aEl);
        aEl.classList.remove('muted');
      }
      
      qEl.classList.remove('muted');
      
      // ä¼šè©±å±¥æ­´ã‚’ä¿å­˜ï¼ˆlocalStorageï¼‰
      saveConversationDisplay();
    }

    function formatUserInput(input){
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã‚’è¦–è¦šçš„ã«åŒºåˆ¥
      return '<span class="userInput">ã€ã‚ãªãŸã€‘</span> ' + escapeHtml(input);
    }

    function formatAIResponse(time, response){
      // AIã®å›ç­”ã‚’è¦–è¦šçš„ã«åŒºåˆ¥ï¼ˆæ™‚é–“ã‚’å¤ªæ–‡å­—ã§å…ˆé ­ã«ï¼‰
      return '<strong class="aiTime">' + escapeHtml(time) + '</strong> <span class="aiResponse">' + escapeHtml(response) + '</span>';
    }

    function renderConversation(ai, qEl, aEl){
      // æœ€æ–°ã®å›ç­”ã‚’ä¸Šã«è¡¨ç¤ºï¼ˆä¼šè©±å½¢å¼ï¼‰
      const conversations = conversationDisplay[ai];
      if(conversations.length === 0){
        qEl.innerHTML = '-';
        aEl.innerHTML = '-';
        return;
      }
      
      // æœ€æ–°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã ã‘ã‚’è¡¨ç¤ºï¼ˆè¿½è¨˜åˆ†ã®ã¿ï¼‰
      const latestUserInput = conversations[0].userInput;
      qEl.innerHTML = formatUserInput(latestUserInput);
      
      // AIã®å›ç­”ã‚’æœ€æ–°ã‹ã‚‰é †ã«è¡¨ç¤ºï¼ˆæœ€æ–°ãŒä¸Šï¼‰
      const responses = conversations
        .filter(c => c.aiResponse && c.aiResponse !== 'Thinking...' && c.aiResponse !== '-')
        .map(c => formatAIResponse(c.time, c.aiResponse))
        .join('<br><br>');
      
      aEl.innerHTML = responses || '-';
    }

    function escapeHtml(text){
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function stampTime(ai){
      const chip = document.getElementById('time-'+ai);
      chip.textContent = nowHHMMSS();
      updateSelectedTimeChips();
    }

    function appendHistory(ai, q, a){
      histories[ai] = histories[ai] || [];
      histories[ai].push({ t: Date.now(), q, a });
      // å¿…è¦ä»¥ä¸Šã«è‚¥å¤§åŒ–ã—ãªã„
      if(histories[ai].length > 30) histories[ai] = histories[ai].slice(-30);
    }

    // ===== å›ç­”ã®è»¢é€ï¼ˆã‚«ãƒ¼ãƒ‰ä¸‹ãƒœã‚¿ãƒ³ï¼‰ =====
    function forwardAnswer(from, to){
      // conversationDisplayã‹ã‚‰æœ€æ–°ã®å›ç­”ã‚’å–å¾—
      const latestResponse = conversationDisplay[from] && conversationDisplay[from].length > 0 
        ? conversationDisplay[from].find(c => c.aiResponse && c.aiResponse !== 'Thinking...' && c.aiResponse !== '-')
        : null;
      
      if(!latestResponse || !latestResponse.aiResponse){
        showStatus('è»¢é€ã™ã‚‹å›ç­”ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“', 'warn');
        return;
      }
      
      const text = `ã€${AI_LABEL[from]}ã®å›ç­”ã€‘\n${latestResponse.aiResponse}\n\nã“ã‚Œã‚’è¸ã¾ãˆã¦ã€æ”¹å–„ç‚¹/æŠœã‘/æ¬¡ã®ä¸€æ‰‹ã‚’æ•™ãˆã¦ã€‚`;
      // toã ã‘é¸æŠã—ã¦æŠ•ã’ã‚‹
      selectedAgents = new Set([to]);
      updateAgentButtons();
      updateSelectedTimeChips();

      // å…¥åŠ›æ¬„ã‚‚è»¢é€æ–‡ã«ã™ã‚‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¦å®‰å¿ƒï¼‰
      document.getElementById('userInput').value = text;
      runDiscuss();
    }

    // ===== ç”»åƒç¸®å° =====
    function processMultipleImages(imagesArray, callback) {
      const maxWidth = 800;
      const quality = 0.7;
      const processed = [];
      let completed = 0;

      if (imagesArray.length === 0) { callback([]); return; }

      imagesArray.forEach((item, index) => {
        const img = new Image();
        img.onload = function() {
          let w = img.width, h = img.height;
          if (w > maxWidth) { h = Math.round(h * (maxWidth / w)); w = maxWidth; }
          const cvs = document.createElement('canvas');
          cvs.width = w; cvs.height = h;
          cvs.getContext('2d').drawImage(img, 0, 0, w, h);
          processed[index] = {
            base64: cvs.toDataURL('image/jpeg', quality),
            mime: item.mime || 'image/jpeg'
          };
          completed++;
          if (completed === imagesArray.length) callback(processed);
        };
        img.onerror = function() {
          processed[index] = item;
          completed++;
          if (completed === imagesArray.length) callback(processed);
        };
        img.src = item.base64;
      });
    }

    // ===== Status =====
    function showStatus(msg, type) {
      const st = document.getElementById('status');
      st.textContent = msg;
      st.className = 'msg ' + (type || 'info');
      st.style.display = 'block';
    }

    // ===== Utils =====
    function makeId(){
      return 'id_' + Math.random().toString(36).slice(2,9) + '_' + Date.now().toString(36);
    }
    function nowHHMMSS(){
      const d = new Date();
      const z = (n)=> String(n).padStart(2,'0');
      return `${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
    }
  </script>
</body>
</html>
