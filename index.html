<!--
  APP: AI Strategy Room
  FILE: index.html (Client-side)
  VERSION: v5.12.2-stable
  BUILD: 2025-12-23_2209_fix
  AUTHOR: Rex (HEIC/PDFå¯¾å¿œ + è‡ªå‹•åœ§ç¸®ãƒ»å®Œå…¨ç‰ˆ)
  
  TITLE: HEIC/PDFå¯¾å¿œ + è‡ªå‹•åœ§ç¸®ãƒ»å®Œå…¨ç‰ˆ (v5.12.2)
  DATE(JST): 2025-12-23 22:09 JST
  
  CHANGES:
  - Base (ãªã¹ã•ã‚“â†’Rex): v5.10.0-fixedUIã‚’åŸºæº–ã«é‹ç”¨ãƒã‚°ä¿®æ­£
  - BuildParam/è¡¨ç¤ºãƒ˜ãƒƒãƒ€ã®ä¸æ•´åˆã‚’è§£æ¶ˆ (ãªã¹ã•ã‚“â†’Rex): ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’çµ±ä¸€
  - é¸æŠè»¢é€ãƒ¢ãƒ¼ãƒ‰ã§ã€Œå…¨å“¡ã€ã‚’æŠ¼ã™ã¨è½ã¡ã‚‹å¯èƒ½æ€§ã‚’æ½°ã™ (ãªã¹ã•ã‚“â†’Rex): agent==="all"ã®å ´åˆã€3ã‚«ãƒ©ãƒ ã«è¤‡è£½
  - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒãƒ¼ã®å®Œäº†åˆ¤å®šã‚’ä¿®æ­£ (ãªã¹ã•ã‚“â†’Rex): 3å›ºå®šâ†’å‹•çš„ï¼ˆé€ä¿¡æ•°ã«å¿œã˜ã¦ï¼‰
  - å±¥æ­´å‰Šé™¤ãƒœã‚¿ãƒ³ã®disabledå¯¾ç­– (ãªã¹ã•ã‚“â†’Rex): pointer-eventsåˆ¶å¾¡ã§äºŒé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢
  - tryStartNewSession()ã®ã‚³ãƒ¡ãƒ³ãƒˆä¿®æ­£ (ãªã¹ã•ã‚“â†’Rex): å®Ÿè£…ã¨ä¸€è‡´
  
  BuildParam(b): ?b=2025-12-23_2209_fix
  DebugParam: &debug=1
  POLICY: v5.10.0ã®è¦‹ãŸç›®ã‚’ç¶­æŒã—ã¤ã¤ã€é‹ç”¨ãƒã‚°ã‚’ä¿®æ­£
-->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>AI Strategy Room</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <!-- PDF.js for PDF to image conversion -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // PDF.js workerè¨­å®šï¼ˆå¿…é ˆï¼‰
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    }
  </script>
  <!-- heic2any for HEIC/HEIF to JPG conversion -->
  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
  <style>
    /* åŸºæœ¬è¨­å®š */
    :root { 
      --bg-color: #f3f4f6; 
      --card-bg: #ffffff; 
      --text-color: #333333; 
      --accent-color: #50C878;
      --fontScale: 1.0; /* æ–‡å­—ã‚µã‚¤ã‚ºå€ç‡ï¼ˆ1.0 = 100%, 1.1 = 110%, ...ï¼‰ */
      --base: 14px; /* åŸºæº–ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º */
    }
    body { 
      background-color: var(--bg-color); 
      font-family: 'Helvetica Neue', Arial, sans-serif; 
      color: var(--text-color); 
      font-size: calc(var(--base) * var(--fontScale));
    }
    /* â˜…ä¿®æ­£ï¼šã™ã¹ã¦ã®è¦ç´ ã§ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’inheritã§çµ±ä¸€â˜… */
    input, textarea, button, .card, .card * { font-size: inherit; }
    .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
    
    /* â˜…1æ®µç›®ï¼šæœ€ä¸Šæ®µï¼ˆæ®µã‚³ãƒ³ãƒ†ãƒŠé™å®šã§nowrap + overflow-x:autoï¼‰â˜… */
    .tier-1 { 
      display: flex; 
      flex-wrap: nowrap;
      justify-content: space-between; 
      margin-bottom: 15px; 
      align-items: center;
      white-space: nowrap;
      min-width: 100%;
      overflow-x: auto;
    }
    .tier-1-left { display: flex; gap: 10px; align-items: center; }
    .tier-1-right { display: flex; gap: 10px; align-items: center; }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼å‘¨ã‚Šï¼ˆv5.4.0äº’æ›ï¼‰ */
    .settings-bar { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; }
    .btn-pill { 
      padding: 0 20px; border-radius: 8px; border: 1px solid #ccc; font-weight: bold; cursor: pointer; 
      display: flex; align-items: center; justify-content: center; 
      background: #fff; color: #555; height: 45px; transition: 0.2s;
    }
    .btn-pill:hover { background: #f0f0f0; transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

    /* â˜…2æ®µç›®ï¼šã‚¢ãƒ—ãƒªåç§°ï¼‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‹ãƒ“ãƒ«ãƒ‰ç•ªå·â˜… */
    .tier-2 { 
      display: flex; 
      flex-wrap: nowrap;
      justify-content: space-between; 
      margin-bottom: 10px;
      white-space: nowrap;
      min-width: 100%;
      overflow-x: auto;
    }

    /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
    .input-card { background: var(--card-bg); padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; }
    
    /* â˜…3æ®µç›®ï¼šã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›æ¬„â˜… */
    .title-input { display: block; width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-weight: bold; color: #333; }
    
    /* â˜…4æ®µç›®ï¼šæœ¬æ–‡å…¥åŠ›æ¬„â˜… */
    textarea { width: 100%; height: 120px; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical; line-height: 1.6; }
    
    /* â˜…5æ®µç›®ï¼šç”»åƒæ“ä½œã‚¨ãƒªã‚¢ï¼ˆæ ã§å›²ã†ã€æ®µã‚³ãƒ³ãƒ†ãƒŠé™å®šã§nowrap + overflow-x:autoï¼‰â˜… */
    .tier-5 { 
      display: flex; 
      flex-wrap: nowrap;
      gap: 10px; 
      align-items: center; 
      margin-top: 15px; 
      padding: 15px; 
      border: 2px solid #e5e7eb; 
      border-radius: 8px; 
      background: #f9fafb;
      white-space: nowrap;
      min-width: 100%;
      overflow-x: auto;
    }
    .screenshot-msg { font-size: 0.9rem; color: #d97706; font-weight: bold; background: #fff8e1; border: 1px solid #fae0b5; padding: 4px 10px; border-radius: 6px; }

    /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆv5.4.0äº’æ›ï¼‰ */
    .sub-tools { display: flex; gap: 10px; align-items: center; margin-top: 15px; flex-wrap: wrap; }

    /* â˜…6æ®µç›®ï¼šFrom/To/å®Ÿè¡Œï¼ˆæ®µã‚³ãƒ³ãƒ†ãƒŠé™å®šã§nowrap + overflow-x:autoï¼‰â˜… */
    .tier-6 { 
      display: flex; 
      flex-wrap: nowrap;
      gap: 20px; 
      align-items: center; 
      margin-top: 20px; 
      border-top: 1px solid #eee; 
      padding-top: 20px;
      white-space: nowrap;
      min-width: 100%;
      overflow-x: auto;
    }
    .cmd-group { display: flex; gap: 10px; align-items: center; }
    .cmd-label { font-weight: bold; font-size: 1rem; color: #555; }
    
    .proxy-select { padding: 0 15px; height: 45px; border-radius: 8px; border: 1px solid #ccc; background: #fff; font-weight: bold; cursor: pointer; font-size: 1rem; }

    /* AIé¸æŠãƒœã‚¿ãƒ³ (ãƒˆã‚°ãƒ«å¼) */
    .btn-ai { 
      border: none; transition: all 0.2s; height: 45px; border-radius: 8px; padding: 0 25px; 
      font-weight: bold; cursor: pointer; background: #e0e0e0; color: #777; font-size: 1rem;
    }
    .btn-all.active { background-color: #1f2937; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .btn-yui.active { background-color: #ec4899; color: white; box-shadow: 0 4px 8px rgba(236,72,153,0.3); }
    .btn-gemini.active { background-color: #8b5cf6; color: white; box-shadow: 0 4px 8px rgba(139,92,246,0.3); }
    .btn-rex.active { background-color: #d97706; color: white; box-shadow: 0 4px 8px rgba(217,119,6,0.3); }
    
    /* è³ªå•/Discussãƒœã‚¿ãƒ³ */
    .btn-question { 
      background-color: #3b82f6; 
      color: white; 
      border: none; 
      padding: 0 30px; 
      height: 50px; 
      border-radius: 10px; 
      font-weight: bold; 
      font-size: 1.1rem; 
      box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); 
      cursor: pointer; 
      transition: 0.2s;
    }
    .btn-question:hover { background-color: #2563eb; transform: translateY(-2px); }
    
    .btn-discuss { 
      background-color: var(--accent-color); color: white; border: none; padding: 0 40px; 
      height: 50px; border-radius: 10px; font-weight: bold; font-size: 1.1rem; 
      box-shadow: 0 4px 10px rgba(80, 200, 120, 0.3); cursor: pointer; transition: 0.2s;
    }
    .btn-discuss:hover { background-color: #43a047; transform: translateY(-2px); }

    /* ã‚³ãƒãƒ³ãƒ‰ãƒãƒ¼ (v5.4.0äº’æ›) */
    .command-bar { display: flex; flex-wrap: wrap; gap: 20px; align-items: center; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }

    /* â˜…7æ®µç›®ï¼š3ã‚«ãƒ©ãƒ å›ºå®šï¼ˆå¹…ã‚’å´©ã•ãªã„ï¼‰â˜… */
    .chat-grid { 
      display: grid; 
      grid-template-columns: repeat(3, minmax(0, 1fr)); /* â˜…ä¿®æ­£ï¼šminmax(0, 1fr)ã§å›ºå®šâ˜… */
      gap: 25px; 
    }
    .column { 
      background: #fff; border-radius: 15px; padding: 20px; 
      border-top: 8px solid #ccc; min-height: 600px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      min-width: 0; /* â˜…ä¿®æ­£ï¼šã“ã‚ŒãŒç„¡ã„ã¨é•·æ–‡ã§åˆ—ãŒåºƒãŒã‚‹â˜… */
    }
    /* AIã”ã¨ã®ã‚«ãƒ©ãƒ¼ */
    .col-yui { border-color: #ec4899; } 
    .col-gemini { border-color: #8b5cf6; } 
    .col-rex { border-color: #d97706; }
    .col-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #eee; padding-bottom: 10px; }

    /* ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºä»•æ§˜ */
    .turn-group { 
      border: 1px solid #e5e7eb; 
      border-radius: 12px; 
      background: #fff; 
      overflow: hidden; 
      margin-bottom: 25px; 
      position: relative;
      min-width: 0; /* â˜…ä¿®æ­£ï¼šé•·æ–‡ã§åˆ—ãŒåºƒãŒã‚‰ãªã„â˜… */
    }
    /* â˜…ä¿®æ­£ï¼šã‚«ãƒ¼ãƒ‰æœ¬æ–‡ï¼šURLã‚„é•·æ–‡ã§æ¨ªã«ä¼¸ã³ãªã„â˜… */
    .turn-group, .turn-group * { 
      overflow-wrap: anywhere; 
      word-break: break-word; 
    }
    .turn-group pre, .turn-group code { 
      white-space: pre-wrap; 
      overflow-x: auto; 
    }
    .turn-group img { 
      max-width: 100%; 
      height: auto; 
      display: block; 
    }
    .question-part { 
      background: #f0fdf4; 
      border-bottom: 1px solid #eee; 
      padding: 15px; 
      color: #444; 
      border-left: 5px solid var(--accent-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .answer-part { 
      padding: 20px; 
      line-height: 1.7; 
      color: #333; 
    }
    /* â˜…ä¿®æ­£ï¼šæŠ˜ã‚ŠãŸãŸã¿æ™‚ã€å…ˆé ­2è¡Œã¯å¿…ãšè¡¨ç¤ºâ˜… */
    .card-collapsed .answer-part { 
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .card-toggle { 
      cursor: pointer; 
      color: #666; 
      user-select: none;
      margin-left: 10px;
      padding: 2px 8px;
      border-radius: 4px;
      background: #f0f0f0;
      font-size: inherit;
    }
    .card-toggle:hover { background: #e0e0e0; }
    .card-delete { 
      cursor: pointer; 
      color: #dc2626; 
      margin-left: 10px;
      padding: 2px 8px;
      border-radius: 4px;
      background: #fee2e2;
      font-size: inherit;
      font-weight: bold;
    }
    .card-delete:hover { background: #fecaca; }
    .card-actions { 
      display: flex; 
      gap: 10px; 
      padding: 10px 15px; 
      border-top: 1px solid #eee; 
      background: #f9fafb;
      flex-wrap: wrap;
    }
    .card-action-btn { 
      padding: 5px 15px; 
      border-radius: 6px; 
      border: 1px solid #ccc; 
      background: #fff; 
      cursor: pointer; 
      font-size: 0.9rem;
    }
    .card-image { 
      max-width: 100%; 
      margin: 10px 0; 
      border-radius: 8px; 
    }
    
    /* å¹ãå‡ºã—ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆv5.4.0äº’æ›ï¼‰ */
    .turn-group-old { border: 1px solid #e5e7eb; border-radius: 12px; background: #fff; overflow: hidden; margin-bottom: 25px; }
    .question-part-old { background: #f0fdf4; border-bottom: 1px solid #eee; padding: 15px; font-size: 0.95rem; color: #444; border-left: 5px solid var(--accent-color); }
    .answer-part-old { padding: 20px; font-size: 1.05rem; line-height: 1.7; color: #333; }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 999999; }
    /* â˜…ä¿®æ­£ï¼šç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¯æœ€å‰é¢ã«è¡¨ç¤ºâ˜… */
    #customConfirmModal { z-index: 9999999 !important; }
    .modal-content { background: #fff; width: 90%; max-width: 800px; max-height: 80vh; border-radius: 12px; padding: 25px; display: flex; flex-direction: column; }
    .log-list { overflow-y: auto; flex-grow: 1; }
    .log-item { 
      padding: 15px; 
      border-bottom: 1px solid #eee; 
      cursor: pointer; 
      transition: 0.1s; 
      display: flex;
      justify-content: space-between;
      align-items: center;
    } 
    .log-item:hover { background: #f9f9f9; }
    .log-item-delete { 
      color: #dc2626; 
      cursor: pointer; 
      margin-left: 10px;
      padding: 5px 10px;
      border-radius: 4px;
    }
    .log-item-delete:hover { background: #fee2e2; }
    
    /* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼é¸æŠãƒ»æ–‡å­—ã‚µã‚¤ã‚ºé¸æŠ */
    .theme-select, .font-size-select { 
      padding: 0 15px; 
      height: 45px; 
      border-radius: 8px; 
      border: 1px solid #ccc; 
      background: #fff; 
      font-weight: bold; 
      cursor: pointer; 
      font-size: 0.9rem;
    }
    
    /* ã‚³ãƒ¼ãƒ‰è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« */
    .code-modal { 
      background: #1e293b; 
      color: #e2e8f0; 
      padding: 20px; 
      border-radius: 8px; 
      max-height: 70vh; 
      overflow-y: auto; 
      font-family: 'Courier New', monospace;
    }

    /* â˜…ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¨­å®š (ã‚¹ãƒãƒ›ç”¨)â˜… */
    @media (max-width: 1280px) {
      body { font-size: 15px; }
      .container { padding: 10px; }
      
      /* ã‚°ãƒªãƒƒãƒ‰ã‚’1åˆ—ã«å¤‰æ›´ */
      .chat-grid { grid-template-columns: 1fr; gap: 30px; }
      
      /* å„ç¨®ãƒãƒ¼ã‚’ç¸¦ç©ã¿ã« */
      .settings-bar, .command-bar, .sub-tools, .tier-1, .tier-5, .tier-6 { flex-direction: column; align-items: stretch; gap: 10px; white-space: normal; overflow-x: visible; }
      .header-left, .header-right, .cmd-group { flex-direction: column; align-items: stretch; width: 100%; }
      
      /* ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã‚„ã™ãå¤§ãã */
      .btn-pill, .btn-ai, .proxy-select, .btn-discuss, .btn-question { height: 50px; width: 100%; margin: 0; justify-content: center; font-size: 1.1rem; }
      .cmd-group { margin: 0 !important; }
    }
  </style>
</head>
<body>
<div class="container">
  <!-- â˜…1æ®µç›®ï¼šæœ€ä¸Šæ®µâ˜… -->
  <div class="tier-1">
    <div class="tier-1-left">
      <button class="btn-pill" onclick="openHistoryModal()">ğŸ“‚ éå»ãƒ­ã‚°</button>
      <div id="saveStatus" style="display:flex; align-items:center; color:#50C878; font-weight:bold; margin:0 10px;">è‡ªå‹•ä¿å­˜ -</div>
      <button class="btn-pill" onclick="tryStartNewSession()">ğŸ”„ ä¼šè­°ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
    <div class="tier-1-right">
      <button class="btn-pill" onclick="openManualModal()">â“ èª¬æ˜æ›¸</button>
      <button class="btn-pill" onclick="openAdvanceModal()">âš™ï¸ Advance</button>
      <select id="themeSelect" class="theme-select" onchange="setTheme(this.value)">
        <option value="standard">ãƒ†ãƒ¼ãƒ: æ¨™æº–</option>
        <option value="navy">ãƒ†ãƒ¼ãƒ: Navy</option>
        <option value="dark">ãƒ†ãƒ¼ãƒ: Dark</option>
      </select>
      <select id="fontSizeSelect" class="font-size-select" onchange="setFontSize(this.value)">
        <option value="100">æ–‡å­—: 100%</option>
        <option value="110">æ–‡å­—: 110%</option>
        <option value="120">æ–‡å­—: 120%</option>
        <option value="130">æ–‡å­—: 130%</option>
        <option value="140">æ–‡å­—: 140%</option>
        <option value="150">æ–‡å­—: 150%</option>
      </select>
    </div>
  </div>

  <!-- â˜…2æ®µç›®ï¼šã‚¢ãƒ—ãƒªåç§°ï¼‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‹ãƒ“ãƒ«ãƒ‰ç•ªå·â˜… -->
  <div class="input-card">
    <div class="tier-2">
      <div style="font-size:1.2rem; font-weight:bold; color:#444;">AI Strategy Room <span style="font-size:0.8rem; background:#eee; padding:2px 6px; border-radius:4px;" id="appVersion">v5.12.2-stable</span> <span style="font-size:0.7rem; color:#999;" id="buildInfo">Build: <span id="buildId">2025-12-23_2209_fix</span></span></div>
      <div id="clock" style="color:#888; font-weight:bold;"></div>
    </div>

    <!-- â˜…3æ®µç›®ï¼šã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›æ¬„â˜… -->
    <input type="text" id="topicTitle" class="title-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆæœªå…¥åŠ›ã®å ´åˆã¯AIãŒå†…å®¹ã‹ã‚‰è‡ªå‹•ç”Ÿæˆã—ã¾ã™ï¼‰">
    
    <!-- â˜…4æ®µç›®ï¼šæœ¬æ–‡å…¥åŠ›æ¬„â˜… -->
    <textarea id="themeInput" placeholder="ã“ã“ã«è­°é¡Œã‚„ç›¸è«‡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„... (ç”»åƒã‚’Ctrl+Vã§è²¼ã‚Šä»˜ã‘å¯èƒ½)"></textarea>

    <!-- â˜…5æ®µç›®ï¼šç”»åƒæ“ä½œã‚¨ãƒªã‚¢ï¼ˆæ ã§å›²ã†ï¼‰â˜… -->
    <div class="tier-5">
      <input type="file" id="fileInput" multiple accept="image/*,.heic,.heif,application/pdf,.pdf" style="display:none" onchange="handleFileSelect(event)">
      <button class="btn-pill" onclick="document.getElementById('fileInput').click()">ğŸ“· ç”»åƒé¸æŠ</button>
      <span class="screenshot-msg">âœ‚ï¸ ã‚¹ã‚¯ã‚·ãƒ§èª¬æ˜</span>
      <button class="btn-pill" onclick="pasteFromClipboard()">ğŸ“‹ ã‚¹ã‚¯ã‚·ãƒ§è²¼ä»˜ã‘</button>
      <button class="btn-pill" onclick="resetInputArea()">ğŸ§¹ å…¥åŠ›å†…å®¹ã‚¯ãƒªã‚¢</button>
      <div id="previewArea" style="display:flex; gap:5px; margin-left:10px;"></div>
    </div>

    <!-- â˜…6æ®µç›®ï¼šFrom/To/å®Ÿè¡Œâ˜… -->
    <div class="tier-6">
      <div class="cmd-group">
        <span class="cmd-label">From:</span>
        <select id="speakerSelect" class="proxy-select">
          <option value="User">ğŸ™‹â€â™‚ï¸ è‡ªåˆ† (User)</option>
          <option value="Yui">â™¥ Yui</option>
          <option value="Gemini">â™¦ Gemini</option>
          <option value="Rex">â™  Rex</option>
        </select>
      </div>

      <div class="cmd-group" style="flex-grow:1; justify-content:center;">
        <span class="cmd-label">To:</span>
        <button class="btn-ai btn-all" id="btn-all" onclick="handleAgentClick('all', event)">å…¨å“¡</button>
        <button class="btn-ai btn-yui" id="btn-yui" onclick="handleAgentClick('yui', event)">Yui</button>
        <button class="btn-ai btn-gemini" id="btn-gemini" onclick="handleAgentClick('gemini', event)">Gemini</button>
        <button class="btn-ai btn-rex" id="btn-rex" onclick="handleAgentClick('rex', event)">Rex</button>
      </div>

      <div class="cmd-group" style="margin-left:auto;">
        <button class="btn-question" onclick="startQuestion()">è³ªå•</button>
        <button class="btn-discuss" onclick="startDiscuss()">Discuss</button>
      </div>
    </div>
    <div id="loadingBar" style="height:4px; width:100%; background:linear-gradient(90deg, #ec4899, #8b5cf6, #50C878); display:none; margin-top:10px;"></div>
  </div>

  <!-- â˜…7æ®µç›®ï¼š3ã‚«ãƒ©ãƒ å›ºå®šâ˜… -->
  <div class="chat-grid">
    <div class="column col-yui">
      <div class="col-header" style="color:#ec4899"><span>â™¥</span> Yui (Secretary)</div>
      <div id="hist-yui"></div>
    </div>
    <div class="column col-gemini">
      <div class="col-header" style="color:#8b5cf6"><span>â™¦</span> Gemini (Analyst)</div>
      <div id="hist-gemini"></div>
    </div>
    <div class="column col-rex">
      <div class="col-header" style="color:#d97706"><span>â™ </span> Rex (Red Team)</div>
      <div id="hist-rex"></div>
    </div>
  </div>
</div>

<div id="customConfirmModal" class="modal-overlay"><div class="modal-content" style="width:400px; height:auto; text-align:center;"><p id="confirmMessage" style="margin-bottom:20px; font-weight:bold;"></p><div style="display:flex; justify-content:center; gap:10px;"><button id="confirmYesBtn" class="btn-pill" style="background:#0b1020; color:white;">OK</button><button id="confirmCancelBtn" class="btn-pill">Cancel</button></div></div></div>
<div id="customAlertModal" class="modal-overlay"><div class="modal-content" style="width:400px; height:auto; text-align:center;"><p id="alertMessage" style="margin-bottom:20px; font-weight:bold;"></p><button onclick="closeAlertModal()" class="btn-pill">OK</button></div></div>
<div id="historyModal" class="modal-overlay"><div class="modal-content"><div style="display:flex;justify-content:space-between;margin-bottom:10px;"><h2>ğŸ“‚ éå»ãƒ­ã‚°ä¸€è¦§ï¼ˆæœ€æ–°10ä»¶ï¼‰</h2><button onclick="closeHistoryModal()" style="font-size:1.5rem;">&times;</button></div><div id="logListContainer" class="log-list"></div></div></div>
<div id="manualModal" class="modal-overlay"><div class="modal-content"><div style="display:flex;justify-content:space-between;margin-bottom:10px;"><h2>â“ èª¬æ˜æ›¸</h2><button onclick="closeManualModal()" style="font-size:1.5rem;">&times;</button></div><div style="padding:15px; line-height:1.8;"><h3>åŸºæœ¬æ“ä½œ</h3><p><strong>1. Fromé¸æŠ:</strong> ç™ºè¨€è€…ã‚’é¸ã³ã¾ã™ï¼ˆåŸºæœ¬ã¯è‡ªåˆ†ã§OKï¼‰ã€‚<br><strong>2. Toé¸æŠ:</strong> è©±ã—ãŸã„AIã‚’é¸ã³ã¾ã™ï¼ˆè¤‡æ•°å¯ï¼‰ã€‚è‰²ã¯ON/OFFã‚’è¡¨ã—ã¾ã™ã€‚<br><strong>3. è³ªå•:</strong> é€šå¸¸ã®é€ä¿¡ãƒœã‚¿ãƒ³ã§ã™ã€‚<br><strong>4. Discuss:</strong> 3AIã§è‡ªå‹•ä¼šè©±ã‚’å›ã™ãƒœã‚¿ãƒ³ã§ã™ã€‚</p><h3>ä¾¿åˆ©æ©Ÿèƒ½</h3><p>ãƒ»ç”»åƒã®è²¼ã‚Šä»˜ã‘(Ctrl+V)ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚<br>ãƒ»ç¯„å›²é¸æŠè»¢é€ï¼šæœ¬æ–‡ã‚„å›ç­”ã§ã‚«ãƒ¼ã‚½ãƒ«ç¯„å›²é¸æŠä¸­ã«AIé¸æŠãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€é¸æŠéƒ¨åˆ†ã ã‘ã‚’æŒ‡å®šAIã¸è»¢é€ã§ãã¾ã™ã€‚<br>ãƒ»ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ã‚‚å†…å®¹ã¯ä¸€æ™‚ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p></div></div></div>
<div id="advanceModal" class="modal-overlay"><div class="modal-content"><div style="display:flex;justify-content:space-between;margin-bottom:10px;"><h2>âš™ï¸ Advance</h2><button onclick="closeAdvanceModal()" style="font-size:1.5rem;">&times;</button></div><div style="padding:15px; line-height:1.8;"><p>è¨­è¨ˆå›³èª­ã¿è¾¼ã¿ç­‰ã®æ©Ÿèƒ½ã¯ã“ã“ã«å…¥ã‚Œã‚‹æƒ³å®šã§ã™ã€‚</p></div></div></div>
<div id="codeModal" class="modal-overlay"><div class="modal-content"><div style="display:flex;justify-content:space-between;margin-bottom:10px;"><h2>ğŸ“ ã‚³ãƒ¼ãƒ‰è¡¨ç¤º</h2><button onclick="closeCodeModal()" style="font-size:1.5rem;">&times;</button></div><div id="codeContent" class="code-modal"></div></div></div>
<div id="screenshotModal" class="modal-overlay"><div class="modal-content"><div style="display:flex;justify-content:space-between;margin-bottom:10px;"><h2>ğŸ“· ã‚¹ã‚¯ã‚·ãƒ§ï¼ˆç”»åƒæ·»ä»˜ï¼‰</h2><button onclick="closeScreenshotModal()" style="font-size:1.5rem;">&times;</button></div><div style="padding:15px;"><input type="file" id="cardImageInput" multiple accept="image/*,.heic,.heif,application/pdf,.pdf" style="display:none" onchange="handleCardImageSelect(event)"><button class="btn-pill" onclick="document.getElementById('cardImageInput').click()">ç”»åƒã‚’é¸æŠ</button><div id="cardImagePreview" style="margin-top:10px;"></div></div></div></div>

<script>
  // ===== è¨­å®š =====
  // â˜…ç‰ˆæƒ…å ±ä¸€å…ƒåŒ–ï¼šCode.gsã‹ã‚‰æ³¨å…¥ã•ã‚Œã‚‹å€¤ã‚’ä½¿ç”¨ï¼ˆæ‰‹æ‰“ã¡ã—ãªã„ï¼‰â˜…
  const APP_VERSION = "<?= APP_VERSION ?>" || "v5.12.2-stable"; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  const BUILD_ID = "<?= BUILD_ID ?>" || "2025-12-23_2209_fix"; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  const AUTHOR = "<?= AUTHOR ?>" || "Rex (HEIC/PDFå¯¾å¿œ + è‡ªå‹•åœ§ç¸®ãƒ»å®Œå…¨ç‰ˆ)";
  const BUILD_JST = "<?= BUILD_JST ?>" || "2025-12-23 22:09 JST";
  
  // â˜…ç‰ˆæƒ…å ±ä¸€å…ƒåŒ–ï¼šURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰bï¼ˆé…å¸ƒç”¨ï¼‰ã‚’èª­ã¿å–ã‚‹â˜…
  const urlParams = new URLSearchParams(window.location.search);
  const urlBuildId = urlParams.get('b');
  const isDebug = urlParams.get('debug') === '1';
  const currentBuildId = urlBuildId || BUILD_ID; // URLã®bãŒã‚ã‚Œã°ãã‚Œå„ªå…ˆ
  
  // ===== çŠ¶æ…‹ =====
  let selectedAgents = new Set(); // ç©ºã‚»ãƒƒãƒˆ = å…¨å“¡é¸æŠçŠ¶æ…‹
  let imagesBase64 = [];
  let historyData = { perAIHistory: { yui: [], gemini: [], rex: [] } };
  let sessionId = "SESS_" + new Date().getTime();
  const STORAGE_KEY = 'ai_room_v5_stable';
  const MAX_DISPLAY_PER_AI = 50; // å„AIã®è¡¨ç¤ºå±¥æ­´ã¯æœ€å¤§50ä»¶
  let cardCounter = 0; // ã‚«ãƒ¼ãƒ‰IDç”¨ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
  let answerCardCount = { yui: 0, gemini: 0, rex: 0 }; // å›ç­”ã‚«ãƒ¼ãƒ‰ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ˆæŠ˜ã‚ŠãŸãŸã¿åˆ¤å®šç”¨ï¼‰
  let currentScreenshotCardId = null; // ã‚¹ã‚¯ã‚·ãƒ§ãƒœã‚¿ãƒ³ç”¨ã®ã‚«ãƒ¼ãƒ‰ID
  
  // ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼è¨­å®š
  const themes = {
    standard: { bg: '#f3f4f6', card: '#ffffff', text: '#333333', accent: '#50C878' },
    navy: { bg: '#1e3a5f', card: '#2d4a6b', text: '#e2e8f0', accent: '#60a5fa' },
    dark: { bg: '#1a1a1a', card: '#2d2d2d', text: '#e5e5e5', accent: '#50C878' }
  };
  
  window.onload = function() {
    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’è¡¨ç¤º
    const appVersionEl = document.getElementById('appVersion');
    const buildIdEl = document.getElementById('buildId');
    
    // â˜…ç‰ˆæƒ…å ±ä¸€å…ƒåŒ–ï¼šdebug=1ã®ã¨ãã ã‘å³ä¸Šã«è¡¨ç¤ºâ˜…
    if (isDebug) {
      const debugInfo = document.createElement('div');
      debugInfo.id = 'debugVersionInfo';
      debugInfo.style.cssText = 'position:fixed; top:10px; right:10px; background:#fff; border:2px solid #50C878; padding:8px 12px; border-radius:6px; font-size:11px; z-index:999999; box-shadow:0 2px 8px rgba(0,0,0,0.2);';
      debugInfo.innerHTML = `<div style="font-weight:bold; color:#50C878; margin-bottom:4px;">DEBUG MODE</div><div>v${APP_VERSION}</div><div style="font-size:10px; color:#666;">b=${currentBuildId}</div>`;
      document.body.appendChild(debugInfo);
    }
    if(appVersionEl) appVersionEl.textContent = APP_VERSION;
    if(buildIdEl) buildIdEl.textContent = currentBuildId; // URLã®bãŒã‚ã‚Œã°ãã‚Œå„ªå…ˆ
    
    updateClock(); 
    setInterval(updateClock, 60000);
    updateButtonsVisual();
    // â˜…ä¿®æ­£ï¼šhandlePasteæœªå®šç¾©ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ï¼ˆè²¼ã‚Šä»˜ã‘ã¯pasteFromClipboard()ã«çµ±ä¸€ï¼‰â˜…
    loadHistoryFromStorage();
    loadSettings();
  };
  
  // æ™‚è¨ˆæ›´æ–°ï¼ˆè‡ªå‹•ä¿å­˜æ—¥æ™‚ã‚‚æ›´æ–°ï¼‰
  function updateClock() {
    const now = new Date();
    const timeStr = now.toLocaleString('ja-JP', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    document.getElementById('clock').innerText = timeStr;
    
    // è‡ªå‹•ä¿å­˜æ—¥æ™‚ã‚’æ›´æ–°
    const saveStatusEl = document.getElementById('saveStatus');
    if(saveStatusEl) {
      saveStatusEl.textContent = `è‡ªå‹•ä¿å­˜ ${timeStr}`;
    }
  }
  
  // â˜…ç¯„å›²é¸æŠè»¢é€å¯¾å¿œï¼šselectionchangeã§å¸¸ã«æœ€å¾Œã®é¸æŠæ–‡å­—åˆ—ã‚’ä¿æŒâ˜…
  let lastSelectedText = null; // æœ€å¾Œã®é¸æŠæ–‡å­—åˆ—ã‚’ä¿æŒ
  let lastSelectedCard = null; // æœ€å¾Œã®é¸æŠã‚«ãƒ¼ãƒ‰ã‚’ä¿æŒ
  
  // â˜…ä¿®æ­£ï¼šselectionchangeã‚¤ãƒ™ãƒ³ãƒˆã§å¸¸ã«é¸æŠç¯„å›²ã‚’æ›´æ–°ï¼ˆé¸æŠãŒç©ºã«ãªã£ãŸç¬é–“ã«å¿…ãšã‚¯ãƒªã‚¢ï¼‰â˜…
  document.addEventListener('selectionchange', () => {
    const selection = window.getSelection();
    try {
      // â˜…ä¿®æ­£ï¼šé¸æŠãŒç©ºã«ãªã£ãŸç¬é–“ã«å¿…ãšã‚¯ãƒªã‚¢ï¼ˆèª¤çˆ†é˜²æ­¢ï¼‰â˜…
      if(selection.rangeCount === 0 || selection.toString().trim().length === 0) {
        lastSelectedText = null;
        lastSelectedCard = null;
        return;
      }
      
      // é¸æŠãŒã‚ã‚‹å ´åˆã®ã¿ä¿æŒ
      const range = selection.getRangeAt(0);
      const selectedText = selection.toString().trim();
      if(selectedText && selectedText.length > 0) {
        lastSelectedText = selectedText;
        lastSelectedCard = range.commonAncestorContainer.nodeType === 3 
          ? range.commonAncestorContainer.parentElement.closest('.turn-group')
          : range.commonAncestorContainer.closest('.turn-group');
      } else {
        // é¸æŠãŒç©ºã®å ´åˆã¯ä¿æŒã—ãªã„ï¼ˆèª¤çˆ†é˜²æ­¢ï¼‰
        lastSelectedText = null;
        lastSelectedCard = null;
      }
    } catch(e) {
      // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ä¿æŒã—ãªã„
      lastSelectedText = null;
      lastSelectedCard = null;
    }
  });
  
  // â˜…ç¯„å›²é¸æŠè»¢é€å¯¾å¿œï¼šã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé¸æŠï¼ˆé€šå¸¸ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠéƒ¨åˆ†ã‚’è»¢é€ï¼‰â˜…
  function handleAgentClick(agent, event) {
    // â˜…ä¿®æ­£ï¼šä¿æŒã•ã‚ŒãŸé¸æŠç¯„å›²ã‚’ä½¿ç”¨ï¼ˆselectionchangeã§å¸¸ã«æ›´æ–°æ¸ˆã¿ï¼‰â˜…
    if(lastSelectedText && lastSelectedText.length > 0) {
      // é¸æŠç¯„å›²ãŒã‚ã‚‹å ´åˆï¼šè»¢é€å‡¦ç†
      event.preventDefault();
      event.stopPropagation();
      
      // ä¿æŒã•ã‚ŒãŸé¸æŠç¯„å›²ã‚’ä½¿ç”¨
      const selectedText = lastSelectedText;
      const card = lastSelectedCard;
      
      let sourceTitle = 'é¸æŠç¯„å›²';
      if(card) {
        const header = card.querySelector('.question-part');
        if(header) {
          sourceTitle = header.textContent.split('(')[0].trim();
        }
      }
      
      // â˜…ä¿®æ­£ï¼šé¸æŠè»¢é€ãƒ¢ãƒ¼ãƒ‰ã§ã€Œå…¨å“¡ã€ã‚’æŠ¼ã™ã¨è½ã¡ã‚‹å¯èƒ½æ€§ã‚’æ½°ã™â˜…
      const now = new Date();
      const timeStr = now.toLocaleString('ja-JP', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
      
      // agent==="all"ã®å ´åˆã¯ã€yui/gemini/rexã®3ã‚«ãƒ©ãƒ ãã‚Œãã‚Œã«è»¢é€ã‚«ãƒ¼ãƒ‰ã‚’è¤‡è£½
      const targetAgents = (agent === 'all') ? ['yui', 'gemini', 'rex'] : [agent];
      
      targetAgents.forEach(targetAgent => {
        const targetDiv = document.getElementById('hist-'+targetAgent);
        if(!targetDiv) return; // å¿µã®ãŸã‚nullãƒã‚§ãƒƒã‚¯
        
        const transferCardId = 'card-selection-' + Date.now() + '-' + targetAgent;
        
        const transferCard = `
          <div class="turn-group" id="${transferCardId}">
            <div class="question-part">
              <div><strong>è»¢é€å…ƒ: ${sourceTitle}</strong> (${timeStr})</div>
              <div>
                <span class="card-delete" onclick="deleteCard('${transferCardId}')" title="å‰Šé™¤">Ã—</span>
              </div>
            </div>
            <div class="answer-part">
              ${selectedText.replace(/\n/g, '<br>')}
            </div>
            <div class="card-actions">
              <button class="card-action-btn" onclick="screenshotCard('${transferCardId}')">ğŸ“· ã‚¹ã‚¯ã‚·ãƒ§</button>
              <button class="card-action-btn" onclick="clearCardContent('${transferCardId}')">ğŸ§¹ å†…å®¹ã‚¯ãƒªã‚¢</button>
              <button class="card-action-btn" onclick="showTransferPanel('${transferCardId}')">è»¢é€</button>
            </div>
            <div id="transfer-panel-${transferCardId}" style="display:none; padding:10px; background:#f9fafb; border-top:1px solid #eee;">
              <textarea id="transfer-edit-${transferCardId}" style="width:100%; min-height:60px; margin-bottom:10px; padding:8px; border:1px solid #ccc; border-radius:4px;">${selectedText}</textarea>
              <div style="display:flex; gap:10px;">
                <button class="card-action-btn btn-yui" onclick="executeTransfer('${transferCardId}', 'yui')">To Yui</button>
                <button class="card-action-btn btn-gemini" onclick="executeTransfer('${transferCardId}', 'gemini')">To Gemini</button>
                <button class="card-action-btn btn-rex" onclick="executeTransfer('${transferCardId}', 'rex')">To Rex</button>
                <button class="card-action-btn" onclick="hideTransferPanel('${transferCardId}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              </div>
            </div>
          </div>
        `;
        
        targetDiv.insertAdjacentHTML('afterbegin', transferCard);
        limitHistory(targetAgent);
      });
      
      // é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢
      const selection = window.getSelection();
      if(selection.rangeCount > 0) {
        selection.removeAllRanges();
      }
      lastSelectedText = null; // ä¿æŒã—ãŸé¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢ï¼ˆèª¤çˆ†é˜²æ­¢ï¼‰
      lastSelectedCard = null;
      return;
    }
    
    // é¸æŠç¯„å›²ãŒãªã„å ´åˆï¼šä¿æŒã‚’ã‚¯ãƒªã‚¢
    lastSelectedText = null;
    lastSelectedCard = null;
    
    // é¸æŠç¯„å›²ãŒãªã„å ´åˆï¼šé€šå¸¸ã®ãƒˆã‚°ãƒ«å‡¦ç†
    toggleAgent(agent);
  }
  
  // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé¸æŠï¼ˆç©ºã‚»ãƒƒãƒˆï¼å…¨å“¡ã«çµ±ä¸€ï¼‰
  function toggleAgent(agent) {
    if(agent==='all') {
      selectedAgents = new Set(); // ç©ºã‚»ãƒƒãƒˆ = å…¨å“¡é¸æŠçŠ¶æ…‹
    } else {
      if(selectedAgents.has(agent)) {
        selectedAgents.delete(agent);
      } else {
        selectedAgents.add(agent);
      }
      if(selectedAgents.size === 3){
        selectedAgents = new Set(); // å…¨å“¡é¸æŠçŠ¶æ…‹ = ç©ºã‚»ãƒƒãƒˆ
      }
    }
    updateButtonsVisual();
  }
  
  function updateButtonsVisual() {
    const agents = ['yui', 'gemini', 'rex'];
    const isAll = (selectedAgents.size === 0);
    const all = document.getElementById('btn-all');
    if(isAll) all.classList.add('active');
    else all.classList.remove('active');
    
    agents.forEach(a => {
      const btn = document.getElementById('btn-'+a);
      if(selectedAgents.has(a)) btn.classList.add('active');
      else btn.classList.remove('active');
    });
  }
  
  // è³ªå•ãƒœã‚¿ãƒ³ï¼ˆé€šå¸¸é€ä¿¡ï¼‰
  function startQuestion() {
    const theme = document.getElementById('themeInput').value;
    const title = document.getElementById('topicTitle').value;
    
    if(!theme && imagesBase64.length===0) return showCustomAlert("å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    
    const targets = selectedAgents.size === 0 ? ['yui', 'gemini', 'rex'] : Array.from(selectedAgents);
    if(targets.length===0) return showCustomAlert("AIã‚’é¸æŠã—ã¦ãã ã•ã„");
    
    // â˜…ä¿®æ­£ï¼šãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒãƒ¼ã®å®Œäº†åˆ¤å®šã‚’å‹•çš„ã«ï¼ˆé€ä¿¡æ•°ã«å¿œã˜ã¦ï¼‰â˜…
    loadingPending = targets.length;
    document.getElementById('loadingBar').style.display = 'block';
    const speaker = document.getElementById('speakerSelect').value;
    const finalTheme = (speaker !== "User") ? `ã€${speaker}ã‹ã‚‰ã®ç™ºè¨€ã€‘\n${theme}` : theme;
    
    google.script.run.logUserAction(sessionId, theme, title);
    
    targets.forEach(agent => {
      sendToAI(agent, finalTheme, title, speaker, theme);
    });
    
    document.getElementById('themeInput').value = "";
    imagesBase64 = [];
    document.getElementById('previewArea').innerHTML = "";
  }
  
  // Discussãƒœã‚¿ãƒ³ï¼ˆ3AIã§è‡ªå‹•ä¼šè©±ï¼‰
  function startDiscuss() {
    const theme = document.getElementById('themeInput').value;
    const title = document.getElementById('topicTitle').value;
    
    if(!theme && imagesBase64.length===0) return showCustomAlert("å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    
    // â˜…ä¿®æ­£ï¼šãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒãƒ¼ã®å®Œäº†åˆ¤å®šã‚’å‹•çš„ã«ï¼ˆé€ä¿¡æ•°ã«å¿œã˜ã¦ï¼‰â˜…
    const discussAgents = ['yui', 'gemini', 'rex'];
    loadingPending = discussAgents.length;
    document.getElementById('loadingBar').style.display = 'block';
    const speaker = document.getElementById('speakerSelect').value;
    
    // â˜…ä¿®æ­£ï¼šDiscusså°‚ç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆ3AIä¼šè©±ã‚’å›ã™ï¼‰â˜…
    const discussPrompt = `ã€Discussãƒ¢ãƒ¼ãƒ‰ï¼š3AIã§è‡ªå‹•ä¼šè©±ã‚’é–‹å§‹ã—ã¾ã™ã€‘\n\n${theme}`;
    const finalTheme = (speaker !== "User") ? `ã€${speaker}ã‹ã‚‰ã®ç™ºè¨€ã€‘\n${discussPrompt}` : discussPrompt;
    
    google.script.run.logUserAction(sessionId, theme, title);
    
    // â˜…ä¿®æ­£ï¼š3AIå…¨å“¡ã«é€ä¿¡ï¼ˆDiscusså°‚ç”¨ã®æµã‚Œï¼‰â˜…
    discussAgents.forEach(agent => {
      sendToAI(agent, finalTheme, title || 'Discussä¼šè©±', speaker, theme);
    });
    
    document.getElementById('themeInput').value = "";
    imagesBase64 = [];
    document.getElementById('previewArea').innerHTML = "";
  }
  
  // AIã¸é€ä¿¡å‡¦ç†
  function sendToAI(agent, finalTheme, title, speaker, originalTheme) {
    const div = document.getElementById('hist-'+agent);
    const cardId = 'card-' + Date.now() + '-' + (cardCounter++);
    
    // è³ªå•ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ 
    const questionCard = createQuestionCard(cardId, speaker, title || originalTheme.substring(0, 50), originalTheme, imagesBase64);
    div.insertAdjacentHTML('afterbegin', questionCard);
    
    // â˜…ä¿®æ­£ï¼šæŠ˜ã‚ŠãŸãŸã¿ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¤å®šâ˜…
    checkCardCollapse(cardId);
    
    // å±¥æ­´è‚¥å¤§å¯¾ç­–
    limitHistory(agent);
    
    // AIã¸é€ä¿¡
    google.script.run
      .withSuccessHandler(res => {
        const answerCardId = 'card-answer-' + cardId;
        answerCardCount[agent]++; // å›ç­”ã‚«ãƒ¼ãƒ‰ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’å¢—ã‚„ã™
        const isFirstAnswer = (answerCardCount[agent] === 1);
        const answerCard = createAnswerCard(answerCardId, agent, res.response, res.status === 'success', isFirstAnswer);
        const questionCardEl = document.getElementById(cardId);
        if(questionCardEl) {
          questionCardEl.insertAdjacentHTML('afterend', answerCard);
          // â˜…ä¿®æ­£ï¼šæŠ˜ã‚ŠãŸãŸã¿ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¤å®šâ˜…
          checkCardCollapse(answerCardId);
        }
        limitHistory(agent);
        // â˜…ä¿®æ­£ï¼šå±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆä¼šè©±ã®ç¶™ç¶šæ€§ã®ãŸã‚ï¼‰â˜…
        if(!historyData.perAIHistory[agent]) historyData.perAIHistory[agent] = [];
        historyData.perAIHistory[agent].push(
          { role: 'user', content: finalTheme },
          { role: 'assistant', content: res.response }
        );
        saveHistoryToStorage();
        showAutoSave();
        checkDone();
      })
      .withFailureHandler(e => {
        const answerCardId = 'card-answer-' + cardId;
        answerCardCount[agent]++;
        const isFirstAnswer = (answerCardCount[agent] === 1);
        // â˜…ä¿®æ­£ï¼šGeminiã‚¨ãƒ©ãƒ¼ã‚‚ç¢ºå®Ÿã«è¡¨ç¤ºï¼ˆæ²ˆé»™ç¦æ­¢ã€HTTP 429å¯¾å¿œï¼‰â˜…
        // â˜…ç‰ˆæƒ…å ±ä¸€å…ƒåŒ–ï¼šã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ«å°¾ã«ç‰ˆæƒ…å ±ã‚’ä»˜ä¸â˜…
        const versionInfo = ` (${APP_VERSION} / b=${currentBuildId})`;
        let errorMsg = "System Error: " + (e.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ') + versionInfo;
        if(agent === 'gemini') {
          let errorDetail = e.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
          let shortMsg = 'âš ï¸ **Gemini Error**';
          
          // HTTP 429ï¼ˆQuotaï¼‰ã®å ´åˆã¯çŸ­ã„æ—¥æœ¬èªã«æ•´å½¢
          if(errorDetail.includes('429') || errorDetail.includes('Quota') || errorDetail.includes('quota')) {
            shortMsg = 'âš ï¸ **Geminiåˆ©ç”¨ä¸Šé™ã«é”ã—ã¾ã—ãŸ**\n\nAPIã®åˆ©ç”¨ä¸Šé™ï¼ˆã‚¯ã‚ªãƒ¼ã‚¿ï¼‰ã«é”ã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚' + versionInfo;
          } else {
            shortMsg = `âš ï¸ **Gemini Error**: ${errorDetail}\n\nã€ç¢ºèªäº‹é …ã€‘\n1. GEMINI_API_KEY ã¾ãŸã¯ GOOGLE_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹\n2. APIã‚­ãƒ¼ã«æ¨©é™ãŒã‚ã‚‹ã‹\n3. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãŒæ­£å¸¸ã‹` + versionInfo;
          }
          errorMsg = shortMsg;
        }
        const answerCard = createAnswerCard(answerCardId, agent, errorMsg, false, isFirstAnswer);
        const questionCardEl = document.getElementById(cardId);
        if(questionCardEl) {
          questionCardEl.insertAdjacentHTML('afterend', answerCard);
          // â˜…ä¿®æ­£ï¼šæŠ˜ã‚ŠãŸãŸã¿ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¤å®šâ˜…
          checkCardCollapse(answerCardId);
        }
        // â˜…ä¿®æ­£ï¼šå±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆä¼šè©±ã®ç¶™ç¶šæ€§ã®ãŸã‚ï¼‰â˜…
        if(!historyData.perAIHistory[agent]) historyData.perAIHistory[agent] = [];
        historyData.perAIHistory[agent].push(
          { role: 'user', content: finalTheme }
        );
        checkDone();
      })
      .runRelay(finalTheme, title, imagesBase64, agent, historyData, sessionId);
  }
  
  // è³ªå•ã‚«ãƒ¼ãƒ‰ä½œæˆ
  function createQuestionCard(cardId, speaker, title, content, images) {
    const now = new Date();
    const timeStr = now.toLocaleString('ja-JP', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    
    let imageHtml = '';
    if(images && images.length > 0) {
      images.forEach(img => {
        imageHtml += `<img src="${img}" class="card-image" alt="æ·»ä»˜ç”»åƒ">`;
      });
    }
    
    // â˜…ä¿®æ­£ï¼š2è¡Œè¶…ã®ã¨ãã ã‘æŠ˜ã‚ŠãŸãŸã¿ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆãƒ¬ãƒ³ãƒ€å¾Œã«åˆ¤å®šï¼‰â˜…
    return `
      <div class="turn-group" id="${cardId}">
        <div class="question-part">
          <div><strong>${speaker}</strong>: ${title} (${timeStr})</div>
          <div>
            <span class="card-toggle" id="toggle-${cardId}" style="display:none;" onclick="toggleCard('${cardId}')" title="æŠ˜ã‚ŠãŸãŸã¿">[æŠ˜ã‚ŠãŸãŸã‚€]</span>
            <span class="card-delete" onclick="deleteCard('${cardId}')" title="å‰Šé™¤">Ã—</span>
          </div>
        </div>
        <div class="answer-part" id="content-${cardId}">
          ${content.replace(/\n/g, '<br>')}
          ${imageHtml}
        </div>
        <div class="card-actions">
          <button class="card-action-btn" onclick="screenshotCard('${cardId}')">ğŸ“· ã‚¹ã‚¯ã‚·ãƒ§</button>
          <button class="card-action-btn" onclick="clearCardContent('${cardId}')">ğŸ§¹ å†…å®¹ã‚¯ãƒªã‚¢</button>
          <button class="card-action-btn" onclick="showTransferPanel('${cardId}')">è»¢é€</button>
        </div>
        <div id="transfer-panel-${cardId}" style="display:none; padding:10px; background:#f9fafb; border-top:1px solid #eee;">
          <textarea id="transfer-edit-${cardId}" style="width:100%; min-height:60px; margin-bottom:10px; padding:8px; border:1px solid #ccc; border-radius:4px;">${content.replace(/\n/g, '\n')}</textarea>
          <div style="display:flex; gap:10px;">
            <button class="card-action-btn btn-yui" onclick="executeTransfer('${cardId}', 'yui')">To Yui</button>
            <button class="card-action-btn btn-gemini" onclick="executeTransfer('${cardId}', 'gemini')">To Gemini</button>
            <button class="card-action-btn btn-rex" onclick="executeTransfer('${cardId}', 'rex')">To Rex</button>
            <button class="card-action-btn" onclick="hideTransferPanel('${cardId}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
      </div>
    `;
  }
  
  // å›ç­”ã‚«ãƒ¼ãƒ‰ä½œæˆ
  // â˜…ç‰ˆæƒ…å ±ä¸€å…ƒåŒ–ï¼šAIè¿”ä¿¡ã‚«ãƒ¼ãƒ‰ã®ãƒ˜ãƒƒãƒ€è¡Œã«ï½œvX.Y.Zã‚’è¿½åŠ â˜…
  function createAnswerCard(cardId, agent, content, isSuccess, isFirstAnswer) {
    const now = new Date();
    const timeStr = now.toLocaleString('ja-JP', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    const agentName = agent === 'yui' ? 'Yui' : agent === 'gemini' ? 'Gemini' : 'Rex';
    // â˜…ç‰ˆæƒ…å ±ä¸€å…ƒåŒ–ï¼šãƒ˜ãƒƒãƒ€è¡Œã«ï½œvX.Y.Zã‚’è¿½åŠ ï¼ˆã“ã‚ŒãŒä¸€ç•ªåŠ¹ãï¼‰â˜…
    const versionTag = `ï½œ${APP_VERSION}`;
    
    // â˜…æ–°æ©Ÿèƒ½ï¼šAIè¿”ç­”ã‹ã‚‰ã€Œ#### è¿½åŠ /å¤‰æ›´ç‚¹ã€ãƒ–ãƒ­ãƒƒã‚¯ã ã‘æŠ½å‡ºã—ã¦ã‚«ãƒ¼ãƒ‰ã«è¡¨ç¤ºâ˜…
    let displayContent = content;
    try {
      // ã€Œ#### è¿½åŠ /å¤‰æ›´ç‚¹ã€ãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠ½å‡º
      const changePointMatch = content.match(/####\s*è¿½åŠ [\/ï¼]å¤‰æ›´ç‚¹[\s\S]*?(?=####|###|$)/i);
      if (changePointMatch && changePointMatch[0]) {
        // æŠ½å‡ºã§ããŸå ´åˆï¼šãã®éƒ¨åˆ†ã ã‘ã‚’è¡¨ç¤º
        displayContent = changePointMatch[0]
          .replace(/####\s*è¿½åŠ [\/ï¼]å¤‰æ›´ç‚¹\s*/i, '#### è¿½åŠ /å¤‰æ›´ç‚¹\n') // çµ±ä¸€
          .replace(/\n{3,}/g, '\n\n') // é€£ç¶šæ”¹è¡Œã‚’èª¿æ•´
          .trim();
      } else {
        // â˜…è¿½åŠ æ”¹å–„ï¼šè¦‹å‡ºã—ãŒå–ã‚Œãªã„å ´åˆã¯å…ˆé ­400-600æ–‡å­—ã ã‘ã‚’è¦ç´„æ¬„ã«å‡ºã™ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯â˜…
        if(content.length > 400) {
          displayContent = content.substring(0, 600);
          if(content.length > 600) {
            displayContent += '...';
          }
        }
      }
      // æŠ½å‡ºã§ããªã„å ´åˆã¯å…¨ä½“è¡¨ç¤ºï¼ˆãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ•ï¼‰
    } catch (e) {
      console.warn("è¿½åŠ /å¤‰æ›´ç‚¹æŠ½å‡ºã‚¨ãƒ©ãƒ¼: " + e.toString());
      // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å…¨ä½“è¡¨ç¤ºï¼ˆãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ•ï¼‰
    }
    
    // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¤œå‡ºã—ã¦åˆ¥ç”»é¢ã¸é€ƒãŒã™ï¼ˆdisplayContentã«å¯¾ã—ã¦å‡¦ç†ï¼‰
    let processedContent = displayContent;
    const codeBlocks = [];
    const codePattern = /```(\w+)?\n([\s\S]*?)```/g;
    let match;
    let codeIndex = 0;
    
    while((match = codePattern.exec(displayContent)) !== null) {
      const codeId = `code-${cardId}-${codeIndex++}`;
      codeBlocks.push({ id: codeId, lang: match[1] || '', code: match[2] });
      processedContent = processedContent.replace(match[0], `<a href="#" onclick="showCode('${codeId}'); return false;" style="color:#3b82f6; text-decoration:underline;">[ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º]</a>`);
    }
    
    // â˜…ä¿®æ­£ï¼šã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¾æ›¸å½¢å¼ã§ä¿å­˜ï¼ˆshowCodeã§ç¢ºå®Ÿã«å–å¾—ã§ãã‚‹ã‚ˆã†ã«ï¼‰â˜…
    if(codeBlocks.length > 0) {
      window.__CODE_MAP = window.__CODE_MAP || {};
      codeBlocks.forEach(cb => window.__CODE_MAP[cb.id] = cb);
    }
    
    // Markdownæ•´å½¢ï¼ˆå¤ªå­—ã¨æ”¹è¡Œã®ã¿ï¼‰
    processedContent = processedContent.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // â˜…ä¿®æ­£ï¼šæŠ˜ã‚ŠãŸãŸã¿åˆ¤å®šï¼ˆ2è¡Œè¶…ã®ã¨ãã ã‘æŠ˜ã‚ŠãŸãŸã¿ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã€æŠ˜ã‚ŠãŸãŸã¿æ™‚ã¯å…ˆé ­2è¡Œã‚’è¡¨ç¤ºï¼‰â˜…
    const isLong = processedContent.length > 200;
    const shouldCollapse = !isFirstAnswer && isLong;
    
    return `
      <div class="turn-group ${shouldCollapse ? 'card-collapsed' : ''}" id="${cardId}">
        <div class="question-part" style="background:#f9fafb;">
          <div><strong>${agentName}</strong> (${timeStr}) ${versionTag}</div>
          <div>
            <span class="card-toggle" id="toggle-${cardId}" style="display:none;" onclick="toggleCard('${cardId}')" title="æŠ˜ã‚ŠãŸãŸã¿">[${shouldCollapse ? 'å±•é–‹' : 'æŠ˜ã‚ŠãŸãŸã‚€'}]</span>
            <span class="card-delete" onclick="deleteCard('${cardId}')" title="å‰Šé™¤">Ã—</span>
          </div>
        </div>
        <div class="answer-part" id="content-${cardId}">
          ${processedContent}
        </div>
        <div class="card-actions">
          <button class="card-action-btn" onclick="screenshotCard('${cardId}')">ğŸ“· ã‚¹ã‚¯ã‚·ãƒ§</button>
          <button class="card-action-btn" onclick="clearCardContent('${cardId}')">ğŸ§¹ å†…å®¹ã‚¯ãƒªã‚¢</button>
          <button class="card-action-btn" onclick="showTransferPanel('${cardId}')">è»¢é€</button>
        </div>
        <div id="transfer-panel-${cardId}" style="display:none; padding:10px; background:#f9fafb; border-top:1px solid #eee;">
          <textarea id="transfer-edit-${cardId}" style="width:100%; min-height:60px; margin-bottom:10px; padding:8px; border:1px solid #ccc; border-radius:4px;">${content.replace(/\n/g, '\n')}</textarea>
          <div style="display:flex; gap:10px;">
            <button class="card-action-btn btn-yui" onclick="executeTransfer('${cardId}', 'yui')">To Yui</button>
            <button class="card-action-btn btn-gemini" onclick="executeTransfer('${cardId}', 'gemini')">To Gemini</button>
            <button class="card-action-btn btn-rex" onclick="executeTransfer('${cardId}', 'rex')">To Rex</button>
            <button class="card-action-btn" onclick="hideTransferPanel('${cardId}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
      </div>
    `;
  }
  
  // â˜…ä¿®æ­£ï¼šæŠ˜ã‚ŠãŸãŸã¿ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¤å®šï¼ˆ2è¡Œè¶…ã®ã¨ãã ã‘è¡¨ç¤ºï¼‰â˜…
  // â˜…æœ€å„ªå…ˆãƒã‚°ä¿®æ­£ï¼šcard-collapsedçŠ¶æ…‹ã®ã‚«ãƒ¼ãƒ‰ã¯æ¸¬å®šã›ãšã«toggleã‚’è¡¨ç¤ºâ˜…
  function checkCardCollapse(cardId) {
    const card = document.getElementById(cardId);
    if(!card) return;
    
    const answerPart = card.querySelector('.answer-part');
    if(!answerPart) return;
    
    const toggle = card.querySelector('.card-toggle');
    if(!toggle) return;
    
    // â˜…æœ€å„ªå…ˆãƒã‚°ä¿®æ­£ï¼šcard-collapsedã‚¯ãƒ©ã‚¹ãŒã‚ã‚‹å ´åˆã¯ã€æ¸¬å®šã›ãšã«toggleã‚’è¡¨ç¤ºâ˜…
    // shouldCollapse === true ã®åˆ¤å®šã¯æ—¢ã«createAnswerCard()ã§è¡Œã‚ã‚Œã¦ã„ã‚‹ãŸã‚ã€æ¸¬å®šã¯ä¸è¦
    if(card.classList.contains('card-collapsed')) {
      toggle.style.display = 'inline-block';
      return;
    }
    
    // card-collapsedã‚¯ãƒ©ã‚¹ãŒãªã„å ´åˆã®ã¿ã€scrollHeightã§æ¸¬å®š
    const lineHeight = parseFloat(window.getComputedStyle(answerPart).lineHeight);
    const maxHeight = lineHeight * 2.5; // 2.5è¡Œåˆ†ã®é«˜ã•
    
    if(answerPart.scrollHeight > maxHeight) {
      // 2è¡Œè¶…ã®å ´åˆï¼šæŠ˜ã‚ŠãŸãŸã¿ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      toggle.style.display = 'inline-block';
    } else {
      // 2è¡Œä»¥ä¸‹ã®å ´åˆï¼šæŠ˜ã‚ŠãŸãŸã¿ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
      toggle.style.display = 'none';
      // æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã‚’è§£é™¤
      card.classList.remove('card-collapsed');
    }
  }
  
  // ã‚«ãƒ¼ãƒ‰æŠ˜ã‚ŠãŸãŸã¿
  function toggleCard(cardId) {
    const card = document.getElementById(cardId);
    if(card) {
      card.classList.toggle('card-collapsed');
      const toggle = card.querySelector('.card-toggle');
      if(toggle) {
        toggle.textContent = card.classList.contains('card-collapsed') ? '[å±•é–‹]' : '[æŠ˜ã‚ŠãŸãŸã‚€]';
      }
    }
  }
  
  // ã‚«ãƒ¼ãƒ‰å‰Šé™¤
  function deleteCard(cardId) {
    const card = document.getElementById(cardId);
    if(card) {
      card.remove();
      saveHistoryToStorage();
    }
  }
  
  // ã‚«ãƒ¼ãƒ‰å†…å®¹ã‚¯ãƒªã‚¢
  function clearCardContent(cardId) {
    const card = document.getElementById(cardId);
    if(card) {
      const body = card.querySelector('.answer-part');
      if(body) {
        body.innerHTML = '<em>ï¼ˆå†…å®¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼‰</em>';
      }
    }
  }
  
  // â˜…ä¿®æ­£ï¼šã‚«ãƒ¼ãƒ‰è»¢é€ãƒ‘ãƒãƒ«è¡¨ç¤ºï¼ˆè»¢é€å‰ã«ç·¨é›†å¯èƒ½ï¼‰â˜…
  function showTransferPanel(cardId) {
    const panel = document.getElementById('transfer-panel-' + cardId);
    if(!panel) return;
    
    const card = document.getElementById(cardId);
    if(!card) return;
    
    const body = card.querySelector('.answer-part');
    if(!body) return;
    
    const content = body.textContent || body.innerText;
    const textarea = document.getElementById('transfer-edit-' + cardId);
    if(textarea) {
      textarea.value = content;
    }
    
    panel.style.display = 'block';
  }
  
  // â˜…ä¿®æ­£ï¼šã‚«ãƒ¼ãƒ‰è»¢é€ãƒ‘ãƒãƒ«éè¡¨ç¤ºâ˜…
  function hideTransferPanel(cardId) {
    const panel = document.getElementById('transfer-panel-' + cardId);
    if(panel) {
      panel.style.display = 'none';
    }
  }
  
  // â˜…ä¿®æ­£ï¼šã‚«ãƒ¼ãƒ‰è»¢é€å®Ÿè¡Œï¼ˆç·¨é›†å†…å®¹ã‚’AIã¸é€ä¿¡ï¼‰â˜…
  function executeTransfer(cardId, targetAgent) {
    const card = document.getElementById(cardId);
    if(!card) return;
    
    const textarea = document.getElementById('transfer-edit-' + cardId);
    if(!textarea) return;
    
    const editedContent = textarea.value.trim();
    if(!editedContent) {
      showCustomAlert('è»¢é€å†…å®¹ãŒç©ºã§ã™');
      return;
    }
    
    const header = card.querySelector('.question-part');
    const title = header ? header.textContent.split('(')[0].trim() : 'è»¢é€';
    
    // è»¢é€å…ƒæƒ…å ±ã‚’å–å¾—
    let sourceAgentName = 'è»¢é€å…ƒ';
    // ã‚«ãƒ¼ãƒ‰ãŒã©ã®ã‚«ãƒ©ãƒ ã«ã‚ã‚‹ã‹åˆ¤å®š
    const histYui = document.getElementById('hist-yui');
    const histGemini = document.getElementById('hist-gemini');
    const histRex = document.getElementById('hist-rex');
    if(histYui && histYui.contains(card)) sourceAgentName = 'Yui';
    else if(histGemini && histGemini.contains(card)) sourceAgentName = 'Gemini';
    else if(histRex && histRex.contains(card)) sourceAgentName = 'Rex';
    
    // â˜…ä¿®æ­£ï¼šè»¢é€ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹â˜…
    hideTransferPanel(cardId);
    
    // â˜…ä¿®æ­£ï¼šç·¨é›†å†…å®¹ã‚’AIã¸é€ä¿¡ï¼ˆcallAIã‚’å®Ÿè¡Œï¼‰â˜…
    // â˜…ä¿®æ­£ï¼šãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒãƒ¼ã®å®Œäº†åˆ¤å®šã‚’å‹•çš„ã«ï¼ˆé€ä¿¡æ•°ã«å¿œã˜ã¦ï¼‰â˜…
    loadingPending = 1;
    document.getElementById('loadingBar').style.display = 'block';
    const transferTitle = `ã€è»¢é€å…ƒã€‘${sourceAgentName} / ${title}`;
    const finalTheme = editedContent;
    
    // AIã¸é€ä¿¡ï¼ˆè³ªå•ã‚«ãƒ¼ãƒ‰â†’å›ç­”ã‚«ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã‚‹ï¼‰
    sendToAI(targetAgent, finalTheme, transferTitle, 'User', editedContent);
  }
  
  // â˜…ä¿®æ­£ï¼šã‚³ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆè¾æ›¸å½¢å¼ã§ç¢ºå®Ÿã«å–å¾—ï¼‰â˜…
  function showCode(codeId) {
    const cb = window.__CODE_MAP && window.__CODE_MAP[codeId];
    if(!cb) return;
    
    const codeContent = document.getElementById('codeContent');
    if(codeContent) {
      codeContent.textContent = cb.code;
      document.getElementById('codeModal').style.display = 'flex';
    }
  }
  
  // â˜…ã‚¹ã‚¯ã‚·ãƒ§æ©Ÿèƒ½ï¼šã‚«ãƒ¼ãƒ‰ã«ç”»åƒæ·»ä»˜å¯èƒ½ã«ã™ã‚‹â˜…
  function screenshotCard(cardId) {
    currentScreenshotCardId = cardId;
    document.getElementById('screenshotModal').style.display = 'flex';
  }
  
  async function handleCardImageSelect(e) {
    const cardId = currentScreenshotCardId;
    if(!cardId) return;
    
    const card = document.getElementById(cardId);
    if(!card) return;
    
    const body = card.querySelector('.answer-part');
    if(!body) return;
    
    const files = Array.from(e.target.files);
    if (files.length === 0) return;
    
    try {
      const normalizedImages = await normalizeSelectedFiles(files);
      
      for (const dataUrl of normalizedImages) {
        const img = document.createElement('img');
        img.src = dataUrl;
        img.className = 'card-image';
        img.style.maxWidth = '100%';
        img.style.margin = '10px 0';
        img.style.borderRadius = '8px';
        body.appendChild(img);
      }
    } catch (error) {
      console.error('ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
      showCustomAlert(`ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
    }
    
    closeScreenshotModal();
  }
  
  function closeScreenshotModal() {
    document.getElementById('screenshotModal').style.display = 'none';
    currentScreenshotCardId = null;
    document.getElementById('cardImageInput').value = '';
    document.getElementById('cardImagePreview').innerHTML = '';
  }
  
  // å±¥æ­´åˆ¶é™
  function limitHistory(agent) {
    const histDiv = document.getElementById('hist-'+agent);
    const cards = histDiv.querySelectorAll('.turn-group');
    if(cards.length > MAX_DISPLAY_PER_AI) {
      for(let i = cards.length - 1; i >= MAX_DISPLAY_PER_AI; i--) {
        cards[i].remove();
      }
    }
  }
  
  // â˜…ä¿®æ­£ï¼šãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒãƒ¼ã®å®Œäº†åˆ¤å®šã‚’å‹•çš„ã«ï¼ˆé€ä¿¡æ•°ã«å¿œã˜ã¦ï¼‰â˜…
  let loadingPending = 0;
  function checkDone() {
    loadingPending--;
    if(loadingPending <= 0) {
      document.getElementById('loadingBar').style.display = 'none';
      loadingPending = 0;
    }
  }
  
  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜
  // â˜…ç‰ˆæƒ…å ±ä¸€å…ƒåŒ–ï¼šappVersion/buildIdã‚’localStorageã«ä¿å­˜â˜…
  function saveHistoryToStorage() {
    ['yui', 'gemini', 'rex'].forEach(agent => {
      limitHistory(agent);
    });
    
    const data = {
      yui: document.getElementById('hist-yui').innerHTML,
      gemini: document.getElementById('hist-gemini').innerHTML,
      rex: document.getElementById('hist-rex').innerHTML,
      historyObj: historyData, 
      sessionId: sessionId,
      appVersion: APP_VERSION,
      buildId: currentBuildId
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }
  
  function showAutoSave() {
    updateClock();
  }
  
  function loadHistoryFromStorage() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if(saved) {
      const d = JSON.parse(saved);
      document.getElementById('hist-yui').innerHTML = d.yui || "";
      document.getElementById('hist-gemini').innerHTML = d.gemini || "";
      document.getElementById('hist-rex').innerHTML = d.rex || "";
      historyData = d.historyObj || { perAIHistory: { yui: [], gemini: [], rex: [] } };
      sessionId = d.sessionId || "SESS_" + Date.now();
      
      // å›ç­”ã‚«ãƒ¼ãƒ‰ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
      answerCardCount = { yui: 0, gemini: 0, rex: 0 };
      ['yui', 'gemini', 'rex'].forEach(agent => {
        const cards = document.getElementById('hist-'+agent).querySelectorAll('.turn-group');
        cards.forEach(card => {
          const header = card.querySelector('.question-part');
          if(header && !header.textContent.includes('è»¢é€å…ƒ')) {
            const agentName = agent === 'yui' ? 'Yui' : agent === 'gemini' ? 'Gemini' : 'Rex';
            if(header.textContent.includes(agentName)) {
              answerCardCount[agent]++;
            }
          }
        });
      });
      
      ['yui', 'gemini', 'rex'].forEach(agent => {
        limitHistory(agent);
      });
    }
  }
  
  // è¨­å®šä¿å­˜ãƒ»èª­ã¿è¾¼ã¿
  function saveSettings() {
    const settings = {
      theme: document.getElementById('themeSelect').value,
      fontSize: document.getElementById('fontSizeSelect').value
    };
    localStorage.setItem('ai_room_settings', JSON.stringify(settings));
  }
  
  function loadSettings() {
    const saved = localStorage.getItem('ai_room_settings');
    if(saved) {
      const settings = JSON.parse(saved);
      if(settings.theme) {
        document.getElementById('themeSelect').value = settings.theme;
        setTheme(settings.theme);
      }
      if(settings.fontSize) {
        document.getElementById('fontSizeSelect').value = settings.fontSize;
        const scale = parseFloat(settings.fontSize) / 100;
        document.documentElement.style.setProperty('--fontScale', scale.toString());
      }
    }
  }
  
  // ãƒ†ãƒ¼ãƒè¨­å®š
  function setTheme(themeName) {
    const theme = themes[themeName] || themes.standard;
    document.documentElement.style.setProperty('--bg-color', theme.bg);
    document.documentElement.style.setProperty('--card-bg', theme.card);
    document.documentElement.style.setProperty('--text-color', theme.text);
    document.documentElement.style.setProperty('--accent-color', theme.accent);
    saveSettings();
  }
  
  // æ–‡å­—ã‚µã‚¤ã‚ºè¨­å®š
  // â˜…ä¿®æ­£ï¼šæ–‡å­—ã‚µã‚¤ã‚ºè¨­å®šï¼ˆ--fontScaleã§çµ±ä¸€ï¼‰â˜…
  function setFontSize(size) {
    const scale = parseFloat(size) / 100; // 100% = 1.0, 110% = 1.1, ...
    document.documentElement.style.setProperty('--fontScale', scale.toString());
    saveSettings();
  }
  
  // â˜…æ–°æ©Ÿèƒ½ï¼šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ­£è¦åŒ–ï¼ˆPDFâ†’JPGã€HEICâ†’JPGã€é€šå¸¸ç”»åƒã®åœ§ç¸®ï¼‰â˜…
  async function normalizeSelectedFiles(files) {
    const normalizedImages = [];
    
    for (const file of files) {
      try {
        const fileType = file.type.toLowerCase();
        const fileName = file.name.toLowerCase();
        
        // PDFå‡¦ç†
        if (fileType === 'application/pdf' || fileName.endsWith('.pdf')) {
          const pdfImages = await convertPdfToImages(file);
          normalizedImages.push(...pdfImages);
        }
        // HEIC/HEIFå‡¦ç†
        else if (fileName.endsWith('.heic') || fileName.endsWith('.heif') || fileType.includes('heic') || fileType.includes('heif')) {
          const jpgImage = await convertHeicToJpg(file);
          if (jpgImage) {
            const compressed = await compressImage(jpgImage);
            normalizedImages.push(compressed);
          }
        }
        // é€šå¸¸ç”»åƒå‡¦ç†
        else {
          const compressed = await compressImageFile(file);
          if (compressed) {
            normalizedImages.push(compressed);
          }
        }
      } catch (error) {
        console.error('ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        showCustomAlert(`ãƒ•ã‚¡ã‚¤ãƒ« "${file.name}" ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
      }
    }
    
    return normalizedImages;
  }
  
  // PDFã‚’ç”»åƒã«å¤‰æ›ï¼ˆ1ãƒšãƒ¼ã‚¸ç›®ã®ã¿ï¼‰
  async function convertPdfToImages(file) {
    const images = [];
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    const maxPages = 1; // 1ãƒšãƒ¼ã‚¸ç›®ã®ã¿
    
    for (let pageNum = 1; pageNum <= maxPages; pageNum++) {
      const page = await pdf.getPage(pageNum);
      const viewport = page.getViewport({ scale: 2.0 }); // è§£åƒåº¦èª¿æ•´
      
      const canvas = document.createElement('canvas');
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      const context = canvas.getContext('2d');
      
      await page.render({ canvasContext: context, viewport: viewport }).promise;
      
      // Canvasã‚’JPGã«å¤‰æ›ã—ã¦åœ§ç¸®
      const jpgDataUrl = await compressCanvas(canvas);
      images.push(jpgDataUrl);
    }
    
    return images;
  }
  
  // HEIC/HEIFã‚’JPGã«å¤‰æ›
  async function convertHeicToJpg(file) {
    try {
      // heic2anyãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨
      const blob = await heic2any({
        blob: file,
        toType: 'image/jpeg',
        quality: 0.92
      });
      
      // heic2anyã¯é…åˆ—ã‚’è¿”ã™ã“ã¨ãŒã‚ã‚‹
      const resultBlob = Array.isArray(blob) ? blob[0] : blob;
      
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsDataURL(resultBlob);
      });
    } catch (error) {
      throw new Error(`HEICå¤‰æ›ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    }
  }
  
  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”»åƒã¨ã—ã¦åœ§ç¸®
  async function compressImageFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const img = new Image();
          img.onload = async () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const compressed = await compressCanvas(canvas);
            resolve(compressed);
          };
          img.onerror = reject;
          img.src = e.target.result;
        } catch (error) {
          reject(error);
        }
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }
  
  // ç”»åƒï¼ˆdataURLï¼‰ã‚’åœ§ç¸®
  async function compressImage(dataUrl) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = async () => {
        try {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          const compressed = await compressCanvas(canvas);
          resolve(compressed);
        } catch (error) {
          reject(error);
        }
      };
      img.onerror = reject;
      img.src = dataUrl;
    });
  }
  
  // Canvasã‚’åœ§ç¸®ï¼ˆBlobã‚µã‚¤ã‚º3.0MBä»¥ä¸‹ã«åã‚ã‚‹ãƒ»toBlobãƒ™ãƒ¼ã‚¹ã§å®Ÿãƒã‚¤ãƒˆåˆ¤å®šï¼‰
  async function compressCanvas(canvas) {
    const MAX_SIZE_MB = 3.0;
    const MAX_SIZE_BYTES = MAX_SIZE_MB * 1024 * 1024;
    const MAX_LONG_SIDE = 1600; // é•·è¾ºã®æœ€å¤§å€¤ï¼ˆUIè§£åƒæ„Ÿã‚’å£Šã•ãªã„ç¯„å›²ï¼‰
    
    let currentWidth = canvas.width;
    let currentHeight = canvas.height;
    let quality = 0.85;
    
    // é•·è¾ºã‚’1600pxã«ç¸®å°
    if (currentWidth > MAX_LONG_SIDE || currentHeight > MAX_LONG_SIDE) {
      const ratio = Math.min(MAX_LONG_SIDE / currentWidth, MAX_LONG_SIDE / currentHeight);
      currentWidth = Math.floor(currentWidth * ratio);
      currentHeight = Math.floor(currentHeight * ratio);
      
      const resizedCanvas = document.createElement('canvas');
      resizedCanvas.width = currentWidth;
      resizedCanvas.height = currentHeight;
      const ctx = resizedCanvas.getContext('2d');
      ctx.drawImage(canvas, 0, 0, currentWidth, currentHeight);
      canvas = resizedCanvas;
    }
    
    // å“è³ªã‚’æ®µéšçš„ã«ä¸‹ã’ãªãŒã‚‰åœ§ç¸®ï¼ˆtoBlobã§å®Ÿãƒã‚¤ãƒˆåˆ¤å®šï¼‰
    const qualitySteps = [0.85, 0.75, 0.65, 0.55, 0.45, 0.35];
    const sizeSteps = [1600, 1400, 1200, 1000, 800, 600]; // é•·è¾ºã®ç¸®å°ã‚¹ãƒ†ãƒƒãƒ—
    
    for (let step = 0; step < qualitySteps.length; step++) {
      quality = qualitySteps[step];
      
      // é•·è¾ºã‚’ã•ã‚‰ã«ç¸®å°ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
      if (step > 0 && (currentWidth > sizeSteps[step] || currentHeight > sizeSteps[step])) {
        const ratio = Math.min(sizeSteps[step] / currentWidth, sizeSteps[step] / currentHeight);
        currentWidth = Math.floor(currentWidth * ratio);
        currentHeight = Math.floor(currentHeight * ratio);
        
        const resizedCanvas = document.createElement('canvas');
        resizedCanvas.width = currentWidth;
        resizedCanvas.height = currentHeight;
        const ctx = resizedCanvas.getContext('2d');
        ctx.drawImage(canvas, 0, 0, currentWidth, currentHeight);
        canvas = resizedCanvas;
      }
      
      // toBlobã§å®Ÿãƒã‚¤ãƒˆã‚µã‚¤ã‚ºã‚’å–å¾—
      const blob = await new Promise((resolve) => {
        canvas.toBlob(resolve, 'image/jpeg', quality);
      });
      
      if (blob && blob.size <= MAX_SIZE_BYTES) {
        // å®Ÿãƒã‚¤ãƒˆã‚µã‚¤ã‚ºãŒ3MBä»¥ä¸‹ãªã‚‰ã€dataURLã«å¤‰æ›ã—ã¦è¿”ã™
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.readAsDataURL(blob);
        });
      }
    }
    
    // æœ€å¾Œã¾ã§åœ§ç¸®ã—ã¦ã‚‚å¤§ãã„å ´åˆã¯ã€æœ€ä½å“è³ªã§è¿”ã™
    const finalBlob = await new Promise((resolve) => {
      canvas.toBlob(resolve, 'image/jpeg', 0.3);
    });
    if (finalBlob) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.readAsDataURL(finalBlob);
      });
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    return canvas.toDataURL('image/jpeg', 0.3);
  }
  
  // ç”»åƒå‡¦ç†ï¼ˆæ–°æ©Ÿèƒ½å¯¾å¿œï¼‰
  async function handleFileSelect(e) {
    const files = Array.from(e.target.files);
    if (files.length === 0) return;
    
    try {
      const normalizedImages = await normalizeSelectedFiles(files);
      
      // æ­£è¦åŒ–ã•ã‚ŒãŸç”»åƒã‚’è¿½åŠ 
      for (const dataUrl of normalizedImages) {
        imagesBase64.push(dataUrl);
        let img = document.createElement('img');
        img.src = dataUrl; 
        img.style.height="50px"; 
        img.style.borderRadius="5px"; 
        img.style.border="1px solid #ccc";
        img.className = "card-image";
        document.getElementById('previewArea').appendChild(img);
      }
    } catch (error) {
      console.error('ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
      showCustomAlert(`ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
    }
    
    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠã§ãã‚‹ã‚ˆã†ã«ï¼‰
    e.target.value = '';
  }
  
  async function pasteFromClipboard() {
    try {
      const items = await navigator.clipboard.read();
      for (const item of items) {
        if (item.types.find(type => type.startsWith('image/'))) {
          const blob = await item.getType(item.types.find(type => type.startsWith('image/')));
          // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰å–å¾—ã—ãŸç”»åƒã‚‚åœ§ç¸®
          const compressed = await compressImageFile(new File([blob], 'clipboard.png', { type: blob.type }));
          if (compressed) {
            imagesBase64.push(compressed);
            let img = document.createElement('img'); 
            img.src = compressed; 
            img.style.height="50px"; 
            img.style.borderRadius="5px";
            img.className = "card-image";
            document.getElementById('previewArea').appendChild(img);
          }
          return;
        }
      }
      document.getElementById('themeInput').focus(); 
      document.execCommand('paste');
    } catch(e) { 
      document.getElementById('themeInput').focus(); 
      document.execCommand('paste'); 
    }
  }
  
  // ãƒªã‚»ãƒƒãƒˆ
  function resetInputArea() {
    document.getElementById('themeInput').value = "";
    document.getElementById('topicTitle').value = "";
    imagesBase64 = []; 
    document.getElementById('previewArea').innerHTML = "";
  }
  
  // â˜…ä¿®æ­£ï¼šä¼šè­°ãƒªã‚»ãƒƒãƒˆï¼ˆå…¥åŠ›ï¼‹ã‚«ãƒ©ãƒ å±¥æ­´ã‚‚ã‚¯ãƒªã‚¢ï¼‰â˜…
  function tryStartNewSession() {
    showCustomConfirm("å…¥åŠ›ä¸­ã®å†…å®¹ã¨ã‚«ãƒ©ãƒ å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n(ã‚·ãƒ¼ãƒˆä¿å­˜ãƒ­ã‚°ã¯ä¿æŒã•ã‚Œã¾ã™)", () => {
      resetInputArea();
      // â˜…ä¿®æ­£ï¼š3ã‚«ãƒ©ãƒ ã®è¡¨ç¤ºã‚«ãƒ¼ãƒ‰ã‚‚ã‚¯ãƒªã‚¢ï¼ˆUIçŠ¶æ…‹ã‚’åˆæœŸåŒ–ï¼‰â˜…
      document.getElementById('hist-yui').innerHTML = "";
      document.getElementById('hist-gemini').innerHTML = "";
      document.getElementById('hist-rex').innerHTML = "";
      // å›ç­”ã‚«ãƒ¼ãƒ‰ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚‚ãƒªã‚»ãƒƒãƒˆ
      answerCardCount = { yui: 0, gemini: 0, rex: 0 };
      // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚‚ã‚¯ãƒªã‚¢
      historyData = { perAIHistory: { yui: [], gemini: [], rex: [] } };
      // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚‚ã‚¯ãƒªã‚¢
      localStorage.removeItem(STORAGE_KEY);
    });
  }
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ç³»
  function openHistoryModal() {
    document.getElementById('historyModal').style.display = 'flex';
    google.script.run.withSuccessHandler(list => {
      const c = document.getElementById('logListContainer'); 
      c.innerHTML = "";
      if(list.length===0) {
        c.innerHTML = "<div style='padding:20px; color:#999;'>ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</div>";
      } else {
        list.forEach(l => {
          let d = document.createElement('div'); 
          d.className="log-item";
          d.innerHTML = `
            <div>
              <b>${l.time}</b> ${l.title}
            </div>
            <div>
              <span class="log-item-delete" onclick="deleteLogItem('${l.id}', event)">å‰Šé™¤</span>
            </div>
          `;
          d.onclick = (e) => {
            if(e.target.classList.contains('log-item-delete')) return;
            document.getElementById('historyModal').style.display='none'; 
            setTimeout(() => showCustomConfirm("ã“ã®ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\n(ç¾åœ¨ã®ç”»é¢ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™)", () => {
               google.script.run.withSuccessHandler(restoreSessionToUI).getSessionLogs(l.id);
            }), 100);
          };
          c.appendChild(d);
        });
      }
    }).getLogList();
  }
  
  // â˜…ä¿®æ­£ï¼šéå»ãƒ­ã‚°å‰Šé™¤ã®å®‰å®šåŒ–ï¼ˆå‰Šé™¤ä¸­ã¯ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–ã€å‰Šé™¤å¾Œã«ä¸€è¦§å†å–å¾—ï¼‰â˜…
  function deleteLogItem(sessionId, event) {
    event.stopPropagation();
    
    // â˜…ä¿®æ­£ï¼šå‰Šé™¤ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆé€£æ‰“é˜²æ­¢ï¼‰â˜…
    // <span>ã«disabled=trueã‚’ä»˜ã‘ã¦ã‚‚åŠ¹ã‹ãªã„ã®ã§ã€pointer-eventsåˆ¶å¾¡ã§äºŒé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢
    // ç„¡åŠ¹åŒ–ã¯ã€ŒOKæŠ¼ä¸‹å¾Œã€ã«ç§»å‹•ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã¯ä½•ã‚‚å¤‰ãˆãªã„ï¼‰
    const deleteBtn = event.target;
    const originalText = deleteBtn.textContent;
    
    showCustomConfirm("ã“ã®ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ", 
      () => {
        // OKæŠ¼ä¸‹å¾Œï¼šå‰Šé™¤ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        deleteBtn.textContent = 'å‰Šé™¤ä¸­...';
        deleteBtn.style.pointerEvents = 'none'; // ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹åŒ–
        deleteBtn.style.opacity = '0.5';
        deleteBtn.style.cursor = 'not-allowed';
        // â˜…ä¿®æ­£ï¼šå‰Šé™¤â†’ä¸€è¦§å†å–å¾—â†’å†æç”»ã‚’1æœ¬åŒ–â˜…
        google.script.run.withSuccessHandler(res => {
          if(res.success) {
            // æˆåŠŸæ™‚ï¼šãã®è¡Œã‚’å³åº§ã«å‰Šé™¤ï¼ˆè¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰
            const logItem = deleteBtn.closest('.log-item');
            if(logItem) {
              logItem.style.opacity = '0.5';
              logItem.style.transition = 'opacity 0.2s';
              setTimeout(() => {
                logItem.remove();
              }, 200);
            }
            
            // â˜…ä¿®æ­£ï¼šå‰Šé™¤å¾Œã«ä¸€è¦§ã‚’å†å–å¾—ã—ã¦å†æç”»ï¼ˆç¢ºå®Ÿã«åŒæœŸï¼‰â˜…
            google.script.run.withSuccessHandler(list => {
              const c = document.getElementById('logListContainer'); 
              c.innerHTML = "";
              if(list.length===0) {
                c.innerHTML = "<div style='padding:20px; color:#999;'>ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</div>";
              } else {
                list.forEach(l => {
                  let d = document.createElement('div'); 
                  d.className="log-item";
                  d.innerHTML = `
                    <div>
                      <b>${l.time}</b> ${l.title}
                    </div>
                    <div>
                      <span class="log-item-delete" onclick="deleteLogItem('${l.id}', event)">å‰Šé™¤</span>
                    </div>
                  `;
                  d.onclick = (e) => {
                    if(e.target.classList.contains('log-item-delete')) return;
                    document.getElementById('historyModal').style.display='none'; 
                    setTimeout(() => showCustomConfirm("ã“ã®ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\n(ç¾åœ¨ã®ç”»é¢ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™)", () => {
                       google.script.run.withSuccessHandler(restoreSessionToUI).getSessionLogs(l.id);
                    }), 100);
                  };
                  c.appendChild(d);
                });
              }
            }).getLogList();
          } else {
            // â˜…ä¿®æ­£ï¼šå¤±æ•—æ™‚ã¯è¡Œã‚’æ¶ˆã•ãšã‚¨ãƒ©ãƒ¼è¡¨ç¤ºâ˜…
            showCustomAlert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + res.message);
            deleteBtn.textContent = originalText;
            deleteBtn.style.pointerEvents = 'auto'; // ã‚¯ãƒªãƒƒã‚¯å†æœ‰åŠ¹åŒ–
            deleteBtn.style.opacity = '1';
            deleteBtn.style.cursor = 'pointer';
          }
        }).withFailureHandler(e => {
          // â˜…ä¿®æ­£ï¼šå¤±æ•—æ™‚ã¯è¡Œã‚’æ¶ˆã•ãšã‚¨ãƒ©ãƒ¼è¡¨ç¤ºâ˜…
          showCustomAlert("å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
          deleteBtn.textContent = originalText;
          deleteBtn.style.pointerEvents = 'auto'; // ã‚¯ãƒªãƒƒã‚¯å†æœ‰åŠ¹åŒ–
          deleteBtn.style.opacity = '1';
          deleteBtn.style.cursor = 'pointer';
        }).deleteLog(sessionId);
      },
      () => {
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ï¼šä½•ã‚‚å¤‰ãˆãªã„ï¼ˆãƒœã‚¿ãƒ³ã¯æœ‰åŠ¹ã®ã¾ã¾ï¼‰
      }
    );
  }
  
  function closeHistoryModal() { document.getElementById('historyModal').style.display = 'none'; }
  function openManualModal() { document.getElementById('manualModal').style.display = 'flex'; }
  function closeManualModal() { document.getElementById('manualModal').style.display = 'none'; }
  function openAdvanceModal() { document.getElementById('advanceModal').style.display = 'flex'; }
  function closeAdvanceModal() { document.getElementById('advanceModal').style.display = 'none'; }
  function closeCodeModal() { document.getElementById('codeModal').style.display = 'none'; }
  
  function showCustomConfirm(msg, yesCb, noCb) {
    document.getElementById('confirmMessage').innerText = msg;
    const modal = document.getElementById('customConfirmModal');
    const confirmBtn = document.getElementById('confirmYesBtn');
    const cancelBtn = document.getElementById('confirmCancelBtn');
    
    // OKãƒœã‚¿ãƒ³ã®å‡¦ç†
    confirmBtn.onclick = () => { 
      modal.style.display='none'; 
      if(yesCb) yesCb(); 
    };
    
    // â˜…ä¿®æ­£ï¼šã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾å¿œâ˜…
    if(cancelBtn) {
      cancelBtn.onclick = () => {
        modal.style.display='none';
        if(noCb) noCb();
      };
    }
    
    modal.style.display = 'flex';
  }
  function closeConfirmModal() { document.getElementById('customConfirmModal').style.display = 'none'; }
  // â˜…ç‰ˆæƒ…å ±ä¸€å…ƒåŒ–ï¼šã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ç‰ˆæƒ…å ±ã‚’ä»˜ä¸â˜…
  function showCustomAlert(msg) { 
    const versionInfo = ` (${APP_VERSION} / b=${currentBuildId})`;
    const msgWithVersion = msg.includes('(') && msg.includes(')') ? msg : msg + versionInfo;
    document.getElementById('alertMessage').innerText = msgWithVersion; 
    document.getElementById('customAlertModal').style.display = 'flex'; 
  }
  function closeAlertModal() { document.getElementById('customAlertModal').style.display = 'none'; }
  
  function restoreSessionToUI(logs) {
    if(!logs || !logs.length) return;
    resetInputArea();
    ['yui','gemini','rex'].forEach(a => document.getElementById('hist-'+a).innerHTML="");
    answerCardCount = { yui: 0, gemini: 0, rex: 0 };
    if(logs[0].title) document.getElementById('topicTitle').value = logs[0].title;
    logs.forEach(row => {
      if(row.speaker !== 'User') {
        const agent = row.speaker.toLowerCase();
        if(document.getElementById('hist-'+agent)) {
          answerCardCount[agent]++;
          const isFirstAnswer = (answerCardCount[agent] === 1);
          const cardId = 'card-restore-' + Date.now() + '-' + Math.random();
          const answerCard = createAnswerCard(cardId, agent, row.content, true, isFirstAnswer);
          document.getElementById('hist-'+agent).insertAdjacentHTML('afterbegin', answerCard);
          // â˜…ä¿®æ­£ï¼šæŠ˜ã‚ŠãŸãŸã¿ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¤å®šâ˜…
          checkCardCollapse(cardId);
        }
      }
    });
    
    ['yui', 'gemini', 'rex'].forEach(agent => {
      limitHistory(agent);
    });
  }
</script>
</body>
</html>

