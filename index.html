<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    /* V0.2.9 UI Style */
    :root {
      --bg-color: #f4f6f8;
      --card-bg: #ffffff;
      --text-main: #2d3748;
      --text-sub: #718096;
      --accent-yui: #e91e63;
      --accent-gemini: #2196f3;
      --accent-rex: #ff9800;
      --btn-primary: #10a37f;
      --radius: 12px;
    }
    body { font-family: 'Inter', sans-serif; background: var(--bg-color); color: var(--text-main); margin: 0; padding: 20px; line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; }
    
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .app-title { font-weight: 800; font-size: 1.5rem; color: #1a202c; }
    .ver-tag { font-size: 0.8rem; background: #e2e8f0; padding: 4px 8px; border-radius: 4px; margin-left: 10px; }

    .input-card { background: var(--card-bg); padding: 20px; border-radius: var(--radius); box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
    textarea { width: 100%; height: 80px; border: 2px solid #e2e8f0; border-radius: 8px; padding: 10px; font-size: 1rem; resize: vertical; font-family: inherit; }
    textarea:focus { border-color: var(--btn-primary); outline: none; }
    
    .controls { display: flex; gap: 15px; margin-top: 15px; align-items: center; flex-wrap: wrap; }
    
    /* Button Styles (Fix included) */
    .ai-group { display: flex; gap: 8px; }
    .ai-btn { padding: 8px 16px; border-radius: 20px; border: 2px solid transparent; font-weight: 600; cursor: pointer; background: #edf2f7; color: #718096; transition: all 0.2s; }
    
    /* Individual Selected States */
    .ai-btn[data-ai="Yui"].is-selected { background: var(--accent-yui); border-color: var(--accent-yui); color: white; box-shadow: 0 2px 4px rgba(233,30,99,0.3); }
    .ai-btn[data-ai="Gemini"].is-selected { background: var(--accent-gemini); border-color: var(--accent-gemini); color: white; box-shadow: 0 2px 4px rgba(33,150,243,0.3); }
    .ai-btn[data-ai="Rex"].is-selected { background: var(--accent-rex); border-color: var(--accent-rex); color: white; box-shadow: 0 2px 4px rgba(255,152,0,0.3); }
    
    /* All Button Special Logic: White when selected (default), Dark when active to select all */
    .ai-btn.all { border: 2px solid #cbd5e0; background: #fff; color: var(--text-main); }
    .ai-btn.all.is-selected { background: #2d3748; color: white; border-color: #2d3748; }

    .action-btn { padding: 10px 24px; border-radius: 8px; font-weight: 700; color: white; border: none; cursor: pointer; background: var(--btn-primary); margin-left: auto; }
    .action-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
    .file-input-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
    .file-btn { background: #fff; border: 2px solid #cbd5e0; padding: 8px 16px; border-radius: 8px; font-weight: 600; color: #4a5568; cursor: pointer; }
    
    .preview-area { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .thumb-box { position: relative; width: 60px; height: 60px; border-radius: 6px; overflow: hidden; border: 1px solid #ddd; }
    .thumb-box img { width: 100%; height: 100%; object-fit: cover; }
    .thumb-remove { position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.6); color: white; width: 18px; height: 18px; font-size: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

    .chat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .ai-card { background: var(--card-bg); border-radius: var(--radius); padding: 0; border-top: 5px solid #ccc; display: flex; flex-direction: column; height: 100%; }
    .ai-card.yui { border-color: var(--accent-yui); }
    .ai-card.gemini { border-color: var(--accent-gemini); }
    .ai-card.rex { border-color: var(--accent-rex); }
    
    .card-header { padding: 15px; font-weight: 700; border-bottom: 1px solid #edf2f7; display: flex; justify-content: space-between; }
    .card-body { padding: 15px; flex-grow: 1; min-height: 200px; max-height: 600px; overflow-y: auto; background: #fafafa; }
    
    .msg { margin-bottom: 15px; padding: 10px; border-radius: 8px; font-size: 0.95rem; line-height: 1.5; white-space: pre-wrap; }
    .msg.user { background: #edf2f7; color: #4a5568; border-bottom-right-radius: 2px; margin-left: 20px; font-size: 0.85rem; }
    .msg.ai { background: #fff; border: 1px solid #e2e8f0; border-bottom-left-radius: 2px; margin-right: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
    .timestamp { font-size: 0.7rem; color: #a0aec0; text-align: right; margin-top: 4px; }

    .loading { display: none; color: #718096; font-size: 0.9rem; font-style: italic; padding: 10px; }
    .loading::after { content: "..."; animation: dots 1.5s infinite; }
    @keyframes dots { 0%, 20% { content: "."; } 40% { content: ".."; } 60%, 100% { content: "..."; } }
    .clear-btn { font-size: 0.8rem; color: #a0aec0; cursor: pointer; text-decoration: underline; margin-left: 10px; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="app-title">AI Strategy Room <span class="ver-tag">v0.2.9-code-sync</span></div>
    <div id="status-bar" style="font-size: 0.8rem; color: #718096;">Ready</div>
  </div>

  <div class="input-card">
    <textarea id="themeInput" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•ÂäõÔºà‰æãÔºö@code full index.html „ÇíÂàÜÊûê„Åó„Å¶„ÄÅ„Å™„Å©Ôºâ"></textarea>
    <div class="preview-area" id="previewArea"></div>
    <div class="controls">
      <div class="file-input-wrapper">
        <button class="file-btn">üì∑ ÁîªÂÉèÊ∑ª‰ªò</button>
        <input type="file" id="imageInput" accept="image/*" multiple onchange="handleFileSelect(this)">
      </div>
      <div class="ai-group">
        <button type="button" class="ai-btn all" id="btn-all" onclick="toggleAgent('all')">ÂÖ®Âì°</button>
        <div class="ai-btn is-selected" id="btn-yui" onclick="toggleAgent('Yui')" data-ai="Yui">Yui</div>
        <div class="ai-btn is-selected" id="btn-gemini" onclick="toggleAgent('Gemini')" data-ai="Gemini">GEMINI</div>
        <div class="ai-btn is-selected" id="btn-rex" onclick="toggleAgent('Rex')" data-ai="Rex">Rex</div>
      </div>
      <button class="action-btn" onclick="startDiscussion()" id="sendBtn">ÈÄÅ‰ø° (DISCUSS)</button>
    </div>
  </div>

  <div class="chat-grid">
    <div class="ai-card yui">
      <div class="card-header"><span>ü©∑ Yui (Secretary)</span><span class="clear-btn" onclick="clearHistory('Yui')">Clear</span></div>
      <div class="card-body" id="log-Yui"></div>
      <div class="loading" id="load-Yui">Thinking</div>
    </div>
    <div class="ai-card gemini">
      <div class="card-header"><span>‚ú® Gemini (Analyst)</span><span class="clear-btn" onclick="clearHistory('Gemini')">Clear</span></div>
      <div class="card-body" id="log-Gemini"></div>
      <div class="loading" id="load-Gemini">Analyzing</div>
    </div>
    <div class="ai-card rex">
      <div class="card-header"><span>ü¶Å Rex (Red Team)</span><span class="clear-btn" onclick="clearHistory('Rex')">Clear</span></div>
      <div class="card-body" id="log-Rex"></div>
      <div class="loading" id="load-Rex">Critiquing</div>
    </div>
  </div>
</div>

<script>
  let conversationHistory = { Yui: [], Gemini: [], Rex: [] };
  const AI_LIST = ['Yui', 'Gemini', 'Rex'];
  let selectedAgents = new Set(AI_LIST);
  let selectedImages = [];

  function toggleAgent(target) {
    if (target === 'all') {
      // Toggle All: If currently 3 selected, reset to all. If partial, reset to all.
      selectedAgents = new Set(AI_LIST);
    } else {
      // Toggle Individual
      if (selectedAgents.has(target)) { 
        if (selectedAgents.size > 1) selectedAgents.delete(target); // Prevent empty
      } else { 
        selectedAgents.add(target); 
      }
    }
    updateAgentButtons();
  }

  function updateAgentButtons() {
    const isAll = (selectedAgents.size === 3);
    // ÂÖ®Âì°„Éú„Çø„É≥: ÂÖ®Âì°ÈÅ∏ÊäûÊôÇ„ÅØÁôΩ(false)„ÄÅ„Åù„Çå‰ª•Â§ñ„ÅØÈªí(true)„Åß„ÄåÊäº„Åõ„Äç„Å®‰øÉ„Åô„É≠„Ç∏„ÉÉ„ÇØ
    document.getElementById('btn-all').classList.toggle('is-selected', !isAll);
    // ÂÄãÂà•„Éú„Çø„É≥: ÈÅ∏ÊäûÊôÇ„ÅØËâ≤‰ªò„Åç(true)„ÄÅÈùûÈÅ∏Êäû„ÅØÁôΩ(false)
    document.getElementById('btn-yui').classList.toggle('is-selected', selectedAgents.has('Yui'));
    document.getElementById('btn-gemini').classList.toggle('is-selected', selectedAgents.has('Gemini'));
    document.getElementById('btn-rex').classList.toggle('is-selected', selectedAgents.has('Rex'));
  }
  
  // Initialize
  updateAgentButtons();

  function handleFileSelect(input) {
    const files = input.files;
    if (files.length + selectedImages.length > 10) return alert("ÁîªÂÉè„ÅØÊúÄÂ§ß10Êûö„Åæ„Åß„Åß„Åô");
    Array.from(files).forEach(file => {
      const reader = new FileReader();
      reader.onload = e => { selectedImages.push(e.target.result); renderPreviews(); };
      reader.readAsDataURL(file);
    });
    input.value = '';
  }

  function renderPreviews() {
    const area = document.getElementById('previewArea');
    area.innerHTML = '';
    selectedImages.forEach((src, idx) => {
      const box = document.createElement('div');
      box.className = 'thumb-box';
      box.innerHTML = `<img src="${src}"><div class="thumb-remove" onclick="removeImage(${idx})">√ó</div>`;
      area.appendChild(box);
    });
  }
  function removeImage(idx) { selectedImages.splice(idx, 1); renderPreviews(); }
  function clearHistory(ai) { if(confirm(`${ai}„ÅÆË®òÊÜ∂„ÇíÊ∂àÂéª„Åó„Åæ„Åô„ÅãÔºü`)) { conversationHistory[ai] = []; document.getElementById(`log-${ai}`).innerHTML = ''; } }

  function startDiscussion() {
    const theme = document.getElementById('themeInput').value.trim();
    if (!theme && selectedImages.length === 0) return alert("„É°„ÉÉ„Çª„Éº„Ç∏„Åæ„Åü„ÅØÁîªÂÉè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
    if (selectedAgents.size === 0) return alert("AI„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ");

    document.getElementById('sendBtn').disabled = true;
    document.getElementById('themeInput').value = ''; 
    
    Array.from(selectedAgents).forEach(ai => {
      appendMessage(ai, 'user', theme);
      document.getElementById(`load-${ai}`).style.display = 'block';
      const historyToSend = conversationHistory[ai].slice(-20);
      google.script.run
        .withSuccessHandler(res => handleSuccess(res, ai, theme))
        .withFailureHandler(err => handleError(err, ai))
        .runRelay(theme, selectedImages, ai, historyToSend);
    });
    selectedImages = [];
    renderPreviews();
  }

  function handleSuccess(res, ai, userPrompt) {
    document.getElementById(`load-${ai}`).style.display = 'none';
    if (res.status === 'success') {
      conversationHistory[ai].push({ role: 'user', content: userPrompt });
      conversationHistory[ai].push({ role: 'assistant', content: res.response });
      appendMessage(ai, 'ai', res.response);
    } else {
      appendMessage(ai, 'ai', `(Error: ${res.message})`);
    }
    setTimeout(() => { document.getElementById('sendBtn').disabled = false; }, 1000);
  }

  function handleError(err, ai) {
    document.getElementById(`load-${ai}`).style.display = 'none';
    appendMessage(ai, 'ai', `(System Error: ${err.message})`);
    document.getElementById('sendBtn').disabled = false;
  }

  function appendMessage(ai, role, text) {
    const box = document.getElementById(`log-${ai}`);
    const div = document.createElement('div');
    div.className = `msg ${role}`;
    div.textContent = text;
    const time = document.createElement('div');
    time.className = 'timestamp';
    time.innerText = new Date().toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'});
    div.appendChild(time);
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }
</script>
</body>
</html>