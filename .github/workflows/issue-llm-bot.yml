# ==============================================================
# AI戦略会議室｜Issue LLM Bot
# Version: v1.0.3
# Date: 2025-12-16 11:35 JST
# Changes:
# - YAML構文エラー（line 50付近のインデント崩れ）を根治：プロンプト生成をheredoc＋ファイル化
# - /approve または /check のコメント時だけ動く（無関係コメントでは動かない）
# - OpenAI Responses API：output_text / output[].content[].text(type=output_text) の両対応で本文抽出
# - 添付画像URLを最大4枚まで <details> でプレビュー表示
# ==============================================================

name: Issue LLM Bot

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

concurrency:
  group: issue-llm-bot-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  bot:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'issues' || (github.event_name == 'issue_comment' && (contains(github.event.comment.body, '/approve') || contains(github.event.comment.body, '/check'))) }}

    steps:
      - name: Ensure jq is available
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

      - name: Build prompt
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          COMMENT_BODY: ${{ github.event_name == 'issue_comment' && github.event.comment.body || '' }}
        run: |
          set -euo pipefail

          # --- 基本指示（固定） ---
          cat > prompt.txt <<'EOF'
あなたは「戦略的会議室」の議事進行AIです。
次のIssue/コメントを読み、以下の形式で日本語で返信してください。

【出力形式】
1) 要旨（1〜2行）
2) 次の1アクション（クリック/入力まで具体）
3) 添付画像（プレビュー）: 画像があれば <details> で折りたたみ表示（最大4枚）

【注意】
- 余計な前置きは不要
- 安全上の配慮が必要な内容は注意喚起する
EOF

          # --- 入力（Issue/コメント） ---
          {
            echo ""
            echo "----"
            echo "Issue URL: ${ISSUE_URL}"
            echo "Issue #: ${ISSUE_NUMBER}"
            echo "Title: ${ISSUE_TITLE}"
            echo ""
            echo "Body:"
            echo "${ISSUE_BODY}"
            if [ "${EVENT_NAME}" = "issue_comment" ] && [ -n "${COMMENT_BODY}" ]; then
              echo ""
              echo "Comment:"
              echo "${COMMENT_BODY}"
            fi
          } >> prompt.txt

      - name: Call OpenAI (Responses API)
        id: llm
        shell: bash
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail

          PROMPT_JSON=$(jq -Rs . < prompt.txt)

          OPENAI_JSON=$(curl -sS -X POST https://api.openai.com/v1/responses \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"gpt-4o\",
              \"input\": ${PROMPT_JSON}
            }")

          # 本文抽出（.output_text があれば優先、なければ output[] から連結）
          AI_TEXT=$(echo "$OPENAI_JSON" | jq -r '
            (.output_text // ([.output[]?
              | select(.type=="message")
              | .content[]?
              | select(.type=="output_text")
              | .text] | join("\n")))
          ' || true)

          if [ -z "$AI_TEXT" ] || [ "$AI_TEXT" = "null" ]; then
            ERR=$(echo "$OPENAI_JSON" | jq -r '.error.message // empty' || true)
            echo "::error::OpenAI response parsing failed"
            echo "RAW: $OPENAI_JSON"
            if [ -n "$ERR" ]; then
              AI_TEXT="（Bot側でAI呼び出しに失敗しました）\n\n原因: ${ERR}\n\n次の1アクション: Actionsのログ（Generate/Call OpenAI部分）を開いて、エラー行を貼ってください。"
            else
              AI_TEXT="（Bot側でAI呼び出しに失敗しました）\n\n次の1アクション: Actionsのログを開いて、RAW出力（Response: ...）を貼ってください。"
            fi
          fi

          # 添付画像URL抽出（最大4）
          IMG_URLS=$(grep -oE 'https://[^ )"]+' prompt.txt \
            | grep -E 'github\.com/.*/assets|user-images\.githubusercontent\.com|githubusercontent\.com' \
            | head -n 4 || true)

          if [ -n "$IMG_URLS" ]; then
            AI_TEXT="${AI_TEXT}

---

## 添付画像（プレビュー）
<details><summary>画像を開く（最大4枚）</summary>

"
            while IFS= read -r url; do
              [ -z "$url" ] && continue
              AI_TEXT="${AI_TEXT}![](${url})

"
            done <<< "$IMG_URLS"
            AI_TEXT="${AI_TEXT}</details>"
          fi

          echo "ai_text<<EOF" >> "$GITHUB_OUTPUT"
          printf "%s\n" "$AI_TEXT" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Post comment to Issue
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          AI_TEXT: ${{ steps.llm.outputs.ai_text }}
        run: |
          set -euo pipefail
          COMMENT_JSON=$(printf "%s" "$AI_TEXT" | jq -Rs .)

          curl -sS -X POST \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/issues/${ISSUE_NUMBER}/comments" \
            -d "{\"body\": ${COMMENT_JSON} }" >/dev/null
