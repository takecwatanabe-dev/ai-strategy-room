# issue-llm-bot.yml
# VERSION: v0.3.0-botpreview-01
# BUILD(JST): 2025-12-14 15:47
name: Issue LLM Bot

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read

jobs:
  auto_reply_task:
    if: github.event_name == 'issues' && startsWith(github.event.issue.title, '[TASK]')
    runs-on: ubuntu-latest
    steps:
      - name: Post auto reply (TASK)
        uses: actions/github-script@v7
        env:
          # ã©ã¡ã‚‰ã®åå‰ã§ã‚‚å‹•ãã‚ˆã†ã«ï¼ˆPENAI_API_KEYå„ªå…ˆï¼‰
          OPENAI_API_KEY: ${{ secrets.PENAI_API_KEY || secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-5-mini
        with:
          script: |
            const issue = context.payload.issue;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const apiKey = process.env.OPENAI_API_KEY || '';
            const model = process.env.OPENAI_MODEL || 'gpt-5-mini';

            function uniq(arr) { return [...new Set(arr.filter(Boolean))]; }

            function extractImageUrls(text) {
              const urls = [];
              if (!text) return urls;

              // markdown: ![alt](url)
              const md = /!\[[^\]]*\]\(([^)]+)\)/g;
              let m;
              while ((m = md.exec(text)) !== null) urls.push(m[1]);

              // html: <img ... src="url">
              const img = /<img[^>]+src=["']([^"']+)["'][^>]*>/gi;
              while ((m = img.exec(text)) !== null) urls.push(m[1]);

              // raw urls
              const raw = /(https?:\/\/[^\s)>"']+)/g;
              while ((m = raw.exec(text)) !== null) urls.push(m[1]);

              const filtered = urls
                .map(u => u.trim())
                .filter(u =>
                  /(github\.com\/user-attachments\/assets\/|githubusercontent\.com\/)/i.test(u) ||
                  /\.(png|jpe?g|gif|webp)(\?|#|$)/i.test(u)
                );

              return uniq(filtered);
            }

            // ã‚µãƒ ãƒï¼ˆå¸¸æ™‚è¡¨ç¤ºï¼‰ï¼‹detailsï¼ˆå¤§ãã‚è¡¨ç¤ºï¼‰ã«çµ±ä¸€
            function renderImagePreview(urls) {
              if (!urls.length) return '';

              const thumbs = urls
                .map((u, i) => `<img src="${u}" width="220" alt="thumb-${i+1}">`)
                .join(' ');

              const fulls = urls
                .map((u, i) => `<p><img src="${u}" width="900" alt="image-${i+1}"></p>`)
                .join('\n');

              return [
                '',
                '---',
                '',
                '## æ·»ä»˜ç”»åƒï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰',
                '',
                '<p>' + thumbs + '</p>',
                '',
                '<details>',
                '  <summary>ğŸ–¼ å¤§ãã‚è¡¨ç¤ºï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹ãï¼ã‚‚ã†ä¸€åº¦ã§é–‰ã˜ã‚‹ï¼‰</summary>',
                '  <br/>',
                fulls,
                '</details>',
                ''
              ].join('\n');
            }

            function normalizeBody(text) {
              if (!text) return '';
              return text
                .replace(/_No response_/g, '')
                .replace(/No response/g, '')
                .replace(/\r\n/g, '\n')
                .trim();
            }

            async function callOpenAI(prompt) {
              const res = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${apiKey}`,
                },
                body: JSON.stringify({
                  model,
                  temperature: 0.2,
                  messages: [
                    {
                      role: 'system',
                      content:
                        'ã‚ãªãŸã¯ã€ŒAIæˆ¦ç•¥ä¼šè­°å®¤ã€ã®Issue Botã§ã™ã€‚å¿…ãšæ—¥æœ¬èªã§ã€(1)è¦æ—¨ (2)æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ1ã¤ã ã‘ï¼‰ (3)æ‰‹é †ï¼ˆStep 1â†’ï¼‰ (4)ã†ã¾ãã„ã‹ãªã„æ™‚ (5)æ³¨æ„ç‚¹ ã®é †ã§çŸ­ãæ›¸ãã¾ã™ã€‚' +
                        'APIã‚­ãƒ¼è¨­å®šã®æ¡ˆå†…ã¯ã€å®Ÿéš›ã«ã‚­ãƒ¼ãŒæœªè¨­å®šã§å®Ÿè¡Œã§ããªã„å ´åˆã«ã®ã¿å‡ºã—ã¾ã™ã€‚Markdownã§èª­ã¿ã‚„ã™ãã€‚'
                    },
                    { role: 'user', content: prompt }
                  ]
                })
              });

              if (!res.ok) {
                const t = await res.text();
                throw new Error(`OpenAI API error: ${res.status} ${t}`);
              }
              const data = await res.json();
              const msg = data?.choices?.[0]?.message?.content?.trim();
              return msg || '';
            }

            const rawBody = issue.body || '';
            const body = normalizeBody(rawBody);
            const imageUrls = extractImageUrls(rawBody);

            const bodyLooksEmpty = body.length === 0;

            let mainText = '';
            if (!apiKey) {
              mainText = [
                '## è¦æ—¨',
                'Botå´ã§APIå‘¼ã³å‡ºã—ãŒã§ãã¾ã›ã‚“ï¼ˆSecretsæœªè¨­å®šï¼‰ã€‚',
                '',
                '## æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ1ã¤ã ã‘ï¼‰',
                'Repository secrets ã« `PENAI_API_KEY`ï¼ˆã¾ãŸã¯ `OPENAI_API_KEY`ï¼‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚',
                '',
                '## æ‰‹é †ï¼ˆStep 1â†’ï¼‰',
                'Step 1ï¼šSettings â†’ Secrets and variables â†’ Actions',
                'Step 2ï¼šRepository secrets â†’ New repository secret',
                'Step 3ï¼šNameã« `PENAI_API_KEY`ã€Valueã«OpenAIã®APIã‚­ãƒ¼ã‚’è²¼ã£ã¦ Save',
                '',
                '## ã†ã¾ãã„ã‹ãªã„æ™‚',
                '- Organization secrets ã§ã¯ãªã Repository secrets ã«å…¥ã£ã¦ã„ã‚‹ã‹ç¢ºèª',
                '',
                '## æ³¨æ„ç‚¹',
                '- APIã‚­ãƒ¼ã¯Issueæœ¬æ–‡ã«è²¼ã‚‰ãªã„'
              ].join('\n');
            } else if (bodyLooksEmpty) {
              mainText = [
                '## è¦æ—¨',
                'æœ¬æ–‡ã®æƒ…å ±ãŒç©ºã§ã—ãŸï¼ˆç”»åƒã¯å—ã‘å–ã‚Œã¦ã„ã¾ã™ï¼‰ã€‚ç¾çŠ¶ã§ã¯ä½œæ¥­é–‹å§‹ãŒã§ãã¾ã›ã‚“ã€‚',
                '',
                '## æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ1ã¤ã ã‘ï¼‰',
                'ã“ã®Issueã®ã‚³ãƒ¡ãƒ³ãƒˆã«ã€Œã‚„ã‚ŠãŸã„ã“ã¨ï¼ˆ1è¡Œï¼‰ã€ã ã‘æ›¸ã„ã¦ãã ã•ã„ã€‚',
                '',
                '## æ‰‹é †ï¼ˆStep 1â†’ï¼‰',
                'Step 1ï¼šä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã« ä¾‹ï¼š`ç”»åƒã®è¡¨ç¤ºã‚’ã€ã‚µãƒ ãƒâ†’ã‚¯ãƒªãƒƒã‚¯ã§å¤§ãã‚è¡¨ç¤ºï¼ˆåˆ¥ã‚¿ãƒ–NGï¼‰ã«ã—ãŸã„` ã¨1è¡Œã§æ›¸ã',
                '',
                '## ã†ã¾ãã„ã‹ãªã„æ™‚',
                '- ç›®çš„ã‚„æœŸé™ãŒã‚ã‚‹ãªã‚‰ä¸€ç·’ã«1è¡Œã§è¿½è¨˜',
                '',
                '## æ³¨æ„ç‚¹',
                '- ç”»åƒã ã‘ã§ã‚‚OKã§ã™ãŒã€1è¡Œã®æ„å›³ãŒã‚ã‚‹ã¨ä¸€æ°—ã«é€²ã¿ã¾ã™'
              ].join('\n');
            } else {
              const prompt = [
                'Issueã‚¿ã‚¤ãƒˆãƒ«:',
                issue.title,
                '',
                'Issueæœ¬æ–‡:',
                body,
                '',
                'ç”»åƒURLï¼ˆã‚ã‚Œã°ï¼‰:',
                imageUrls.join('\n') || '(ãªã—)',
                '',
                'ä¸Šã®æƒ…å ±ã‚’èª­ã‚“ã§ã€æŒ‡ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«æ²¿ã£ã¦è¿”ç­”ã—ã¦ãã ã•ã„ã€‚'
              ].join('\n');

              try {
                mainText = await callOpenAI(prompt);
              } catch (e) {
                mainText = [
                  '## è¦æ—¨',
                  'Botå´ã§AIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚',
                  '',
                  '## æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ1ã¤ã ã‘ï¼‰',
                  'Actions ã®å®Ÿè¡Œãƒ­ã‚°ã‚’é–‹ã„ã¦ã€èµ¤ã„ã‚¨ãƒ©ãƒ¼è¡Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«è²¼ã£ã¦ãã ã•ã„ã€‚',
                  '',
                  '## æ‰‹é †ï¼ˆStep 1â†’ï¼‰',
                  'Step 1ï¼šActions â†’ è©²å½“Run â†’ Logs ã‚’é–‹ã',
                  'Step 2ï¼šã„ã¡ã°ã‚“ä¸‹ã®èµ¤ã„è¡Œã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€ã“ã®Issueã«è²¼ã‚‹',
                  '',
                  '## ã†ã¾ãã„ã‹ãªã„æ™‚',
                  '- ã¾ãšã¯Secretsåï¼ˆPENAI_API_KEY / OPENAI_API_KEYï¼‰ã‚’å†ç¢ºèª',
                  '',
                  '## æ³¨æ„ç‚¹',
                  '- APIã‚­ãƒ¼æœ¬ä½“ã¯è²¼ã‚‰ãªã„'
                ].join('\n');
              }
            }

            const approveHint = [
              '',
              '---',
              '',
              'æ‰¿èªã—ã¦æ¬¡ã¸é€²ã‚ã‚‹ã¨ãã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã« `/approve` ã¨æ›¸ã„ã¦ãã ã•ã„ã€‚'
            ].join('\n');

            const commentBody =
              '# Botè¿”ä¿¡ï¼ˆTASKï¼‰\n\n' +
              mainText +
              approveHint +
              renderImagePreview(imageUrls);

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issue.number,
              body: commentBody
            });

  approve_gate:
    if: github.event_name == 'issue_comment' && contains(github.event.comment.body, '/approve')
    runs-on: ubuntu-latest
    steps:
      - name: Acknowledge approve
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const number = issue.number;

            // Botã®è‡ªå·±ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼ˆbotè‡ªèº«ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ç„¡è¦–ï¼‰
            if ((context.payload.comment.user && context.payload.comment.user.type) === 'Bot') return;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: number,
              body: [
                'æ‰¿èªã‚’å—ã‘å–ã‚Šã¾ã—ãŸï¼ˆ/approveï¼‰ã€‚',
                'æ¬¡ã®ä½œæ¥­ã«é€²ã‚ã¾ã™ã€‚'
              ].join('\n')
            });
