name: Issue LLM Bot

on:
  issues:
    types: [opened, reopened]

permissions:
  issues: write
  contents: read

jobs:
  reply:
    if: startsWith(github.event.issue.title, '[TASK]') && github.event.issue.user.type != 'Bot'
    runs-on: ubuntu-latest

    steps:
      - name: Generate reply and post comment (OpenAI -> Gemini)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          OPENAI_MODEL: gpt-4o-mini
          GEMINI_MODEL: gemini-1.5-flash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import os, json, urllib.request, urllib.error

          repo = os.environ["REPO"]
          issue_number = os.environ["ISSUE_NUMBER"]
          title = (os.environ.get("ISSUE_TITLE") or "").strip()
          body = (os.environ.get("ISSUE_BODY") or "").strip()

          openai_key = os.environ.get("OPENAI_API_KEY", "").strip()
          gemini_key = os.environ.get("GEMINI_API_KEY", "").strip()
          gh_token = os.environ.get("GITHUB_TOKEN", "").strip()

          openai_model = os.environ.get("OPENAI_MODEL", "gpt-4o-mini").strip()
          gemini_model = os.environ.get("GEMINI_MODEL", "gemini-1.5-flash").strip()

          prompt = (
              "あなたはプロジェクト補助AIです。ユーザーはコピペ量を減らしたい。\n"
              "以下のIssue内容から、日本語のMarkdownで短く返してください。\n"
              "出力は必ず次の順で：\n"
              "1) 要旨（1〜2行）\n"
              "2) 次の1アクション（クリック/入力まで具体）\n"
              "3) うまくいかない時の分岐（A/Bの2つまで）\n"
              "4) 注意点（機密情報は貼らない、1〜2行）\n\n"
              f"--- Issue Title ---\n{title}\n\n"
              f"--- Issue Body ---\n{body}\n"
          )

          def http_json(url, headers, payload):
              data = json.dumps(payload).encode("utf-8")
              req = urllib.request.Request(url, data=data, headers=headers, method="POST")
              with urllib.request.urlopen(req, timeout=60) as res:
                  return json.loads(res.read().decode("utf-8"))

          def call_openai():
              if not openai_key:
                  raise RuntimeError("OPENAI_API_KEY is empty")
              url = "https://api.openai.com/v1/chat/completions"
              headers = {
                  "Authorization": f"Bearer {openai_key}",
                  "Content-Type": "application/json",
              }
              payload = {
                  "model": openai_model,
                  "messages": [
                      {"role": "system", "content": "短く、実行しやすく。余計な前置きはしない。"},
                      {"role": "user", "content": prompt},
                  ],
                  "temperature": 0.2,
              }
              j = http_json(url, headers, payload)
              return j["choices"][0]["message"]["content"]

          def call_gemini():
              if not gemini_key:
                  raise RuntimeError("GEMINI_API_KEY is empty")
              url = f"https://generativelanguage.googleapis.com/v1beta/models/{gemini_model}:generateContent?key={gemini_key}"
              headers = {"Content-Type": "application/json"}
              payload = {"contents": [{"parts": [{"text": prompt}]}]}
              j = http_json(url, headers, payload)
              return j["candidates"][0]["content"]["parts"][0]["text"]

          reply = None
          provider = None
          errors = []

          # Try OpenAI first
          try:
              reply = call_openai()
              provider = "OpenAI"
          except Exception as e:
              errors.append(f"OpenAI: {e}")

          # Fallback to Gemini
          if reply is None:
              try:
                  reply = call_gemini()
                  provider = "Gemini"
              except Exception as e:
                  errors.append(f"Gemini: {e}")

          if reply is None:
              reply = "実行に失敗しました。\n\n" + "\n".join(f"- {x}" for x in errors)
              provider = "None"

          comment_body = f"（自動返信 / {provider}）\n\n{reply}"

          # Post a comment to the issue
          api = f"https://api.github.com/repos/{repo}/issues/{issue_number}/comments"
          headers = {
              "Authorization": f"token {gh_token}",
              "Accept": "application/vnd.github+json",
              "Content-Type": "application/json",
              "User-Agent": "issue-llm-bot",
          }
          http_json(api, headers, {"body": comment_body})
          print("OK: comment posted")
          PY
