name: Issue LLM Bot

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  reply:
    if: github.event_name == 'issues' && startsWith(github.event.issue.title, '[TASK]')
    runs-on: ubuntu-latest
    steps:
      - name: Post LLM reply as comment
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL }}
          THUMB_WIDTH: "640"
          MAX_IMAGES: "6"
        with:
          script: |
            const issue = context.payload.issue;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = issue.number;

            const title = issue.title || "";
            const body = issue.body || "";

            if (!process.env.OPENAI_API_KEY) {
              core.setFailed("Missing secrets.OPENAI_API_KEY");
              return;
            }

            const thumbWidth = parseInt(process.env.THUMB_WIDTH || "640", 10);
            const maxImages = parseInt(process.env.MAX_IMAGES || "6", 10);
            const model = process.env.OPENAI_MODEL || "gpt-4o-mini";

            // --- Extract image URLs from issue body (markdown + html + raw urls)
            function uniq(arr) {
              return [...new Set(arr.filter(Boolean))];
            }

            const urls = [];

            // Markdown: ![alt](url)
            {
              const re = /!\[[^\]]*\]\((https?:\/\/[^\s)]+)\)/g;
              let m;
              while ((m = re.exec(body)) !== null) urls.push(m[1]);
            }

            // HTML: <img ... src="url" ...>
            {
              const re = /<img\b[^>]*\bsrc=['"]([^'"]+)['"][^>]*>/gi;
              let m;
              while ((m = re.exec(body)) !== null) urls.push(m[1]);
            }

            // Raw URLs ending with common image extensions OR github user-attachments
            {
              const re = /(https?:\/\/[^\s<>"')]+(?:\.png|\.jpg|\.jpeg|\.gif|\.webp))(?:[\s<>"')]|$)/gi;
              let m;
              while ((m = re.exec(body)) !== null) urls.push(m[1]);
            }
            {
              const re = /(https?:\/\/github\.com\/user-attachments\/assets\/[^\s<>"')]+)(?:[\s<>"')]|$)/gi;
              let m;
              while ((m = re.exec(body)) !== null) urls.push(m[1]);
            }

            const imageUrls = uniq(urls).slice(0, maxImages);

            // --- Build prompt (keep the exact 4-section format)
            const system = [
              "あなたは『ユイ』です。日本語で、落ち着いたトーンで、簡潔に答えてください。",
              "必ず次の4項目だけを、番号付きで出力してください：",
              "1) 要旨（1〜2行）",
              "2) 次の1アクション（クリック/入力まで具体）",
              "3) うまくいかない時の分岐（A/Bで2つまで）",
              "4) 注意点（秘密情報は貼らない、など1〜2行）",
              "画像は解析しないでOK。本文に貼られている前提でよい。"
            ].join("\n");

            const user = [
              "--- Issue Title ---",
              title,
              "",
              "--- Issue Body ---",
              body
            ].join("\n");

            // --- Call OpenAI (chat completions)
            const payload = {
              model,
              temperature: 0.4,
              messages: [
                { role: "system", content: system },
                { role: "user", content: user }
              ]
            };

            const resp = await fetch("https://api.openai.com/v1/chat/completions", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`
              },
              body: JSON.stringify(payload)
            });

            if (!resp.ok) {
              const t = await resp.text();
              core.setFailed(`OpenAI API error: ${resp.status} ${t}`);
              return;
            }

            const data = await resp.json();
            const content = data?.choices?.[0]?.message?.content?.trim() || "(no content)";

            // --- Build image preview block (thumbnail width fixed)
            let preview = "";
            if (imageUrls.length > 0) {
              preview += "\n\n---\n\n## 添付画像（プレビュー）\n";
              preview += "※クリックで拡大\n";
              for (const u of imageUrls) {
                // Using HTML <img width="..."> to force thumbnail sizing on GitHub
                preview += `\n<a href="${u}"><img src="${u}" width="${thumbWidth}" alt="attachment" /></a>\n`;
              }
            }

            const footer = `\n\n---\n\nbot: OpenAI`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: `${content}${preview}${footer}`
            });

  approve:
    if: github.event_name == 'issue_comment' && contains(github.event.comment.body, '/approve')
    runs-on: ubuntu-latest
    steps:
      - name: Mark as approved (label + comment)
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            // Label the issue
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number,
              labels: ["approved"]
            });

            // Post acknowledgement
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: [
                "承認（/approve）を受け取りました。",
                "次：Rexへ投げる段取りに進めます（転送の自動化はこの次の改善で入れます）。"
              ].join("\n")
            });
