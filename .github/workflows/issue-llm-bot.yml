# Issue LLM Bot — v0.2.0-img-preview-02
# Build(JST): 2025-12-16 16:24
# Policy:
#  - 画像プレビューは「/check または /approve の“そのコメント”に画像がある時だけ」
#  - Issue本文・過去コメントの画像は拾わない
#  - 画像は <details>/<summary> で折りたたみ、枚数表示＋画像間に空行を入れる

name: Issue LLM Bot

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  llm_task:
    runs-on: ubuntu-latest

    steps:
      - name: Prepare Context (decide reply + extract images from current comment only)
        id: ctx
        env:
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
        run: |
          python3 - <<'PY'
          import os, json, re, base64

          def b64(s: str) -> str:
            return base64.b64encode((s or "").encode("utf-8")).decode("ascii")

          event_name = os.environ.get("GITHUB_EVENT_NAME", "")
          path = os.environ["GITHUB_EVENT_PATH"]
          with open(path, "r", encoding="utf-8") as f:
            ev = json.load(f)

          issue = ev.get("issue") or {}
          issue_number = str(issue.get("number") or "")
          issue_title = issue.get("title") or ""
          issue_body = issue.get("body") or ""

          comment_body = ""
          command = ""
          should_reply = False

          if event_name == "issues":
            # [TASK] で始まるIssueのみ自動返信（必要ならここを緩めてOK）
            t = (issue_title or
