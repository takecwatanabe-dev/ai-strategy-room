# Issue LLM Bot Workflow
# Version: v0.1.0
# Build(JST): 2025-12-14 00:49
# Changes:
#  - issues opened/reopened に加えて issue_comment created でも返信
#  - github-actions[bot] の自己ループ防止
#  - OpenAI -> Gemini フォールバック（どちらもSecrets前提）

name: Issue LLM Bot

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read

jobs:
  reply:
    if: >
      github.actor != 'github-actions[bot]' &&
      (
        (github.event_name == 'issues' && startsWith(github.event.issue.title, '[TASK]')) ||
        (github.event_name == 'issue_comment' && startsWith(github.event.issue.title, '[TASK]'))
      )
    runs-on: ubuntu-latest
    steps:
      - name: Generate reply and post comment (OpenAI -> Gemini fallback)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_MODEL: gpt-5-mini
          GEMINI_MODEL: gemini-1.5-flash

          EVENT_NAME: ${{ github.event_name }}
          ISSUE_TITLE: ${{ github.event.issue.title || '' }}
          ISSUE_BODY: ${{ github.event.issue.body || '' }}
          COMMENT_BODY: ${{ github.event.comment.body || '' }}

          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          python3 - <<'PY'
          import os, json, urllib.request, urllib.error

          def _post_github_comment(body: str):
            token = (os.getenv("GH_TOKEN") or "").strip()
            repo = (os.getenv("REPO") or "").strip()
            num  = (os.getenv("ISSUE_NUMBER") or "").strip()
            if not (token and repo and num):
              raise RuntimeError("Missing GH_TOKEN / REPO / ISSUE_NUMBER")

            url = f"https://api.github.com/repos/{repo}/issues/{num}/comments"
            payload = {"body": body}
            req = urllib.request.Request(
              url,
              data=json.dumps(payload).encode("utf-8"),
              headers={
                "Authorization": f"Bearer {token}",
                "Accept": "application/vnd.github+json",
                "X-GitHub-Api-Version": "2022-11-28",
                "User-Agent": "issue-llm-bot"
              },
              method="POST"
            )
            with urllib.request.urlopen(req, timeout=60) as r:
              r.read()

          def _call_openai(prompt: str) -> str:
            key = (os.getenv("OPENAI_API_KEY") or "").strip()
            if not key:
              raise RuntimeError("OPENAI_API_KEY not set")
            model = (os.getenv("OPENAI_MODEL") or "gpt-5-mini").strip()

            url = "https://api.openai.com/v1/responses"
            payload = {
              "model": model,
              "input": prompt,
              "max_output_tokens": 700,
              "temperature": 0.2
            }
            req = urllib.request.Request(
              url,
              data=json.dumps(payload).encode("utf-8"),
              headers={
                "Authorization": f"Bearer {key}",
                "Content-Type": "application/json"
              },
              method="POST"
            )
            with urllib.request.urlopen(req, timeout=60) as r:
              data = json.loads(r.read().decode("utf-8"))

            text = (data.get("output_text") or "").strip()
            if text:
              return text

            # fallback parse
            out = []
            for item in (data.get("output") or []):
              for c in (item.get("content") or []):
                t = (c.get("text") or c.get("output_text") or "").strip()
                if t:
                  out.append(t)
            text = "\n".join(out).strip()
            if not text:
              raise RuntimeError("OpenAI returned no text")
            return text

          def _call_gemini(prompt: str) -> str:
            key = (os.getenv("GEMINI_API_KEY") or "").strip()
            if not key:
              raise RuntimeError("GEMINI_API_KEY not set")
            model = (os.getenv("GEMINI_MODEL") or "gemini-1.5-flash").strip()

            url = f"https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={key}"
            payload = {
              "contents": [{"parts": [{"text": prompt}]}],
              "generationConfig": {"temperature": 0.2, "maxOutputTokens": 700}
            }
            req = urllib.request.Request(
              url,
              data=json.dumps(payload).encode("utf-8"),
              headers={"Content-Type": "application/json"},
              method="POST"
            )
            with urllib.request.urlopen(req, timeout=60) as r:
              data = json.loads(r.read().decode("utf-8"))

            cands = data.get("candidates") or []
            if not cands:
              raise RuntimeError("Gemini returned no candidates")
            parts = (((cands[0].get("content") or {}).get("parts")) or [])
            text = "\n".join([(p.get("text") or "") for p in parts]).strip()
            if not text:
              raise RuntimeError("Gemini returned no text")
            return text

          event = (os.getenv("EVENT_NAME") or "").strip()
          title = (os.getenv("ISSUE_TITLE") or "").strip()
          issue_body = (os.getenv("ISSUE_BODY") or "")
          comment_body = (os.getenv("COMMENT_BODY") or "")

          src = (comment_body if event == "issue_comment" else issue_body).strip()
          if not src:
            src = "（本文が空でした。目的・状況・やりたいことを短く書いてね）"

          prompt = f"""あなたはプロジェクト補助AIです。日本語で、短く、実行しやすく返してください。
出力は必ず次の4つの見出しを含めてください（Markdown）:
1) 要旨（1〜2行）
2) 次の1アクション（クリック/入力まで具体。アクションは1つだけ）
3) うまくいかない時の分岐（A/Bで2つまで）
4) 注意点（秘密情報は貼らない、など1〜2行）

補足:
- 画像が貼られている場合、本文に <img ...> や URL が含まれます。読み飛ばさず「画像あり」として扱ってOK。
- 技術用語はできるだけ避け、必要なら（短い説明）を添える。

--- Issue Title ---
{title}

--- Input ---
{src}
"""

          used = "OpenAI"
          try:
            text = _call_openai(prompt)
          except Exception:
            used = "Gemini"
            text = _call_gemini(prompt)

          final = text.strip() + f"\n\n---\nbot: {used}"
          _post_github_comment(final)
          PY
