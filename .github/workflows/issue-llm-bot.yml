# Issue LLM Bot â€” v0.4.0
# Build(JST): 2025-12-14 12:01
# Changes:
# - [TASK] Issueã®è‡ªå‹•è¿”ä¿¡ã‚³ãƒ¡ãƒ³ãƒˆã«ã€Œæ·»ä»˜ç”»åƒï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰ã€ã‚’è¿½åŠ ï¼ˆ<details>ã§é–‹é–‰ï¼‰
# - /approve ã‚³ãƒ¡ãƒ³ãƒˆã§ approved ãƒ©ãƒ™ãƒ«ä»˜ä¸ï¼†å—ä»˜ã‚³ãƒ¡ãƒ³ãƒˆ
# - ç”»åƒURLæŠ½å‡ºï¼ˆMarkdownå½¢å¼ + HTML <img> ä¸¡å¯¾å¿œï¼‰
# - Issueãƒ•ã‚©ãƒ¼ãƒ å´ãŒç©ºæ¬„ã§ã‚‚é€šã‚‹é‹ç”¨ã‚’å‰æã«ã€ç”»åƒã ã‘ã§ã‚‚å›ã‚‹è¨­è¨ˆ

name: Issue LLM Bot

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read

jobs:
  auto_reply:
    if: github.event_name == 'issues' && startsWith(github.event.issue.title, '[TASK]')
    runs-on: ubuntu-latest
    steps:
      - name: Generate and post LLM reply (with image preview)
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.issue.number;

            const issue = context.payload.issue || {};
            const title = (issue.title || "").trim();
            const body = (issue.body || "").trim();

            function uniq(arr) {
              return [...new Set(arr.filter(Boolean))];
            }

            function extractImageUrls(text) {
              const urls = [];

              // Markdown: ![alt](url)
              const reMd = /!\[[^\]]*\]\((https?:\/\/[^\s)]+)\)/g;
              let m;
              while ((m = reMd.exec(text)) !== null) urls.push(m[1]);

              // HTML: <img ... src="...">
              const reImg1 = /<img[^>]+src="([^"]+)"[^>]*>/g;
              while ((m = reImg1.exec(text)) !== null) urls.push(m[1]);

              // HTML: <img ... src='...'>
              const reImg2 = /<img[^>]+src='([^']+)'[^>]*>/g;
              while ((m = reImg2.exec(text)) !== null) urls.push(m[1]);

              return uniq(urls);
            }

            const imageUrls = extractImageUrls(body);

            function buildDetails(urls) {
              if (!urls.length) return "ï¼ˆæ·»ä»˜ç”»åƒãªã—ï¼‰";
              return urls.map((u, i) => {
                const n = i + 1;
                return [
                  `<details>`,
                  `  <summary>ğŸ–¼ æ·»ä»˜ç”»åƒ ${n}ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹ãï¼ã‚‚ã†ä¸€åº¦ã§é–‰ã˜ã‚‹ï¼‰</summary>`,
                  `  <p><img src="${u}" width="520" alt="thumb-${n}"></p>`,
                  `  <p><img src="${u}" alt="full-${n}"></p>`,
                  `</details>`
                ].join("\n");
              }).join("\n\n");
            }

            const previewBlock = buildDetails(imageUrls);

            async function callOpenAI(promptText) {
              const apiKey = process.env.OPENAI_API_KEY;
              if (!apiKey) {
                return "ï¼ˆOPENAI_API_KEY ãŒæœªè¨­å®šãªã®ã§ã€å®šå‹è¿”ä¿¡ã ã‘å‡ºã—ã¾ã—ãŸï¼‰";
              }

              const model = (process.env.OPENAI_MODEL && process.env.OPENAI_MODEL.trim())
                ? process.env.OPENAI_MODEL.trim()
                : "gpt-5"; // ä¾‹ï¼šgpt-5 :contentReference[oaicite:2]{index=2}

              const res = await fetch("https://api.openai.com/v1/responses", { // :contentReference[oaicite:3]{index=3}
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                  model,
                  input: [
                    {
                      role: "user",
                      content: [{ type: "input_text", text: promptText }]
                    }
                  ]
                })
              });

              const data = await res.json().catch(() => ({}));
              if (!res.ok) {
                const msg = JSON.stringify(data).slice(0, 800);
                return `ï¼ˆLLMå‘¼ã³å‡ºã—ã«å¤±æ•—ï¼š${res.status}ï¼‰\n${msg}`;
              }

              // Prefer output_text if present, else extract from output array.
              let out = (data && data.output_text) ? String(data.output_text) : "";
              if (!out && data && Array.isArray(data.output)) {
                const parts = [];
                for (const item of data.output) {
                  if (!item || !Array.isArray(item.content)) continue;
                  for (const c of item.content) {
                    if (c && c.type === "output_text" && c.text) parts.push(c.text);
                  }
                }
                out = parts.join("\n");
              }

              out = (out || "").trim();
              return out || "ï¼ˆLLMã®è¿”ç­”ãŒç©ºã§ã—ãŸï¼‰";
            }

            const prompt = [
              "ã‚ãªãŸã¯ã€AIæˆ¦ç•¥ä¼šè­°å®¤ã€ã®ç§˜æ›¸ã§ã™ã€‚",
              "æ¬¡ã®Issueã‚’èª­ã¿ã€çŸ­ãè¦ç‚¹æ•´ç†ã—ã€æ¬¡ã®ä¸€æ‰‹ã‚’3ã¤ã«çµã£ã¦ææ¡ˆã—ã¦ãã ã•ã„ã€‚",
              "ç”»åƒãŒã‚ã‚‹å‰æã§ã€ç”»åƒã‹ã‚‰èª­ã¿å–ã‚Œã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹è¿½åŠ æƒ…å ±ã‚‚â€œç¢ºèªãƒã‚¤ãƒ³ãƒˆâ€ã¨ã—ã¦æ›¸ã„ã¦ãã ã•ã„ã€‚",
              "",
              `â–  ã‚¿ã‚¤ãƒˆãƒ«`,
              title,
              "",
              `â–  æœ¬æ–‡`,
              body || "ï¼ˆæœ¬æ–‡ãªã—ï¼‰",
              "",
              "å‡ºåŠ›ã®å½¢å¼ï¼š",
              "1) è¦æ—¨ï¼ˆ2ã€œ4è¡Œï¼‰",
              "2) ã„ã¾æ±ºã‚ã‚‹ã“ã¨ï¼ˆæœ€å¤§3ã¤ï¼‰",
              "3) æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæœ€å¤§3ã¤ã€çŸ­ã„æ‰‹é †ï¼‰",
              "4) ç¢ºèªãƒã‚¤ãƒ³ãƒˆï¼ˆç”»åƒã‚„çŠ¶æ³ã®è¿½åŠ ç¢ºèªï¼‰",
            ].join("\n");

            const llmText = await callOpenAI(prompt);

            const commentBody = [
              llmText,
              "",
              "---",
              "",
              "## æ·»ä»˜ç”»åƒï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰",
              "",
              previewBlock,
              "",
              "---",
              "",
              "âœ… **æ‰¿èª**ï¼šã“ã®Issueã®ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã« `/approve` ã¨æ›¸ã„ã¦ãã ã•ã„ã€‚",
            ].join("\n");

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: commentBody
            });

  approve:
    if: github.event_name == 'issue_comment' && startsWith(github.event.issue.title, '[TASK]') && contains(github.event.comment.body, '/approve')
    runs-on: ubuntu-latest
    steps:
      - name: Mark approved + comment
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            async function ensureLabel(name, color, description) {
              try {
                await github.rest.issues.getLabel({ owner, repo, name });
              } catch (e) {
                if (e.status === 404) {
                  await github.rest.issues.createLabel({ owner, repo, name, color, description });
                } else {
                  throw e;
                }
              }
            }

            await ensureLabel("approved", "2da44e", "Approved by owner (/approve)");

            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number,
              labels: ["approved"]
            });

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: "âœ… æ‰¿èªã‚’å—ã‘å–ã‚Šã¾ã—ãŸã€‚æ¬¡ã®å·¥ç¨‹ã«å›ã—ã¾ã™ï¼ˆå¿…è¦ãªã‚‰è¿½åŠ ã®ç¢ºèªã‚’æŠ•ã’ã¾ã™ï¼‰ã€‚"
            });
