name: Issue LLM Bot

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  llm_task:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issues' && github.event.issue.user.type != 'Bot') ||
      (github.event_name == 'issue_comment' && 
       github.event.comment.user.type != 'Bot' && 
       github.event.actor != 'github-actions[bot]' &&
       (contains(github.event.comment.body, '/approve') || 
        contains(github.event.comment.body, '/review') ||
        contains(github.event.comment.body, '/check')))
    outputs:
      check_result: ${{ steps.check.outputs.check_result }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Generate Bot Response
        id: generate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Issueæƒ…å ±ã‚’å–å¾—ï¼ˆissues ã‚¤ãƒ™ãƒ³ãƒˆã¨ issue_comment ã‚¤ãƒ™ãƒ³ãƒˆã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_BODY="${{ github.event.issue.body }}"
            COMMENT_BODY="${{ github.event.comment.body }}"
            PROMPT_TEXT="Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}

${ISSUE_BODY}

ã‚³ãƒ¡ãƒ³ãƒˆ: ${COMMENT_BODY}

ä¸Šè¨˜ã®Issueã¨ã‚³ãƒ¡ãƒ³ãƒˆã«å¯¾ã—ã¦ã€é©åˆ‡ãªå›ç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚"
          else
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_BODY="${{ github.event.issue.body }}"
            PROMPT_TEXT="Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}

${ISSUE_BODY}

ä¸Šè¨˜ã®Issueã«å¯¾ã—ã¦ã€é©åˆ‡ãªå›ç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚"
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’JSONã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
          PROMPT_JSON=$(echo "$PROMPT_TEXT" | jq -Rs .)
          
          # OpenAI Responses APIã‚’å‘¼ã³å‡ºã—
          OPENAI_JSON=$(curl -s -X POST https://api.openai.com/v1/responses \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"gpt-4o\",
              \"input\": ${PROMPT_JSON}
            }")
          
          # OpenAI Responses APIä»•æ§˜ã«åˆã‚ã›ã¦æœ¬æ–‡ã‚’æŠ½å‡º
          # .output_text ãŒç›´æ¥å­˜åœ¨ã™ã‚‹å ´åˆã€ã¾ãŸã¯ .output[].content[].text(type=output_text) ã‚’é€£çµ
          AI_TEXT=$(echo "$OPENAI_JSON" | jq -r '
            if .output_text then
              .output_text
            else
              ([.output[]? 
                | select(.type=="message") 
                | .content[]? 
                | select(.type=="output_text") 
                | .text] | join("\n"))
            end
          ' || echo "")
          
          # ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
          if [ -z "$AI_TEXT" ] || [ "$AI_TEXT" = "null" ]; then
            echo "::error::OpenAI API response parsing failed"
            echo "Response: $OPENAI_JSON"
            exit 1
          fi
          
          COMMENT_BODY="$AI_TEXT"
          
          echo "commentBody<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMENT_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Self-Check Image Links
        id: check
        run: |
          COMMENT_BODY="${{ steps.generate.outputs.commentBody }}"
          
          # NGæ¡ä»¶ãƒã‚§ãƒƒã‚¯
          NG_DETECTED=false
          CHECK_RESULT="PASS"
          
          # NGæ¡ä»¶ a: <a ã‚¿ã‚°ã§ç”»åƒURLã«ãƒªãƒ³ã‚¯ã—ã¦ã„ã‚‹
          # ç”»åƒURLã®ãƒ‘ã‚¿ãƒ¼ãƒ³: private-user-images.githubusercontent.com, user-images.githubusercontent.com ãªã©
          if echo "$COMMENT_BODY" | grep -qiE '<a[^>]*href=["'"'"']?https?://[^"'"'"' ]*(private-user-images|user-images|githubusercontent\.com)'; then
            NG_DETECTED=true
            CHECK_RESULT="FAIL"
            echo "::error::NG detected: <a tag linking to image URL"
          fi
          
          # NGæ¡ä»¶ b: Markdownç”»åƒãƒªãƒ³ã‚¯ãŒæ®‹ã£ã¦ã„ã‚‹ï¼ˆ![ ã¨ ]( ã®çµ„ã¿åˆã‚ã›ï¼‰
          if echo "$COMMENT_BODY" | grep -qE '!\[[^\]]*\]\('; then
            NG_DETECTED=true
            CHECK_RESULT="FAIL"
            echo "::error::NG detected: Markdown image link syntax (![ ... ](...)) found"
          fi
          
          # è‡ªå·±åˆ¤å®šçµæœã‚’å…ˆé ­ã«è¿½åŠ 
          if [ "$NG_DETECTED" = "true" ]; then
            FINAL_BODY="SELF-CHECK: image_link=YES (FAIL)

$COMMENT_BODY"
            echo "Self-check result: FAIL"
          else
            FINAL_BODY="SELF-CHECK: image_link=NO (PASS)

$COMMENT_BODY"
            echo "Self-check result: PASS"
          fi
          
          echo "checkResult=$CHECK_RESULT" >> $GITHUB_OUTPUT
          echo "check_result=$CHECK_RESULT" >> $GITHUB_OUTPUT
          echo "finalBody<<EOF" >> $GITHUB_OUTPUT
          echo "$FINAL_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # NGãªã‚‰ã‚¸ãƒ§ãƒ–ã‚’å¤±æ•—ï¼ˆcore.setFailedç›¸å½“ï¼‰
          if [ "$NG_DETECTED" = "true" ]; then
            echo "::error::IMAGE_LINK_DETECTED"
            exit 1
          fi

      - name: Post Comment
        if: steps.check.outputs.checkResult == 'PASS'
        uses: actions/github-script@v7
        with:
          script: |
            // issues ã‚¤ãƒ™ãƒ³ãƒˆã¨ issue_comment ã‚¤ãƒ™ãƒ³ãƒˆã®ä¸¡æ–¹ã«å¯¾å¿œ
            const issue_number = context.payload.issue?.number || context.issue?.number;
            if (issue_number) {
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number,
                body: `${{ steps.check.outputs.finalBody }}`
              });
            }

      - name: Notify Result
        if: always()
        run: |
          echo "::notice::Action run result=${{ job.status }}"

  notify:
    needs: [llm_task]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            // issues ã‚¤ãƒ™ãƒ³ãƒˆã¨ issue_comment ã‚¤ãƒ™ãƒ³ãƒˆã®ä¸¡æ–¹ã«å¯¾å¿œ
            const issue_number = context.payload.issue?.number || context.issue?.number;
            const jobResult = '${{ needs.llm_task.result }}'; // success / failure / cancelled
            const selfCheck = '${{ needs.llm_task.outputs.check_result }}' || 'UNKNOWN';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const body =
              `ğŸ§¾ Issue LLM Bot çµæœ\n` +
              `- job: ${jobResult}\n` +
              `- self-check: ${selfCheck}\n` +
              `- run: ${runUrl}\n`;
            if (issue_number) {
              await github.rest.issues.createComment({ 
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number,
                body: body
              });
            }

