name: Issue LLM Bot

on:
  issues:
    types: [opened, reopened, edited]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

concurrency:
  group: issue-llm-bot-${{ github.event.issue.number || github.event.comment.issue_url }}
  cancel-in-progress: true

jobs:
  auto_reply_task:
    name: Auto reply (TASK)
    if: github.event_name == 'issues' && startsWith(github.event.issue.title, '[TASK]')
    runs-on: ubuntu-latest
    steps:
      - name: Post auto reply (TASK)
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-4.1-mini
        with:
          script: |
            const issue = context.payload.issue;
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            const bodyText = (issue.body || "").trim();
            const apiKey = (process.env.OPENAI_API_KEY || "").trim();
            const model  = (process.env.OPENAI_MODEL || "gpt-4.1-mini").trim();

            function extractImageUrls(text) {
              const urls = new Set();

              // Markdown: ![alt](url)
              const mdRe = /!\[[^\]]*\]\(([^)\s]+)(?:\s+"[^"]*")?\)/g;
              let m;
              while ((m = mdRe.exec(text)) !== null) urls.add(m[1]);

              // HTML: <img ... src="url" ...>
              const htmlRe = /<img[^>]+src=["']([^"']+)["'][^>]*>/gi;
              while ((m = htmlRe.exec(text)) !== null) urls.add(m[1]);

              // Raw URL lines (attachments)
              const rawRe = /(https?:\/\/[^\s)]+(?:png|jpg|jpeg|gif|webp))/gi;
              while ((m = rawRe.exec(text)) !== null) urls.add(m[1]);

              return Array.from(urls);
            }

            function buildImageDetails(urls) {
              if (!urls.length) return "";
              const blocks = urls.map((url, i) => {
                const n = i + 1;
                return [
                  `<details>`,
                  `  <summary>ğŸ–¼ æ·»ä»˜ç”»åƒ ${n}ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹ãï¼ã‚‚ã†ä¸€åº¦ã§é–‰ã˜ã‚‹ï¼‰</summary>`,
                  `  <p><img src="${url}" width="260" alt="thumb-${n}"></p>`,
                  `  <p><img src="${url}" width="900" alt="full-${n}"></p>`,
                  `</details>`
                ].join("\n");
              });
              return `\n\n---\n\n## æ·»ä»˜ç”»åƒï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰\n\n` + blocks.join("\n\n");
            }

            function nowJst() {
              const d = new Date();
              // GitHub runner is UTC; convert display to JST (+9)
              const j = new Date(d.getTime() + 9 * 60 * 60 * 1000);
              const pad = (x) => String(x).padStart(2, "0");
              return `${j.getUTCFullYear()}-${pad(j.getUTCMonth()+1)}-${pad(j.getUTCDate())} ${pad(j.getUTCHours())}:${pad(j.getUTCMinutes())} JST`;
            }

            const imageUrls = extractImageUrls(bodyText);
            const imageSection = buildImageDetails(imageUrls);

            // If key is missing, post a friendly but clear error (no PENAI_* mention)
            if (!apiKey) {
              const msg = [
                `## Botè¿”ä¿¡ï¼ˆTASKï¼‰`,
                ``,
                `è¦æ—¨`,
                `- Botå´ã§AIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆSecretsæœªè¨­å®šï¼‰`,
                ``,
                `æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ1ã¤ã ã‘ï¼‰`,
                `- GitHub â†’ Settings â†’ Secrets and variables â†’ Actions â†’ Repository secrets ã« **OPENAI_API_KEY** ãŒã‚ã‚‹ã‹ç¢ºèª`,
                ``,
                `æ‰‹é †ï¼ˆStep 1â†’ï¼‰`,
                `Step 1ï¼šRepository secrets ã« **OPENAI_API_KEY** ã‚’è¿½åŠ ï¼ˆã¾ãŸã¯æ›´æ–°ï¼‰`,
                ``,
                `ï¼ˆå†…éƒ¨ã‚¨ãƒ©ãƒ¼ï¼‰OPENAI_API_KEY is missing`,
                ``,
                `---`,
                `build: ${nowJst()}`
              ].join("\n");
              await github.rest.issues.createComment({
                owner, repo,
                issue_number: issue.number,
                body: msg + imageSection
              });
              return;
            }

            async function callOpenAI(prompt) {
              const res = await fetch("https://api.openai.com/v1/responses", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${apiKey}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model,
                  input: [
                    {
                      role: "user",
                      content: [
                        { type: "input_text", text: prompt }
                      ]
                    }
                  ]
                })
              });

              const txt = await res.text();
              if (!res.ok) {
                throw new Error(`OpenAI HTTP ${res.status}: ${txt.slice(0, 500)}`);
              }
              const data = JSON.parse(txt);
              // Prefer output_text if available
              const out = (data.output_text || "").trim();
              if (out) return out;

              // Fallback: try to reconstruct
              try {
                const parts = [];
                for (const o of (data.output || [])) {
                  for (const c of (o.content || [])) {
                    if (c.type === "output_text" && c.text) parts.push(c.text);
                  }
                }
                return parts.join("\n").trim();
              } catch {
                return "";
              }
            }

            const prompt = [
              `ã‚ãªãŸã¯GitHub Issueã®å—ä»˜ä¿‚ã§ã™ã€‚æ—¥æœ¬èªã§ã€çŸ­ãã€å®Ÿå‹™çš„ã«è¿”ã—ã¦ãã ã•ã„ã€‚`,
              `æ¬¡ã®æ§‹æˆã§å‡ºåŠ›ï¼š`,
              `- è¦æ—¨ï¼ˆ1ã€œ2è¡Œï¼‰`,
              `- æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ1ã¤ã ã‘ï¼‰`,
              `- æ‰‹é †ï¼ˆStep 1â†’ï¼‰ã‚’æœ€å¤§3ã‚¹ãƒ†ãƒƒãƒ—`,
              `- ã†ã¾ãã„ã‹ãªã„æ™‚ï¼ˆ1ã€œ2è¡Œï¼‰`,
              `- æ³¨æ„ç‚¹ï¼ˆç®‡æ¡æ›¸ã2ã¤ã¾ã§ï¼‰`,
              ``,
              `å‰æï¼šç”»åƒã¯æœ¬æ–‡ã«è²¼ã‚‰ã‚Œã¦ã„ã‚‹ãŒã€AIã¯ç”»åƒå†…å®¹ã‚’ç›´æ¥èª­ã‚ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚ç”»åƒãŒã‚ã‚‹å ´åˆã¯ã€Œç”»åƒã®ã©ã“ã‚’è¦‹ã¦ã»ã—ã„ã‹ã€ã‚’1è¡Œã ã‘è¿½åŠ è³ªå•ã—ã¦ã‚ˆã„ã€‚`,
              ``,
              `Issueã‚¿ã‚¤ãƒˆãƒ«ï¼š${issue.title}`,
              `Issueæœ¬æ–‡ï¼š`,
              `${bodyText || "ï¼ˆæœ¬æ–‡ãªã—ï¼‰"}`
            ].join("\n");

            let aiReply = "";
            try {
              aiReply = await callOpenAI(prompt);
            } catch (e) {
              aiReply = [
                `## Botè¿”ä¿¡ï¼ˆTASKï¼‰`,
                ``,
                `è¦æ—¨`,
                `- Botå´ã§AIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`,
                ``,
                `æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ1ã¤ã ã‘ï¼‰`,
                `- Actions ã®è©²å½“Run â†’ Logs ã‚’é–‹ãã€ã„ã¡ã°ã‚“ä¸‹ã®èµ¤ã„è¡Œã‚’ã“ã®Issueã«è²¼ã£ã¦ãã ã•ã„ã€‚`,
                ``,
                `ï¼ˆå†…éƒ¨ã‚¨ãƒ©ãƒ¼ï¼‰${String(e.message || e)}`
              ].join("\n");
            }

            const finalBody = [
              `## Botè¿”ä¿¡ï¼ˆTASKï¼‰`,
              ``,
              aiReply,
              ``,
              `---`,
              `build: ${nowJst()}`
            ].join("\n");

            await github.rest.issues.createComment({
              owner, repo,
              issue_number: issue.number,
              body: finalBody + imageSection
            });

  approve_task:
    name: Approve (TASK)
    if: github.event_name == 'issue_comment'
    runs-on: ubuntu-latest
    steps:
      - name: Handle /approve
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-4.1-mini
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            const comment = context.payload.comment;
            const issue   = context.payload.issue;

            // avoid loops
            const login = (comment.user && comment.user.login) ? comment.user.login : "";
            if (login.includes("github-actions")) return;

            const text = (comment.body || "").trim();
            if (!text.includes("/approve")) return;
            if (!issue || !issue.title || !issue.title.startsWith("[TASK]")) return;

            const apiKey = (process.env.OPENAI_API_KEY || "").trim();
            const model  = (process.env.OPENAI_MODEL || "gpt-4.1-mini").trim();

            function nowJst() {
              const d = new Date();
              const j = new Date(d.getTime() + 9 * 60 * 60 * 1000);
              const pad = (x) => String(x).padStart(2, "0");
              return `${j.getUTCFullYear()}-${pad(j.getUTCMonth()+1)}-${pad(j.getUTCDate())} ${pad(j.getUTCHours())}:${pad(j.getUTCMinutes())} JST`;
            }

            if (!apiKey) {
              const msg = [
                `## æ‰¿èªï¼ˆ/approveï¼‰`,
                ``,
                `æ‰¿èªã¯å—ã‘å–ã‚Šã¾ã—ãŸã€‚`,
                `ãŸã ã— Botå´ã®AIå‘¼ã³å‡ºã—ãŒã§ãã¾ã›ã‚“ï¼ˆSecretsæœªè¨­å®šï¼‰ã€‚`,
                ``,
                `ï¼ˆå†…éƒ¨ã‚¨ãƒ©ãƒ¼ï¼‰OPENAI_API_KEY is missing`,
                ``,
                `---`,
                `build: ${nowJst()}`
              ].join("\n");
              await github.rest.issues.createComment({ owner, repo, issue_number: issue.number, body: msg });
              return;
            }

            async function callOpenAI(prompt) {
              const res = await fetch("https://api.openai.com/v1/responses", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${apiKey}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model,
                  input: [{ role: "user", content: [{ type: "input_text", text: prompt }] }]
                })
              });
              const txt = await res.text();
              if (!res.ok) throw new Error(`OpenAI HTTP ${res.status}: ${txt.slice(0, 500)}`);
              const data = JSON.parse(txt);
              return (data.output_text || "").trim();
            }

            const prompt = [
              `ã‚ãªãŸã¯GitHub Issueã®é€²è¡Œä¿‚ã§ã™ã€‚æ—¥æœ¬èªã§çŸ­ãè¿”ã—ã¦ãã ã•ã„ã€‚`,
              `ã“ã®Issueã‚’ã€Œæ¬¡ã«é€²ã‚ã‚‹ã€ãŸã‚ã®ã€1ã¤ã ã‘ã®æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚`,
              `å¿…è¦ãªã‚‰ã€ç¢ºèªè³ªå•ã¯1ã¤ã ã‘ã€‚`,
              ``,
              `Issueã‚¿ã‚¤ãƒˆãƒ«ï¼š${issue.title}`,
              `Issueæœ¬æ–‡ï¼š`,
              `${(issue.body || "").trim() || "ï¼ˆæœ¬æ–‡ãªã—ï¼‰"}`
            ].join("\n");

            let out = "";
            try {
              out = await callOpenAI(prompt);
            } catch (e) {
              out = `ï¼ˆå†…éƒ¨ã‚¨ãƒ©ãƒ¼ï¼‰${String(e.message || e)}`;
            }

            const msg = [
              `## æ‰¿èªï¼ˆ/approveï¼‰`,
              ``,
              out || `æ¬¡ã«é€²ã‚ã¾ã™ã€‚ã¾ãšã€Œç›®çš„ï¼ˆ1è¡Œï¼‰ã€ã ã‘ã‚³ãƒ¡ãƒ³ãƒˆã§ãã ã•ã„ã€‚`,
              ``,
              `---`,
              `build: ${nowJst()}`
            ].join("\n");

            await github.rest.issues.createComment({ owner, repo, issue_number: issue.number, body: msg });
