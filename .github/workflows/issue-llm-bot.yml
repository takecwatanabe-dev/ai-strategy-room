# .github/workflows/issue-llm-bot.yml
# Version: v0.3.0
# Build(JST): 2025-12-14 15:13
# Changes:
# - Secretsåã‚’ OPENAI_API_KEY / PENAI_API_KEY ã®ã©ã¡ã‚‰ã§ã‚‚OKã«ï¼ˆ|| ã§å¸åï¼‰
# - æ·»ä»˜ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ <details><summary>â€¦</summary>â€¦</details> ã«çµ±ä¸€
# - "No response" ã‚’æœ¬æ–‡ã¨ã—ã¦æ‰±ã„ã«ãã„ã®ã§ã€LLMå…¥åŠ›ã‹ã‚‰ã¯é™¤å¤–
# - /approve ã‚³ãƒ¡ãƒ³ãƒˆã«åå¿œã™ã‚‹è»½ã„ã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ ï¼ˆä»»æ„é‹ç”¨ï¼‰

name: Issue LLM Bot

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  task_auto_reply:
    if: >-
      github.event_name == 'issues' &&
      startsWith(github.event.issue.title, '[TASK]')
    runs-on: ubuntu-latest
    steps:
      - name: Post auto reply (TASK)
        uses: actions/github-script@v7
        env:
          # Secretsåã®æºã‚Œã‚’å¸åï¼ˆã©ã£ã¡ã§ã‚‚OKï¼‰
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || secrets.PENAI_API_KEY }}
          OPENAI_MODEL: gpt-5-mini
        with:
          script: |
            const issue = context.payload.issue;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = issue.number;

            const apiKey = process.env.OPENAI_API_KEY;
            const model = process.env.OPENAI_MODEL || "gpt-5-mini";

            const stripNoResponse = (text) => {
              if (!text) return "";
              return text
                .split("\n")
                .filter(line => line.trim() !== "No response")
                .join("\n")
                .trim();
            };

            function extractImageUrls(text) {
              const urls = new Set();
              if (!text) return [];
              // Markdown: ![alt](url)
              const mdRe = /!\[[^\]]*\]\((https?:\/\/[^\s)]+)\)/g;
              // HTML: <img ... src="url" ...>
              const imgRe = /<img[^>]*\ssrc="([^"]+)"/gi;

              let m;
              while ((m = mdRe.exec(text)) !== null) urls.add(m[1]);
              while ((m = imgRe.exec(text)) !== null) urls.add(m[1]);

              return Array.from(urls);
            }

            function renderImagePreview(urls) {
              if (!urls || urls.length === 0) return "";
              const blocks = urls.map((u, i) => {
                const n = i + 1;
                // GitHubä¸Šã§ã€Œåˆ¥ã‚¿ãƒ–ã€ã‚’å¼·åˆ¶ã—ãªã„è¡¨ç¤ºï¼šdetailså†…ã«è¡¨ç¤º
                // â€»ã‚¯ãƒªãƒƒã‚¯ã™ã‚Œã°åˆ¥ã‚¿ãƒ–ã«ãªã‚‹ã“ã¨ã¯ã‚ã‚‹ã‘ã©ã€åŸºæœ¬ã¯ã€Œé–‹ãï¼å±•é–‹ã€ã§æ¸ˆã‚€
                return [
                  `<details>`,
                  `<summary>ğŸ–¼ æ·»ä»˜ç”»åƒ${n}ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹ãï¼ã‚‚ã†ä¸€åº¦ã§é–‰ã˜ã‚‹ï¼‰</summary>`,
                  `<p><img src="${u}" width="780" alt="image${n}"></p>`,
                  `</details>`
                ].join("\n");
              }).join("\n\n");

              return `\n\n---\n\n## æ·»ä»˜ç”»åƒï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰\n\n${blocks}\n`;
            }

            async function callOpenAI(promptText) {
              const resp = await fetch("https://api.openai.com/v1/responses", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                  model,
                  input: promptText,
                  max_output_tokens: 700
                })
              });

              const data = await resp.json().catch(() => ({}));
              if (!resp.ok) {
                const msg = data?.error?.message || `HTTP ${resp.status}`;
                throw new Error(msg);
              }

              // Responses API ã®å‡ºåŠ›ã‚’ã§ãã‚‹ã ã‘é ‘ä¸ˆã«å›å
              const out = [];
              for (const item of (data.output || [])) {
                for (const c of (item.content || [])) {
                  if (typeof c.text === "string") out.push(c.text);
                }
              }
              return out.join("\n").trim();
            }

            const rawBody = issue.body || "";
            const bodyForLLM = stripNoResponse(rawBody);
            const imageUrls = extractImageUrls(rawBody);

            // APIã‚­ãƒ¼ãŒç„¡ã„ï¼ˆï¼SecretsãŒè¦‹ãˆã¦ãªã„/åå‰é•ã„ï¼‰ãªã‚‰ã€ã“ã“ã§ç¢ºå®šã§æ¡ˆå†…ã‚³ãƒ¡ãƒ³ãƒˆ
            if (!apiKey) {
              const msg = [
                `## è¦æ—¨`,
                `Botå´ã§ OpenAI API ã‚’å‘¼ã³å‡ºã›ã¾ã›ã‚“ã§ã—ãŸï¼ˆSecretsæœªè¨­å®šæ‰±ã„ï¼‰ã€‚`,
                ``,
                `### æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³`,
                `GitHub â†’ Settings â†’ Secrets and variables â†’ Actions â†’ Repository secrets ã« **OPENAI_API_KEY**ï¼ˆæ¨å¥¨ï¼‰ã¾ãŸã¯ **PENAI_API_KEY** ãŒå…¥ã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`,
                ``,
                `ï¼ˆâ€»ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ OPENAI_API_KEY / PENAI_API_KEY ã®ä¸¡æ–¹ã«å¯¾å¿œã—ã¦ã„ã¾ã™ï¼‰`,
                renderImagePreview(imageUrls)
              ].join("\n");

              await github.rest.issues.createComment({
                owner, repo, issue_number,
                body: msg
              });
              return;
            }

            const prompt = [
              `ã‚ãªãŸã¯GitHub Issueã®ä¸€æ¬¡æ•´ç†ã‚’ã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚`,
              `æ—¥æœ¬èªã§ã€çŸ­ãã€å®Ÿå‹™çš„ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚`,
              `å‡ºåŠ›ã¯å¿…ãšMarkdownã§ã€è¦‹å‡ºã—ã¯ã“ã®3ã¤ã ã‘ï¼š`,
              `### è¦æ—¨`,
              `### æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ1ã¤ã ã‘ï¼‰`,
              `### ã†ã¾ãã„ã‹ãªã„æ™‚`,
              ``,
              `ã€Issueã‚¿ã‚¤ãƒˆãƒ«ã€‘`,
              issue.title,
              ``,
              `ã€Issueæœ¬æ–‡ã€‘`,
              bodyForLLM || "ï¼ˆæœ¬æ–‡ãªã—ï¼‰",
              ``,
              `æ³¨æ„ï¼šæ·»ä»˜ç”»åƒã¯ä¸‹ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä»˜ã‘ã‚‹ã®ã§ã€ç”»åƒã®ä¸­èº«è§£æã¯ä¸è¦ã€‚`
            ].join("\n");

            let aiText = "";
            try {
              aiText = await callOpenAI(prompt);
              if (!aiText) aiText = "### è¦æ—¨\nï¼ˆç©ºã®å¿œç­”ã§ã—ãŸï¼‰\n\n### æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ1ã¤ã ã‘ï¼‰\næœ¬æ–‡ã‚’1è¡Œã ã‘ã§ã‚‚æ›¸ã„ã¦å†æŠ•ç¨¿\n\n### ã†ã¾ãã„ã‹ãªã„æ™‚\nã‚‚ã†ä¸€åº¦ Reopen ã—ã¦å†å®Ÿè¡Œ";
            } catch (e) {
              aiText = [
                `### è¦æ—¨`,
                `Botå´ã®APIå‘¼ã³å‡ºã—ã§å¤±æ•—ã—ã¾ã—ãŸã€‚`,
                ``,
                `### æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ1ã¤ã ã‘ï¼‰`,
                `Actions ã®ãƒ­ã‚°ã‚’é–‹ã„ã¦ã€å¤±æ•—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆHTTPã‚³ãƒ¼ãƒ‰ã‚„æœ¬æ–‡ï¼‰ã‚’è²¼ã£ã¦ãã ã•ã„ã€‚`,
                ``,
                `### ã†ã¾ãã„ã‹ãªã„æ™‚`,
                `Secretsåï¼ˆOPENAI_API_KEY / PENAI_API_KEYï¼‰ã®ç¶´ã‚Šãƒ»ä½™åˆ†ãªç©ºç™½ãƒ»æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`,
                ``,
                `ï¼ˆã‚¨ãƒ©ãƒ¼ï¼š${String(e.message || e)}ï¼‰`
              ].join("\n");
            }

            const footer = `\n\n---\n\næ‰¿èªã—ã¦æ¬¡ã¸é€²ã‚ã‚‹ã¨ãã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã« \`/approve\` ã¨æ›¸ã„ã¦ãã ã•ã„ã€‚`;
            const commentBody = `## Botè¿”ä¿¡ï¼ˆTASKï¼‰\n\n${aiText}${renderImagePreview(imageUrls)}${footer}`;

            await github.rest.issues.createComment({
              owner, repo, issue_number,
              body: commentBody
            });

  task_on_approve:
    if: >-
      github.event_name == 'issue_comment' &&
      startsWith(github.event.issue.title, '[TASK]') &&
      contains(github.event.comment.body, '/approve') &&
      github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Ack approve
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            // ãƒ©ãƒ™ãƒ«ã¯å­˜åœ¨ã—ãªã„ã¨å¤±æ•—ã™ã‚‹ã®ã§ã€å¤±æ•—ã—ã¦ã‚‚ç„¡è¦–
            try {
              await github.rest.issues.addLabels({
                owner, repo, issue_number,
                labels: ["approved"]
              });
            } catch (e) {}

            await github.rest.issues.createComment({
              owner, repo, issue_number,
              body: [
                `äº†è§£ã€‚/approve ã‚’å—ã‘å–ã‚Šã¾ã—ãŸã€‚`,
                ``,
                `æ¬¡ã®ä½œæ¥­ã«é€²ã‚ã¾ã™ï¼ˆå¿…è¦ãªã‚‰ã€ã‚„ã‚ŠãŸã„å†…å®¹ã‚’1è¡Œã ã‘è¿½è¨˜ã—ã¦ã­ï¼‰ã€‚`
              ].join("\n")
            });
