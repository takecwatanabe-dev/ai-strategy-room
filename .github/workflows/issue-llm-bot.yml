# ISSUE LLM BOT â€” v0.4.0
# Build: 2025-12-14 15:00 JST
# Changes:
# - Secretså‚ç…§ã‚ºãƒ¬å¯¾ç­–ï¼ˆOPENAI_API_KEY / PENAI_API_KEY ã©ã¡ã‚‰ã§ã‚‚OKï¼‰
# - æ·»ä»˜ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ <details><summary> ã§æŠ˜ã‚ŠãŸãŸã¿è¡¨ç¤ºï¼ˆåˆ¥ã‚¿ãƒ–å›é¿ï¼‰
# - /approve ã‚³ãƒ¡ãƒ³ãƒˆã«åå¿œã—ã¦å—ä»˜ã‚³ãƒ¡ãƒ³ãƒˆ

name: Issue LLM Bot

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read

jobs:
  task_auto_reply:
    if: github.event_name == 'issues' && startsWith(github.event.issue.title, '[TASK]')
    runs-on: ubuntu-latest
    steps:
      - name: Post auto reply (TASK)
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PENAI_API_KEY: ${{ secrets.PENAI_API_KEY }}
          OPENAI_MODEL: gpt-5-mini
        with:
          script: |
            const issue = context.payload.issue;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const apiKey = process.env.OPENAI_API_KEY || process.env.PENAI_API_KEY;

            function extractImageUrls(text) {
              const urls = new Set();
              if (!text) return [];

              // Markdown: ![alt](url)
              const md = /!\[[^\]]*]\(([^)]+)\)/g;
              let m;
              while ((m = md.exec(text)) !== null) urls.add(m[1]);

              // HTML: <img ... src="...">
              const html = /<img[^>]+src="([^"]+)"[^>]*>/gi;
              while ((m = html.exec(text)) !== null) urls.add(m[1]);

              // Plain URLï¼ˆGitHub attachmentsï¼‰
              const plain = /(https?:\/\/[^\s)"]+)/g;
              while ((m = plain.exec(text)) !== null) {
                const u = m[1];
                if (
                  u.includes('github.com/user-attachments/assets') ||
                  u.includes('user-images.githubusercontent.com') ||
                  u.includes('private-user-images.githubusercontent.com')
                ) {
                  urls.add(u);
                }
              }
              return Array.from(urls);
            }

            function renderImageDetails(urls) {
              if (!urls.length) return '';
              const blocks = urls.map((u, idx) => {
                return [
                  `<details>`,
                  `  <summary>ğŸ–¼ æ·»ä»˜ç”»åƒ ${idx + 1}ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹ãï¼ã‚‚ã†ä¸€åº¦ã§é–‰ã˜ã‚‹ï¼‰</summary>`,
                  `  <p><img src="${u}" width="520" alt="thumb"></p>`,
                  `  <p><img src="${u}" alt="full"></p>`,
                  `</details>`
                ].join('\n');
              });

              return `\n\n---\n\n## æ·»ä»˜ç”»åƒï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰\n\n${blocks.join('\n\n')}\n`;
            }

            const imageUrls = extractImageUrls(issue.body || '');
            const preview = renderImageDetails(imageUrls);

            let aiText = '';

            if (!apiKey) {
              aiText = [
                '## è¦æ—¨',
                'Botå´ã§APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚',
                '',
                '## æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³',
                '- Secretsï¼ˆOPENAI_API_KEY ã¾ãŸã¯ PENAI_API_KEYï¼‰ãŒå…¥ã£ã¦ã„ã‚‹ã‹ç¢ºèªã€‚',
                '',
                'æ‰¿èªã—ã¦æ¬¡ã¸é€²ã‚ã‚‹ã¨ãã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã« `/approve` ã¨æ›¸ã„ã¦ãã ã•ã„ã€‚'
              ].join('\n');
            } else {
              const model = process.env.OPENAI_MODEL || 'gpt-5-mini';

              const prompt = [
                'ã‚ãªãŸã¯ã€ŒAIæˆ¦ç•¥ä¼šè­°å®¤ã€ã®é‹ç”¨æ”¯æ´Botã§ã™ã€‚',
                'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Issueæœ¬æ–‡ã‹ã‚‰ã€(1)è¦æ—¨ã€(2)æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³(æœ€å¤§3ã¤ã€1è¡Œãšã¤)ã€(3)ã†ã¾ãã„ã‹ãªã„æ™‚ã®åˆ†å²(A/B) ã‚’æ—¥æœ¬èªã§è¿”ã—ã¦ãã ã•ã„ã€‚',
                'ä½™è¨ˆãªå‰ç½®ãã¯ä¸è¦ã€‚Markdownã§è¦‹å‡ºã—ã‚’ä»˜ã‘ã‚‹ã€‚',
                '',
                'Issueæœ¬æ–‡:',
                issue.body || ''
              ].join('\n');

              const res = await fetch('https://api.openai.com/v1/responses', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                  model,
                  input: prompt
                })
              });

              if (!res.ok) {
                const t = await res.text();
                aiText = [
                  '## è¦æ—¨',
                  'Botå´ã§APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚',
                  '',
                  '### ã‚¨ãƒ©ãƒ¼',
                  `Status: ${res.status}`,
                  '',
                  'æ‰¿èªã—ã¦æ¬¡ã¸é€²ã‚ã‚‹ã¨ãã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã« `/approve` ã¨æ›¸ã„ã¦ãã ã•ã„ã€‚'
                ].join('\n');
                aiText += `\n\n<details><summary>ãƒ­ã‚°</summary>\n\n\`\`\`\n${t.slice(0, 4000)}\n\`\`\`\n</details>`;
              } else {
                const data = await res.json();
                const out = (data.output_text || '').trim();
                aiText = out || 'ï¼ˆç©ºã®å¿œç­”ã§ã—ãŸï¼‰';
                aiText += '\n\n---\n\næ‰¿èªã—ã¦æ¬¡ã¸é€²ã‚ã‚‹ã¨ãã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã« `/approve` ã¨æ›¸ã„ã¦ãã ã•ã„ã€‚';
              }
            }

            const body = `${aiText}${preview}`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issue.number,
              body
            });

  task_approve:
    if: github.event_name == 'issue_comment' && startsWith(github.event.issue.title, '[TASK]') && contains(github.event.comment.body, '/approve')
    runs-on: ubuntu-latest
    steps:
      - name: Ack approve
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue = context.payload.issue;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issue.number,
              body: 'âœ… /approve ã‚’å—ã‘å–ã‚Šã¾ã—ãŸã€‚æ¬¡ã®ä½œæ¥­ã«é€²ã‚ã¾ã™ã€‚'
            });
