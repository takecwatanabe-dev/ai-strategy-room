# Issue LLM Bot â€” v0.1.0
# Build: 2025-12-16 17:33 JST
# Changes:
# - /check /approve ã‚³ãƒ¡ãƒ³ãƒˆã€Œãã®ã‚³ãƒ¡ãƒ³ãƒˆå†…ã€ã®ç”»åƒã ã‘ã‚’æ‹¾ã£ã¦ <details> ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
# - ç”»åƒ0ä»¶ãªã‚‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ ã‚’å‡ºã•ãªã„
# - å¤–éƒ¨apt/jqãªã—ï¼ˆå¤±æ•—ã—ã«ãã„æ§‹æˆï¼‰
# - OPENAI_API_KEY ãŒç„¡ã„/å¤±æ•—ã—ã¦ã‚‚ã€æœ€ä½é™ã®è¿”ä¿¡ã¯è¿”ã™

name: Issue LLM Bot

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]

permissions:
  contents: read
  issues: write

jobs:
  bot:
    runs-on: ubuntu-latest
    if: |
      github.event.sender.type != 'Bot' &&
      github.actor != 'github-actions[bot]' &&
      (
        (github.event_name == 'issues' && startsWith(github.event.issue.title, '[TASK]')) ||
        (github.event_name == 'issue_comment' && (
          contains(github.event.comment.body, '/check') ||
          contains(github.event.comment.body, '/approve') ||
          contains(github.event.comment.body, '/review')
        ))
      )

    steps:
      - name: Compose & Post Comment
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            const isIssue = context.eventName === 'issues';
            const issue = context.payload.issue;
            const comment = context.payload.comment;

            const issueNumber = issue.number;
            const issueTitle  = issue.title || '';
            const issueBody   = issue.body || '';
            const commentBody = comment?.body || '';

            // -----------------------------
            // ç”»åƒæŠ½å‡ºï¼ˆã€Œãã®ã‚³ãƒ¡ãƒ³ãƒˆã€ã ã‘ï¼‰
            // -----------------------------
            let images = [];
            if (!isIssue) {
              // Markdown: ![alt](url)
              const mdRe = /!\[[^\]]*\]\((https?:\/\/[^\s)]+)\)/g;
              // HTML: <img src="url">
              const htmlRe = /<img[^>]+src=["'](https?:\/\/[^"']+)["'][^>]*>/gi;

              let m;
              while ((m = mdRe.exec(commentBody)) !== null) images.push(m[1]);
              while ((m = htmlRe.exec(commentBody)) !== null) images.push(m[1]);
            }

            // é‡è¤‡æ’é™¤
            images = [...new Set(images)];

            const makePreview = (urls) => {
              if (!urls || urls.length === 0) return '';
              const imgTags = urls.map(u => `![](${u})`).join('\n\n'); // ç”»åƒé–“ã¯ç©ºè¡Œ1ã¤
              return `<details>\n<summary>ğŸ“· æ·»ä»˜ç”»åƒï¼ˆ${urls.length}æšï¼‰</summary>\n\n${imgTags}\n\n</details>`;
            };

            const previewBlock = makePreview(images);

            // -----------------------------
            // Botæœ¬æ–‡ï¼ˆOpenAIãŒä½¿ãˆã‚Œã°ç”Ÿæˆã€ãƒ€ãƒ¡ãªã‚‰å›ºå®šæ–‡ï¼‰
            // -----------------------------
            let aiText = '';
            const apiKey = process.env.OPENAI_API_KEY || '';

            const formatReq =
              `è¿”ç­”ã¯å¿…ãšæ¬¡ã®å½¢ã§:\n` +
              `1. è¦æ—¨ï¼ˆ1ã€œ2è¡Œï¼‰\n` +
              `2. æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ1ã¤ã ã‘ï¼‰\n` +
              `3. å—ã‘å…¥ã‚Œæ¡ä»¶ï¼ˆç®‡æ¡æ›¸ãï¼‰\n` +
              `4. æ³¨æ„ç‚¹ï¼ˆç®‡æ¡æ›¸ãï¼‰\n`;

            const prompt = isIssue
              ? `Issue #${issueNumber}\nTitle: ${issueTitle}\nBody:\n${issueBody}\n\n${formatReq}`
              : `Issue #${issueNumber}\nTitle: ${issueTitle}\nComment:\n${commentBody}\n\n${formatReq}`;

            if (apiKey) {
              try {
                const res = await fetch('https://api.openai.com/v1/responses', {
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    model: 'gpt-4o',
                    input: prompt
                  })
                });

                const data = await res.json();

                aiText = data.output_text || '';
                if (!aiText && Array.isArray(data.output)) {
                  const parts = [];
                  for (const item of data.output) {
                    if (item.type === 'message' && Array.isArray(item.content)) {
                      for (const c of item.content) {
                        if (c.type === 'output_text' && c.text) parts.push(c.text);
                      }
                    }
                  }
                  aiText = parts.join('\n');
                }
              } catch (e) {
                core.warning(`OpenAI call failed: ${e?.message || e}`);
              }
            }

            if (!aiText) {
              aiText =
                `1. è¦æ—¨\n` +
                `BotãŒã‚³ãƒãƒ³ãƒ‰ã‚’å—ã‘å–ã‚Šã¾ã—ãŸã€‚\n\n` +
                `2. æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³\n` +
                `ã“ã®Issueã«ã€Œ/checkï¼ˆç”»åƒ2æšã¤ãï¼‰ã€ã§ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ã€‚\n\n` +
                `3. å—ã‘å…¥ã‚Œæ¡ä»¶\n` +
                `- BotãŒè¿”ä¿¡ã™ã‚‹\n` +
                `- ç”»åƒãŒã‚ã‚‹æ™‚ã ã‘ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå‡ºã‚‹\n\n` +
                `4. æ³¨æ„ç‚¹\n` +
                `- ç”»åƒã¯ã€Œ/check ã¨åŒã˜ã‚³ãƒ¡ãƒ³ãƒˆã€ã«è²¼ã‚‹ã¨ç¢ºå®Ÿã§ã™\n`;
            }

            // -----------------------------
            // æŠ•ç¨¿æœ¬æ–‡ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ â†’ åŒºåˆ‡ã‚Š â†’ æœ¬æ–‡ï¼‰
            // -----------------------------
            const bodyParts = [];
            if (previewBlock) bodyParts.push(previewBlock, '\n---\n');
            bodyParts.push(aiText);

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: bodyParts.join('\n')
            });
