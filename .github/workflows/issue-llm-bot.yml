# issue-llm-bot.yml
# WORKFLOW VERSION: v0.1.0
# BUILD(JST): 2025-12-14 14:27
# CHANGES:
# - Secretsåã®æºã‚Œï¼ˆOPENAI_API_KEY / PENAI_API_KEYï¼‰ã‚’ä¸¡å¯¾å¿œã«ä¿®æ­£
# - æ·»ä»˜ç”»åƒã‚’ <details> ã§ã€Œåˆ¥ã‚¿ãƒ–ã‚’é–‹ãã«ãã„ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã«çµ±ä¸€
# - /approve ã‚³ãƒ¡ãƒ³ãƒˆã§ approved ãƒ©ãƒ™ãƒ«ä»˜ã‘ï¼‹æ‰¿èªã‚³ãƒ¡ãƒ³ãƒˆ

name: Issue LLM Bot

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  task_auto_reply:
    if: github.event_name == 'issues' && startsWith(github.event.issue.title, '[TASK]')
    runs-on: ubuntu-latest
    steps:
      - name: Post auto reply (TASK)
        uses: actions/github-script@v7
        env:
          # â˜…ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼šã©ã£ã¡ã®Secretsåã§ã‚‚OKã«ã™ã‚‹
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || secrets.PENAI_API_KEY }}
          # ãƒ¢ãƒ‡ãƒ«ã¯ Variablesï¼ˆSettings â†’ Secrets and variables â†’ Actions â†’ Variablesï¼‰ã§ä¸Šæ›¸ãå¯
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL || 'gpt-5-mini' }}
        with:
          script: |
            const issue = context.payload.issue;
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            const apiKey = (process.env.OPENAI_API_KEY || '').trim();
            const model  = (process.env.OPENAI_MODEL || 'gpt-5-mini').trim();

            // ---- helpers ----
            function extractImageUrls(text) {
              const urls = new Set();
              if (!text) return [];

              // <img ... src="...">
              const imgTagRe = /<img[^>]*src=["']([^"']+)["'][^>]*>/gi;
              let m;
              while ((m = imgTagRe.exec(text)) !== null) urls.add(m[1]);

              // Markdown ![alt](url)
              const mdImgRe = /!\[[^\]]*\]\(([^)]+)\)/g;
              while ((m = mdImgRe.exec(text)) !== null) urls.add(m[1]);

              // ç”ŸURLï¼ˆæ·»ä»˜ç³»ã£ã½ã„ã‚‚ã®ã ã‘æ‹¾ã†ï¼‰
              const urlRe = /(https?:\/\/[^\s)<>"]+)/g;
              while ((m = urlRe.exec(text)) !== null) {
                const u = m[1];
                if (
                  u.includes('github.com/user-attachments/') ||
                  u.includes('user-images.githubusercontent.com') ||
                  u.includes('private-user-images.githubusercontent.com') ||
                  u.match(/\.(png|jpg|jpeg|gif|webp)(\?.*)?$/i)
                ) {
                  urls.add(u);
                }
              }

              return Array.from(urls);
            }

            function buildDetailsPreview(urls) {
              if (!urls.length) return 'ï¼ˆæ·»ä»˜ç”»åƒãªã—ï¼‰';

              // å¤šã™ãã‚‹ã¨é‡ã„ã®ã§æœ€å¤§6æšã¾ã§
              const limited = urls.slice(0, 6);

              return limited.map((url, i) => {
                const n = i + 1;
                // ã‚µãƒ ãƒâ†’é–‹ãã¨å¤§ãã‚è¡¨ç¤ºï¼ˆé–‰ã˜ã‚‹ã¯ summary ã‚’ã‚‚ã†ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ï¼‰
                return [
                  `<details>`,
                  `  <summary>ğŸ–¼ æ·»ä»˜ç”»åƒ${n}ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹ãï¼ã‚‚ã†ä¸€åº¦ã§é–‰ã˜ã‚‹ï¼‰</summary>`,
                  `  <p><img src="${url}" width="520" alt="thumb${n}"></p>`,
                  `  <p><img src="${url}" alt="full${n}"></p>`,
                  `</details>`
                ].join('\n');
              }).join('\n\n');
            }

            async function postComment(body) {
              await github.rest.issues.createComment({
                owner, repo,
                issue_number: issue.number,
                body
              });
            }

            // ---- Secrets æœªè¨­å®šãªã‚‰ã€ã“ã“ã§ä¸å¯§ã«æ¡ˆå†…ã—ã¦çµ‚äº†ï¼ˆè½ã¨ã•ãªã„ï¼‰----
            if (!apiKey) {
              const msg = [
                `## è¦æ—¨`,
                `Botå´ã§AIå‘¼ã³å‡ºã—ãŒã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆAPIã‚­ãƒ¼ãŒæ¸¡ã£ã¦ã„ã¾ã›ã‚“ï¼‰ã€‚`,
                ``,
                `## æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç¢ºèªã ã‘ï¼‰`,
                `- GitHub â†’ **Settings** â†’ **Secrets and variables** â†’ **Actions**`,
                `- **Secrets** ã« **OPENAI_API_KEY** ã‹ **PENAI_API_KEY** ã®ã©ã¡ã‚‰ã‹ãŒå…¥ã£ã¦ã„ã‚‹ã‹ç¢ºèª`,
                ``,
                `ï¼ˆã“ã®workflowã¯ **OPENAI_API_KEY / PENAI_API_KEY ã®ä¸¡æ–¹ã«å¯¾å¿œ**ã—ã¦ã„ã¾ã™ï¼‰`,
                ``,
                `---`,
                `æ‰¿èªã—ã¦æ¬¡ã¸é€²ã‚ã‚‹ã¨ãã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã« \`/approve\` ã¨æ›¸ã„ã¦ãã ã•ã„ã€‚`
              ].join('\n');
              await postComment(msg);
              return;
            }

            // ---- ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ----
            const urls = extractImageUrls(issue.body || '');
            const previewBlock = buildDetailsPreview(urls);

            // ---- OpenAI Responses API ----
            const inputText = [
              `ã‚ãªãŸã¯ã€ŒAIæˆ¦ç•¥ä¼šè­°å®¤ã€ã®è­°äº‹é€²è¡Œã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚`,
              `æ¬¡ã®Issueã‚’èª­ã‚“ã§ã€çŸ­ãåˆ†ã‹ã‚Šã‚„ã™ãï¼š`,
              `1) è¦æ—¨ï¼ˆä½•ã‚’ã—ãŸã„ï¼Ÿï¼‰`,
              `2) æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ1ã€œ3å€‹ï¼‰`,
              `3) è¿½åŠ ã§å¿…è¦ãªæƒ…å ±ï¼ˆã‚ã‚Œã°ï¼‰`,
              `ã‚’æ—¥æœ¬èªã§å‡ºã—ã¦ãã ã•ã„ã€‚`,
              ``,
              `---`,
              `# Title`,
              issue.title,
              ``,
              `# Body`,
              issue.body || '(empty)'
            ].join('\n');

            let aiText = '';
            try {
              const res = await fetch('https://api.openai.com/v1/responses', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${apiKey}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  model,
                  input: inputText,
                  max_output_tokens: 800
                })
              });

              const data = await res.json();

              // å–ã‚Šå‡ºã—æ–¹ã®å·®ã«å¼·ãã™ã‚‹
              aiText =
                data.output_text ||
                (Array.isArray(data.output) && data.output[0]?.content?.[0]?.text) ||
                (data.output?.[0]?.content?.[0]?.text) ||
                '';

              if (!res.ok) {
                aiText = `ï¼ˆAIå‘¼ã³å‡ºã—ã«å¤±æ•—ï¼š${res.status}ï¼‰\n` + (aiText || JSON.stringify(data).slice(0, 800));
              }
            } catch (e) {
              aiText = `ï¼ˆAIå‘¼ã³å‡ºã—ã«å¤±æ•—ï¼š${String(e)}ï¼‰`;
            }

            const comment = [
              `## è¦æ—¨`,
              aiText.trim() || 'ï¼ˆAIå¿œç­”ãªã—ï¼‰',
              ``,
              `---`,
              `## æ·»ä»˜ç”»åƒï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰`,
              previewBlock,
              ``,
              `---`,
              `æ‰¿èªã—ã¦æ¬¡ã¸é€²ã‚ã‚‹ã¨ãã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã« \`/approve\` ã¨æ›¸ã„ã¦ãã ã•ã„ã€‚`
            ].join('\n');

            await postComment(comment);

  task_approve:
    if: github.event_name == 'issue_comment' && startsWith(github.event.issue.title, '[TASK]') && contains(github.event.comment.body, '/approve')
    runs-on: ubuntu-latest
    steps:
      - name: Mark approved
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            // æ—¢ã«ä»˜ã„ã¦ãŸã‚‰ä½•ã‚‚ã—ãªã„
            const labels = (issue.labels || []).map(l => (typeof l === 'string' ? l : l.name));
            const hasApproved = labels.includes('approved');

            if (!hasApproved) {
              await github.rest.issues.addLabels({
                owner, repo,
                issue_number: issue.number,
                labels: ['approved']
              });
            }

            await github.rest.issues.createComment({
              owner, repo,
              issue_number: issue.number,
              body: hasApproved
                ? `âœ… ã™ã§ã«æ‰¿èªæ¸ˆã¿ã§ã™ï¼ˆapprovedï¼‰ã€‚`
                : `âœ… æ‰¿èªã‚’å—ã‘å–ã‚Šã¾ã—ãŸï¼ˆapproved ã‚’ä»˜ä¸ï¼‰ã€‚`
            });
