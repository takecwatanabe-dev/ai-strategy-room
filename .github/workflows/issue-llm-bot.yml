name: Issue LLM Bot

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

permissions:
  issues: write

jobs:
  reply:
    if: github.event_name == 'issues' && startsWith(github.event.issue.title, '[TASK]')
    runs-on: ubuntu-latest
    steps:
      - name: Generate & post reply (with image thumbnails)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          python3 - <<'PY'
          import os, re, json, urllib.request

          def extract_images(text: str):
              text = text or ""
              urls = []
              # HTML <img ... src="...">
              for m in re.finditer(r'<img[^>]*src="([^"]+)"[^>]*>', text, flags=re.I):
                  urls.append(m.group(1))
              # Markdown ![alt](url)
              for m in re.finditer(r'!\[[^\]]*\]\(([^)\s]+)(?:\s+"[^"]*")?\)', text):
                  urls.append(m.group(1))
              # de-dup keep order
              seen, out = set(), []
              for u in urls:
                  if u not in seen:
                      seen.add(u)
                      out.append(u)
              return out

          def build_thumbs(urls, width=520):
              if not urls:
                  return ""
              lines = []
              lines.append("")
              lines.append("### 添付画像（クリックで原寸）")
              for u in urls:
                  u2 = u.replace('"', '%22')
                  lines.append(f'<a href="{u2}"><img src="{u2}" width="{width}"></a>')
              return "\n".join(lines)

          def post_comment(repo, issue_number, token, body):
              api = f"https://api.github.com/repos/{repo}/issues/{issue_number}/comments"
              req = urllib.request.Request(
                  api,
                  data=json.dumps({"body": body}).encode("utf-8"),
                  headers={
                      "Content-Type": "application/json",
                      "Authorization": f"token {token}",
                      "Accept": "application/vnd.github+json",
                  },
                  method="POST",
              )
              with urllib.request.urlopen(req, timeout=60) as r:
                  r.read()

          def call_openai(prompt: str) -> str:
              key = (os.getenv("OPENAI_API_KEY") or "").strip()
              if not key:
                  raise RuntimeError("OPENAI_API_KEY missing")
              url = "https://api.openai.com/v1/chat/completions"
              payload = {
                  "model": "gpt-4o-mini",
                  "messages": [{"role": "user", "content": prompt}],
                  "temperature": 0.4,
                  "max_tokens": 520,
              }
              req = urllib.request.Request(
                  url,
                  data=json.dumps(payload).encode("utf-8"),
                  headers={"Content-Type": "application/json", "Authorization": f"Bearer {key}"},
                  method="POST",
              )
              with urllib.request.urlopen(req, timeout=60) as r:
                  data = json.loads(r.read().decode("utf-8"))
              return data["choices"][0]["message"]["content"].strip()

          def call_gemini(prompt: str) -> str:
              key = (os.getenv("GEMINI_API_KEY") or "").strip()
              if not key:
                  raise RuntimeError("GEMINI_API_KEY missing")
              url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key={key}"
              payload = {
                  "contents": [{"parts": [{"text": prompt}]}],
                  "generationConfig": {"temperature": 0.4, "maxOutputTokens": 520},
              }
              req = urllib.request.Request(
                  url,
                  data=json.dumps(payload).encode("utf-8"),
                  headers={"Content-Type": "application/json"},
                  method="POST",
              )
              with urllib.request.urlopen(req, timeout=60) as r:
                  data = json.loads(r.read().decode("utf-8"))
              return data["candidates"][0]["content"]["parts"][0]["text"].strip()

          repo = os.getenv("REPO")
          issue_number = os.getenv("ISSUE_NUMBER")
          gh_token = os.getenv("GITHUB_TOKEN")
          title = (os.getenv("ISSUE_TITLE") or "").strip()
          body = (os.getenv("ISSUE_BODY") or "").strip()

          img_urls = extract_images(body)
          thumbs = build_thumbs(img_urls, width=520)

          prompt = f"""あなたは「AI戦略会議室」の補助AIです。
ユーザーはコピペ量を減らしたいので、短く・実行しやすく書いてください。

必ず次の形式で日本語Markdownで返してください:
1) 要旨（1〜2行）
2) 次の1アクション（クリック/入力まで具体）
3) うまくいかない時の分岐（A/Bで2つまで）
4) 注意点（秘密情報は貼らない、など1〜2行）

--- Issue Title ---
{title}

--- Issue Body ---
{body}
"""

          bot = ""
          try:
              reply = call_openai(prompt)
              bot = "OpenAI"
          except Exception:
              try:
                  reply = call_gemini(prompt)
                  bot = "Gemini"
              except Exception as e:
                  reply = "1) 要旨\nAPI呼び出しに失敗しました。\n\n2) 次の1アクション\nSecrets（OPENAI_API_KEY / GEMINI_API_KEY）を確認してください。\n\n3) うまくいかない時の分岐\nA: OPENAIだけ入れる\nB: GEMINIだけ入れる\n\n4) 注意点\n秘密情報は貼らないでください。"
                  bot = "Error"

          if thumbs:
              reply = reply + "\n\n---\n" + thumbs
          reply = reply + f"\n\n---\n_bot: {bot}_"

          post_comment(repo, issue_number, gh_token, reply)
          print("OK")
          PY

  approve:
    if: github.event_name == 'issue_comment' && contains(github.event.comment.body, '/approve') && startsWith(github.event.issue.title, '[TASK]')
    runs-on: ubuntu-latest
    steps:
      - name: Acknowledge approval
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          python3 - <<'PY'
          import os, json, urllib.request
          repo = os.getenv("REPO")
          issue = os.getenv("ISSUE_NUMBER")
          tok = os.getenv("GITHUB_TOKEN")
          body = "了解。/approve を受け取りました。次は Rex にこのIssueのURLを渡して実装依頼してね（必要なら、私が依頼文も整えるよ）。"
          api = f"https://api.github.com/repos/{repo}/issues/{issue}/comments"
          req = urllib.request.Request(
              api,
              data=json.dumps({"body": body}).encode("utf-8"),
              headers={
                  "Content-Type":"application/json",
                  "Authorization": f"token {tok}",
                  "Accept":"application/vnd.github+json",
              },
              method="POST",
          )
          with urllib.request.urlopen(req, timeout=60) as r:
              r.read()
          print("approved-commented")
          PY
