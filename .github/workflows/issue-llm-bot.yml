# .github/workflows/issue-llm-bot.yml
# Build: 2025-12-13 22:32 JST
# Version: v0.1.1
name: Issue LLM Bot

on:
  issues:
    types: [opened, reopened]

permissions:
  issues: write

jobs:
  reply:
    if: startsWith(github.event.issue.title, '[TASK]')
    runs-on: ubuntu-latest
    steps:
      - name: Generate reply and comment (OpenAI -> fallback Gemini)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          set -e
          python3 - <<'PY'
          import os, json, urllib.request, urllib.error

          def http_json(url, headers=None, payload=None, method="POST"):
              data = None
              if payload is not None:
                  data = json.dumps(payload).encode("utf-8")
              req = urllib.request.Request(url, data=data, method=method)
              for k, v in (headers or {}).items():
                  req.add_header(k, v)
              if payload is not None:
                  req.add_header("Content-Type", "application/json")
              try:
                  with urllib.request.urlopen(req, timeout=60) as res:
                      return res.getcode(), json.loads(res.read().decode("utf-8"))
              except urllib.error.HTTPError as e:
                  body = e.read().decode("utf-8", errors="ignore")
                  return e.code, {"error": body}

          def openai_generate(prompt):
              key = os.environ.get("OPENAI_API_KEY","").strip()
              if not key:
                  raise RuntimeError("OPENAI_API_KEY is empty")
              url = "https://api.openai.com/v1/chat/completions"
              headers = {"Authorization": f"Bearer {key}"}
              models = ["gpt-4o-mini", "gpt-4.1-mini", "gpt-4.1", "gpt-4o"]
              last = None
              for model in models:
                  payload = {
                      "model": model,
                      "messages": [
                          {"role": "system", "content": "ã‚ãªãŸã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè£œåŠ©ã®AIã§ã™ã€‚è¿”ç­”ã¯æ—¥æœ¬èªžã€‚çŸ­ãã€å®Ÿè¡Œæ‰‹é †ã¯1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãšã¤ã€‚"},
                          {"role": "user", "content": prompt},
                      ],
                      "temperature": 0.2,
                  }
                  code, obj = http_json(url, headers=headers, payload=payload)
                  if 200 <= code < 300 and "choices" in obj:
                      return obj["choices"][0]["message"]["content"].strip()
                  last = (code, obj)
              raise RuntimeError(f"OpenAI failed: {last}")

          def gemini_generate(prompt):
              key = os.environ.get("GEMINI_API_KEY","").strip()
              if not key:
                  raise RuntimeError("GEMINI_API_KEY is empty")
              model = "gemini-1.5-flash"
              url = f"https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={key}"
              payload = {"contents":[{"role":"user","parts":[{"text":prompt}]}]}
              code, obj = http_json(url, headers={}, payload=payload)
              if 200 <= code < 300:
                  try:
                      return obj["candidates"][0]["content"]["parts"][0]["text"].strip()
                  except Exception:
                      return json.dumps(obj, ensure_ascii=False)
              raise RuntimeError(f"Gemini failed: {code} {obj}")

          def post_comment(body_md):
              token = os.environ.get("GITHUB_TOKEN","").strip()
              repo = os.environ.get("REPO","").strip()
              num = os.environ.get("ISSUE_NUMBER","").strip()
              if not token or not repo or not num:
                  raise RuntimeError("Missing GITHUB_TOKEN/REPO/ISSUE_NUMBER")
              url = f"https://api.github.com/repos/{repo}/issues/{num}/comments"
              headers = {
                  "Authorization": f"Bearer {token}",
                  "Accept": "application/vnd.github+json",
                  "X-GitHub-Api-Version": "2022-11-28",
                  "User-Agent": "issue-llm-bot"
              }
              code, obj = http_json(url, headers=headers, payload={"body": body_md})
              if not (200 <= code < 300):
                  raise RuntimeError(f"Comment failed: {code} {obj}")

          title = os.environ.get("ISSUE_TITLE","").strip()
          body  = os.environ.get("ISSUE_BODY","").strip()

          prompt = f"""ã‚ãªãŸã¯ã€Žæˆ¦ç•¥çš„ä¼šè­°å®¤ã€ã®å®Ÿè¡Œæ‹…å½“ã§ã™ã€‚
ä»¥ä¸‹ã®Issueå†…å®¹ã«å¯¾ã—ã¦ã€æ¬¡ã®å½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ã€‚

1) è¦æ—¨ï¼ˆ1ã€œ2è¡Œï¼‰
2) æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¯ãƒªãƒƒã‚¯/å…¥åŠ›ã¾ã§å…·ä½“ï¼‰
3) ã†ã¾ãã„ã‹ãªã„æ™‚ã®åˆ†å²ï¼ˆA/Bã§2ã¤ã¾ã§ï¼‰
4) æ³¨æ„ç‚¹ï¼ˆç§˜å¯†æƒ…å ±ã¯è²¼ã‚‰ãªã„ã€ãªã©1ã€œ2è¡Œï¼‰

--- Issue Title ---
{title}

--- Issue Body ---
{body}
"""
          try:
              reply = openai_generate(prompt)
              engine = "OpenAI"
          except Exception:
              reply = gemini_generate(prompt + "\n\n(æ³¨: OpenAIãŒå¤±æ•—ã—ãŸã®ã§Geminiã§è¿”ç­”ã—ã¦)")
              engine = "Gemini(fallback)"

          comment = f"ðŸ¤– è‡ªå‹•è¿”ä¿¡ï¼ˆ{engine}ï¼‰\\n\\n{reply}\\n"
          post_comment(comment)
          print("OK: commented")
          PY
