# ============================================================
# AI戦略会議室 | Issue LLM Bot
# Version: v1.0.5
# Date: 2025-12-16 13:51 JST
# Changes:
#  - 画像プレビューは「/approve または /check コメントに画像がある時だけ」
#  - 画像の取得元は「今のコメント本文のみ」（Issue本文/過去コメントは見ない）
#  - YAML構造を整理してパースエラーを潰す
# ============================================================

name: Issue LLM Bot

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  bot:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Prepare context (decide run + images)
        id: prep
        shell: bash
        run: |
          python - <<'PY'
          import json, os, re
          from pathlib import Path

          event_path = os.environ.get("GITHUB_EVENT_PATH")
          event_name = os.environ.get("GITHUB_EVENT_NAME")
          repo = os.environ.get("GITHUB_REPOSITORY")
          out_path = os.environ.get("GITHUB_OUTPUT")

          data = json.loads(Path(event_path).read_text(encoding="utf-8"))

          def starts_with_task(title: str) -> bool:
              if not title:
                  return False
              t = title.strip()
              return t.startswith("[TASK]") or t.startswith("【TASK】")

          issue = data.get("issue") or {}
          issue_number = issue.get("number") or data.get("number")
          issue_title = issue.get("title") or ""
          issue_body = issue.get("body") or ""

          comment = data.get("comment") or {}
          comment_body = comment.get("body") or ""

          cmd = None
          if event_name == "issue_comment":
              m = re.search(r"(?im)^\s*/(approve|check)\b", comment_body)
              cmd = m.group(1).lower() if m else None
              should_reply = cmd is not None
          elif event_name == "issues":
              should_reply = starts_with_task(issue_title)
          else:
              should_reply = False

          image_urls = []
          if event_name == "issue_comment" and should_reply:
              image_urls += re.findall(r"!\[[^\]]*\]\((https?://[^)]+)\)", comment_body)
              image_urls += re.findall(r"(https?://\S+?(?:png|jpg|jpeg|gif|webp))(?:\s|$)", comment_body, flags=re.IGNORECASE)
              image_urls += re.findall(r"(https?://github\.com/\S+/assets/\S+)(?:\s|$)", comment_body)

              seen, dedup = set(), []
              for u in image_urls:
                  u = u.strip().rstrip(")")
                  if u and u not in seen:
                      seen.add(u)
                      dedup.append(u)
              image_urls = dedup

          should_preview = (event_name == "issue_comment" and should_reply and len(image_urls) > 0)

          prompt_lines = []
          prompt_lines.append("あなたは GitHub Issue の運用補助Botです。日本語で、短く・実務的に答えてください。")
          prompt_lines.append("")
          prompt_lines.append("必ず以下の順で書いてください：")
          prompt_lines.append("1. 要旨（1〜2行）")
          prompt_lines.append("2. 次の1アクション（クリック/入力まで具体。1個だけ）")
          prompt_lines.append("3. 受け入れ条件（チェック項目）")
          prompt_lines.append("4. 注意点（秘密情報・APIキー等は書かない）")
          prompt_lines.append("")
          prompt_lines.append(f"Repo: {repo}")
          prompt_lines.append(f"Issue: #{issue_number} {issue_title}")
          prompt_lines.append("")
          prompt_lines.append("Issue本文:")
          prompt_lines.append(issue_body or "(なし)")
          prompt_lines.append("")
          if event_name == "issue_comment":
              prompt_lines.append("最新コメント:")
              prompt_lines.append(comment_body or "(なし)")
          else:
              prompt_lines.append("最新コメント: (issuesイベントのため無し)")

          Path("prompt.txt").write_text("\n".join(prompt_lines), encoding="utf-8")
          Path("images.json").write_text(json.dumps(image_urls, ensure_ascii=False), encoding="utf-8")

          with open(out_path, "a", encoding="utf-8") as f:
              f.write(f"should_reply={'true' if should_reply else 'false'}\n")
              f.write(f"should_preview={'true' if should_preview else 'false'}\n")
              f.write(f"issue_number={issue_number}\n")
              f.write(f"command={(cmd or '')}\n")
          PY

      - name: Skip if not target
        if: steps.prep.outputs.should_reply != 'true'
        run: |
          echo "Not a target event/comment. Skip."

      - name: Call OpenAI Responses API (text)
        if: steps.prep.outputs.should_reply == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-4o-mini
        shell: bash
        run: |
          set -e
          PROMPT_JSON=$(python - <<'PY'
          import json
          from pathlib import Path
          txt = Path("prompt.txt").read_text(encoding="utf-8")
          print(json.dumps(txt))
          PY
          )

          curl -sS https://api.openai.com/v1/responses \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"${OPENAI_MODEL}\",
              \"input\": ${PROMPT_JSON}
            }" > response.json

          python - <<'PY'
          import json
          from pathlib import Path

          data = json.loads(Path("response.json").read_text(encoding="utf-8"))
          text = data.get("output_text")

          if not text:
              out = []
              for item in data.get("output", []):
                  for c in item.get("content", []):
                      if c.get("type") in ("output_text", "text"):
                          out.append(c.get("text",""))
              text = "\n".join([t for t in out if t]).strip()

          if not text:
              text = "（Bot）返信文の生成に失敗しました。Actionsログを確認してください。"

          Path("reply.md").write_text(text.strip() + "\n", encoding="utf-8")
          PY

      - name: Append image preview (only when needed)
        if: steps.prep.outputs.should_preview == 'true'
        shell: bash
        run: |
          python - <<'PY'
          import json
          from pathlib import Path

          urls = json.loads(Path("images.json").read_text(encoding="utf-8"))
          if not urls:
              raise SystemExit(0)

          md = Path("reply.md").read_text(encoding="utf-8").rstrip() + "\n\n"
          md += "<details>\n<summary>添付画像（プレビュー）</summary>\n\n"
          for i, u in enumerate(urls, 1):
              md += f"![image {i}]({u})\n\n"
          md += "</details>\n"
          Path("reply.md").write_text(md, encoding="utf-8")
          PY

      - name: Post comment to issue
        if: steps.prep.outputs.should_reply == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.prep.outputs.issue_number }}
        shell: bash
        run: |
          set -e
          BODY="$(python - <<'PY'
          from pathlib import Path
          print(Path("reply.md").read_text(encoding="utf-8"))
          PY
          )"
          gh api "repos/${GITHUB_REPOSITORY}/issues/${ISSUE_NUMBER}/comments" -f body="$BODY"
