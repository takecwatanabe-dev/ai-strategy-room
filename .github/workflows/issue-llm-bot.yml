name: Issue LLM Bot

on:
  issues:
    types: [opened, reopened]

permissions:
  issues: write
  contents: read

jobs:
  reply:
    runs-on: ubuntu-latest
    steps:
      - name: Post bot reply (with image preview)
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-4o-mini
          PREVIEW_IMG_WIDTH: "720"
        with:
          script: |
            const issue = context.payload.issue;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // [1] å¯¾è±¡ã®Issueã ã‘ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãŒ [TASK] ã§å§‹ã¾ã‚‹æƒ³å®šã€‚å¿…è¦ãªã‚‰èª¿æ•´ã—ã¦OKï¼‰
            if (!issue.title || !issue.title.startsWith("[TASK]")) {
              core.info("Skip: not a [TASK] issue.");
              return;
            }

            const title = issue.title;
            const body = issue.body || "";
            const imgWidth = parseInt(process.env.PREVIEW_IMG_WIDTH || "720", 10);

            // [2] ç”»åƒURLã‚’æ‹¾ã†ï¼ˆ<img src="..."> / Markdown ![]() ã®ä¸¡æ–¹ï¼‰
            function extractImageUrls(text) {
              const urls = [];
              // <img ... src="...">
              const reImg = /<img[^>]*\ssrc="([^"]+)"[^>]*>/gi;
              for (const m of text.matchAll(reImg)) {
                if (m[1]) urls.push(m[1]);
              }
              // ![alt](url)
              const reMd = /!\[[^\]]*\]\(([^)]+)\)/g;
              for (const m of text.matchAll(reMd)) {
                if (m[1]) urls.push(m[1]);
              }
              // é‡è¤‡é™¤å»
              return Array.from(new Set(urls));
            }

            const imageUrls = extractImageUrls(body);

            // [3] æ·»ä»˜ç”»åƒï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰ãƒ–ãƒ­ãƒƒã‚¯ï¼šæŠ˜ã‚ŠãŸãŸã¿ï¼‹ã€ŒÃ—ã®ä»£ã‚ã‚Šã€ã®å‰Šé™¤å°ç·š
            let previewBlock = "";
            if (imageUrls.length > 0) {
              previewBlock += `\n\n---\n\n<details open>\n<summary>ğŸ“ æ·»ä»˜ç”»åƒï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰â€” ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹</summary>\n\n`;
              previewBlock += `â€»ã€Œæ¶ˆã—ãŸã„ã€å ´åˆã¯ã€Issueæœ¬æ–‡ã‚’ç·¨é›†ã—ã¦è©²å½“ã®ç”»åƒè¡Œï¼ˆ<img ...> ã‹ ![](...)ï¼‰ã‚’å‰Šé™¤ã—ã¦ã­ã€‚\n\n`;
              imageUrls.forEach((url, i) => {
                const n = i + 1;
                previewBlock += `**IMG-${n}**  âœ•ï¼ˆå‰Šé™¤ï¼‰â†’ Issueæœ¬æ–‡ã‚’ç·¨é›†ã—ã¦ã€ã“ã®ç”»åƒã®è¡Œã‚’å‰Šé™¤\n\n`;
                previewBlock += `<img src="${url}" width="${imgWidth}" />\n\n`;
              });
              previewBlock += `</details>\n`;
            }

            // [4] LLMã«æŠ•ã’ã‚‹æœ¬æ–‡ï¼ˆã“ã“ã¯ä»Šã®é‹ç”¨ã«åˆã‚ã›ã¦èª¿æ•´OKï¼‰
            //     é‡è¦ï¼šã“ã®workflowã¯ã€Œç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å¿…ãšä»˜ã‘ã‚‹ã€ã®ãŒç›®çš„ã€‚
            const prompt = `
            ã‚ãªãŸã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é€²è¡Œè£œåŠ©Botã§ã™ã€‚
            æ¬¡ã®Issueæœ¬æ–‡ã‚’èª­ã¿ã€å¿…ãšä»¥ä¸‹ã®è¦‹å‡ºã—ã§çŸ­ãè¿”ã—ã¦ãã ã•ã„ã€‚

            # è¦æ—¨
            # æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            # ã†ã¾ãã„ã‹ãªã„æ™‚ã®åˆ†å²
            # æ³¨æ„ç‚¹

            ----
            ã‚¿ã‚¤ãƒˆãƒ«: ${title}
            æœ¬æ–‡:
            ${body}
            `;

            async function callOpenAI(promptText) {
              const apiKey = process.env.OPENAI_API_KEY;
              if (!apiKey) throw new Error("OPENAI_API_KEY is not set.");

              const model = process.env.OPENAI_MODEL || "gpt-4o-mini";
              const res = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                  model,
                  messages: [
                    { role: "system", content: "You are a helpful project assistant." },
                    { role: "user", content: promptText }
                  ],
                  temperature: 0.3
                })
              });

              if (!res.ok) {
                const t = await res.text();
                throw new Error(`OpenAI error: ${res.status} ${t}`);
              }
              const data = await res.json();
              return data.choices?.[0]?.message?.content?.trim() || "(no content)";
            }

            let llmText = "";
            try {
              llmText = await callOpenAI(prompt);
            } catch (e) {
              llmText = `# è¦æ—¨\nLLMå‘¼ã³å‡ºã—ã§ã‚¨ãƒ©ãƒ¼ã€‚\n\n# æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³\nOPENAI_API_KEY ã¨æ¨©é™ã‚’ç¢ºèªã€‚\n\n# ã†ã¾ãã„ã‹ãªã„æ™‚ã®åˆ†å²\n- APIã‚­ãƒ¼æœªè¨­å®š\n- Actionsã®Secretsåé•ã„\n\n# æ³¨æ„ç‚¹\nç§˜å¯†æƒ…å ±ã¯è²¼ã‚‰ãªã„\n\n(è©³ç´°) ${String(e)}`;
            }

            const commentBody = `${llmText}${previewBlock}`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issue.number,
              body: commentBody
            });

            core.info("Comment posted.");
