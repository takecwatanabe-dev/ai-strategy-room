name: Issue LLM Bot

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  llm_task:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issues' && github.event.issue.user.type != 'Bot') ||
      (github.event_name == 'issue_comment' && 
       github.event.comment.user.type != 'Bot' && 
       github.event.actor != 'github-actions[bot]' &&
       (contains(github.event.comment.body, '/approve') || 
        contains(github.event.comment.body, '/review') ||
        contains(github.event.comment.body, '/check')))
    outputs:
      check_result: ${{ steps.check.outputs.check_result }}
      should_run: ${{ steps.check_image.outputs.should_run || 'false' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Check Image in Comment
        id: check_image
        run: |
          SHOULD_RUN="false"
          
          # issue_comment ã‚¤ãƒ™ãƒ³ãƒˆã§ /approve ã¾ãŸã¯ /check ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ãƒã‚§ãƒƒã‚¯
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT_BODY="${{ github.event.comment.body }}"
            
            # /approve ã¾ãŸã¯ /check ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if echo "$COMMENT_BODY" | grep -qiE '/(approve|check)'; then
              # ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã«ç”»åƒURLãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
              # GitHubã®ç”»åƒURLãƒ‘ã‚¿ãƒ¼ãƒ³: user-images.githubusercontent.com ã¾ãŸã¯ private-user-images.githubusercontent.com
              if echo "$COMMENT_BODY" | grep -qiE '!\[[^\]]*\]\(https?://[^)]*(user-images|private-user-images)\.githubusercontent\.com[^)]*\)'; then
                SHOULD_RUN="true"
                echo "::notice::Image detected in /approve or /check comment, will generate preview"
              else
                echo "::notice::No image in /approve or /check comment, text-only response"
              fi
            else
              echo "::notice::Not /approve or /check comment, skipping image check"
            fi
          else
            echo "::notice::Not issue_comment event, skipping image check"
          fi
          
          echo "should_run=${SHOULD_RUN}" >> $GITHUB_OUTPUT
          echo "should_run=${SHOULD_RUN}"

      - name: Generate Bot Response
        id: generate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Issueæƒ…å ±ã‚’å–å¾—ï¼ˆissues ã‚¤ãƒ™ãƒ³ãƒˆã¨ issue_comment ã‚¤ãƒ™ãƒ³ãƒˆã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_BODY="${{ github.event.issue.body }}"
            COMMENT_BODY="${{ github.event.comment.body }}"
            PROMPT_TEXT="Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}

${ISSUE_BODY}

ã‚³ãƒ¡ãƒ³ãƒˆ: ${COMMENT_BODY}

ä¸Šè¨˜ã®Issueã¨ã‚³ãƒ¡ãƒ³ãƒˆã«å¯¾ã—ã¦ã€é©åˆ‡ãªå›ç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚"
          else
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_BODY="${{ github.event.issue.body }}"
            PROMPT_TEXT="Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}

${ISSUE_BODY}

ä¸Šè¨˜ã®Issueã«å¯¾ã—ã¦ã€é©åˆ‡ãªå›ç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚"
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’JSONã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
          PROMPT_JSON=$(echo "$PROMPT_TEXT" | jq -Rs .)
          
          # OpenAI Responses APIã‚’å‘¼ã³å‡ºã—
          OPENAI_JSON=$(curl -s -X POST https://api.openai.com/v1/responses \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"gpt-4o\",
              \"input\": ${PROMPT_JSON}
            }")
          
          # OpenAI Responses APIä»•æ§˜ã«åˆã‚ã›ã¦æœ¬æ–‡ã‚’æŠ½å‡º
          # .output_text ãŒç›´æ¥å­˜åœ¨ã™ã‚‹å ´åˆã€ã¾ãŸã¯ .output[].content[].text(type=output_text) ã‚’é€£çµ
          AI_TEXT=$(echo "$OPENAI_JSON" | jq -r '
            if .output_text then
              .output_text
            else
              ([.output[]? 
                | select(.type=="message") 
                | .content[]? 
                | select(.type=="output_text") 
                | .text] | join("\n"))
            end
          ' || echo "")
          
          # ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
          if [ -z "$AI_TEXT" ] || [ "$AI_TEXT" = "null" ]; then
            echo "::error::OpenAI API response parsing failed"
            echo "Response: $OPENAI_JSON"
            exit 1
          fi
          
          COMMENT_BODY="$AI_TEXT"
          
          echo "commentBody<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMENT_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate Image Preview
        id: image_preview
        if: steps.check_image.outputs.should_run == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          COMMENT_BODY="${{ github.event.comment.body }}"
          
          # ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã‹ã‚‰ç”»åƒURLã‚’æŠ½å‡º
          IMAGE_URLS=$(echo "$COMMENT_BODY" | grep -oE '!\[[^\]]*\]\(https?://[^)]*(user-images|private-user-images)\.githubusercontent\.com[^)]*\)' | grep -oE 'https?://[^)]+')
          
          if [ -z "$IMAGE_URLS" ]; then
            echo "::warning::No image URLs found"
            echo "preview_text=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æœ€åˆã®ç”»åƒURLã‚’ä½¿ç”¨
          FIRST_IMAGE_URL=$(echo "$IMAGE_URLS" | head -n1)
          echo "::notice::Processing image: ${FIRST_IMAGE_URL}"
          
          # OpenAI Vision APIã§ç”»åƒã‚’åˆ†æ
          PREVIEW_JSON=$(curl -s -X POST https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"gpt-4o\",
              \"messages\": [
                {
                  \"role\": \"user\",
                  \"content\": [
                    {
                      \"type\": \"text\",
                      \"text\": \"ã“ã®ç”»åƒã‚’ç°¡æ½”ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚æŠ€è¡“çš„ãªå†…å®¹ã‚„é‡è¦ãªæƒ…å ±ãŒã‚ã‚Œã°å«ã‚ã¦ãã ã•ã„ã€‚\"
                    },
                    {
                      \"type\": \"image_url\",
                      \"image_url\": {
                        \"url\": \"${FIRST_IMAGE_URL}\"
                      }
                    }
                  ]
                }
              ],
              \"max_tokens\": 300
            }")
          
          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
          PREVIEW_TEXT=$(echo "$PREVIEW_JSON" | jq -r '.choices[0].message.content // ""')
          
          if [ -z "$PREVIEW_TEXT" ] || [ "$PREVIEW_TEXT" = "null" ]; then
            echo "::warning::Failed to generate image preview"
            echo "preview_text=" >> $GITHUB_OUTPUT
          else
            echo "::notice::Image preview generated successfully"
            echo "preview_text<<EOF" >> $GITHUB_OUTPUT
            echo "## ğŸ“· ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "${PREVIEW_TEXT}" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Self-Check Image Links
        id: check
        run: |
          COMMENT_BODY="${{ steps.generate.outputs.commentBody }}"
          
          # NGæ¡ä»¶ãƒã‚§ãƒƒã‚¯
          NG_DETECTED=false
          CHECK_RESULT="PASS"
          
          # NGæ¡ä»¶ a: <a ã‚¿ã‚°ã§ç”»åƒURLã«ãƒªãƒ³ã‚¯ã—ã¦ã„ã‚‹
          # ç”»åƒURLã®ãƒ‘ã‚¿ãƒ¼ãƒ³: private-user-images.githubusercontent.com, user-images.githubusercontent.com ãªã©
          if echo "$COMMENT_BODY" | grep -qiE '<a[^>]*href=["'"'"']?https?://[^"'"'"' ]*(private-user-images|user-images|githubusercontent\.com)'; then
            NG_DETECTED=true
            CHECK_RESULT="FAIL"
            echo "::error::NG detected: <a tag linking to image URL"
          fi
          
          # NGæ¡ä»¶ b: Markdownç”»åƒãƒªãƒ³ã‚¯ãŒæ®‹ã£ã¦ã„ã‚‹ï¼ˆ![ ã¨ ]( ã®çµ„ã¿åˆã‚ã›ï¼‰
          if echo "$COMMENT_BODY" | grep -qE '!\[[^\]]*\]\('; then
            NG_DETECTED=true
            CHECK_RESULT="FAIL"
            echo "::error::NG detected: Markdown image link syntax (![ ... ](...)) found"
          fi
          
          # è‡ªå·±åˆ¤å®šçµæœã‚’å…ˆé ­ã«è¿½åŠ 
          if [ "$NG_DETECTED" = "true" ]; then
            FINAL_BODY="SELF-CHECK: image_link=YES (FAIL)

$COMMENT_BODY"
            echo "Self-check result: FAIL"
          else
            FINAL_BODY="SELF-CHECK: image_link=NO (PASS)

$COMMENT_BODY"
            echo "Self-check result: PASS"
          fi
          
          echo "checkResult=$CHECK_RESULT" >> $GITHUB_OUTPUT
          echo "check_result=$CHECK_RESULT" >> $GITHUB_OUTPUT
          echo "finalBody<<EOF" >> $GITHUB_OUTPUT
          echo "$FINAL_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # NGãªã‚‰ã‚¸ãƒ§ãƒ–ã‚’å¤±æ•—ï¼ˆcore.setFailedç›¸å½“ï¼‰
          if [ "$NG_DETECTED" = "true" ]; then
            echo "::error::IMAGE_LINK_DETECTED"
            exit 1
          fi

      - name: Post Comment
        if: steps.check.outputs.checkResult == 'PASS'
        uses: actions/github-script@v7
        with:
          script: |
            // issues ã‚¤ãƒ™ãƒ³ãƒˆã¨ issue_comment ã‚¤ãƒ™ãƒ³ãƒˆã®ä¸¡æ–¹ã«å¯¾å¿œ
            const issue_number = context.payload.issue?.number || context.issue?.number;
            if (issue_number) {
              let commentBody = `${{ steps.check.outputs.finalBody }}`;
              
              // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒç”Ÿæˆã•ã‚ŒãŸå ´åˆã¯è¿½åŠ 
              const previewText = `${{ steps.image_preview.outputs.preview_text }}`;
              if (previewText && previewText.trim() !== '') {
                commentBody = previewText + '\n\n---\n\n' + commentBody;
              }
              
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number,
                body: commentBody
              });
            }

      - name: Notify Result
        if: always()
        run: |
          echo "::notice::Action run result=${{ job.status }}"

  notify:
    needs: [llm_task]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            // issues ã‚¤ãƒ™ãƒ³ãƒˆã¨ issue_comment ã‚¤ãƒ™ãƒ³ãƒˆã®ä¸¡æ–¹ã«å¯¾å¿œ
            const issue_number = context.payload.issue?.number || context.issue?.number;
            const jobResult = '${{ needs.llm_task.result }}'; // success / failure / cancelled
            const selfCheck = '${{ needs.llm_task.outputs.check_result }}' || 'UNKNOWN';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const shouldRun = '${{ needs.llm_task.outputs.should_run }}' || 'false';
            const body =
              `ğŸ§¾ Issue LLM Bot çµæœ\n` +
              `- job: ${jobResult}\n` +
              `- self-check: ${selfCheck}\n` +
              `- image-preview: ${shouldRun}\n` +
              `- run: ${runUrl}\n`;
            if (issue_number) {
              await github.rest.issues.createComment({ 
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number,
                body: body
              });
            }

