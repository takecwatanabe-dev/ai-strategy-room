# ISSUE LLM BOT WORKFLOW
# Version: v0.2.0
# Build: 2025-12-14 16:08 JST
# Changes:
# - Fix env mapping: OPENAI_API_KEY <- secrets.PENAI_API_KEY (fallback to OPENAI_API_KEY if exists)
# - Use Responses API (/v1/responses)
# - Attachment preview: <details> with thumbnail in <summary> (no new tab)

name: Issue LLM Bot

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  task_auto_reply:
    if: >-
      (github.event_name == 'issues' && startsWith(github.event.issue.title, '[TASK]')) ||
      (github.event_name == 'issue_comment' && startsWith(github.event.issue.title, '[TASK]') && contains(github.event.comment.body, '/approve'))
    runs-on: ubuntu-latest

    steps:
      - name: Post auto reply (TASK)
        uses: actions/github-script@v7
        env:
          # æ—¢å­˜é‹ç”¨ï¼ˆPENAI_API_KEYï¼‰ã‚’å„ªå…ˆã€‚ç„¡ã„å ´åˆã¯ OPENAI_API_KEY ã‚’è¦‹ã‚‹ã€‚
          OPENAI_API_KEY: ${{ secrets.PENAI_API_KEY || secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-5
        with:
          script: |
            const issue = context.payload.issue;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const apiKey = process.env.OPENAI_API_KEY;
            const model = process.env.OPENAI_MODEL || "gpt-5";

            // --- helpers ---
            function extractImageUrls(text) {
              const urls = new Set();
              if (!text) return [];
              // Markdown: ![alt](URL)
              const md = /!\[[^\]]*?\]\((https?:\/\/[^\s)]+)\)/g;
              // HTML: <img ... src="URL" ...>
              const html = /<img[^>]+src="(https?:\/\/[^">]+)"/g;

              let m;
              while ((m = md.exec(text)) !== null) urls.add(m[1]);
              while ((m = html.exec(text)) !== null) urls.add(m[1]);

              return Array.from(urls);
            }

            function buildImagePreviewBlock(urls) {
              if (!urls || urls.length === 0) return "";
              const blocks = urls.map((u, idx) => {
                // summaryå†…ã«ã‚µãƒ ãƒã‚’ç½®ãï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹é–‰ãƒ»åˆ¥ã‚¿ãƒ–å›é¿ï¼‰
                return [
                  `<details>`,
                  `  <summary>ğŸ–¼ æ·»ä»˜ç”»åƒ${idx + 1}ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹ãï¼ã‚‚ã†ä¸€åº¦ã§é–‰ã˜ã‚‹ï¼‰ <img src="${u}" width="220" alt="thumb"></summary>`,
                  `  <p><img src="${u}" width="900" alt="full"></p>`,
                  `</details>`
                ].join("\n");
              });
              return `### æ·»ä»˜ç”»åƒï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰\n\n${blocks.join("\n\n")}\n`;
            }

            async function callOpenAI({ prompt }) {
              const res = await fetch("https://api.openai.com/v1/responses", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                  model,
                  input: prompt
                })
              });

              const json = await res.json();

              if (!res.ok) {
                const msg = json?.error?.message || JSON.stringify(json);
                throw new Error(msg);
              }

              // ã§ãã‚‹ã ã‘é ‘ä¸ˆã«å–ã‚Šå‡ºã™
              if (typeof json.output_text === "string" && json.output_text.trim()) return json.output_text.trim();

              // fallback: output[] ã‹ã‚‰ text ã‚’é›†ã‚ã‚‹
              const out = [];
              const arr = Array.isArray(json.output) ? json.output : [];
              for (const item of arr) {
                const content = item?.content;
                if (!Array.isArray(content)) continue;
                for (const c of content) {
                  if (c?.type === "output_text" && typeof c?.text === "string") out.push(c.text);
                }
              }
              return out.join("\n").trim() || "(ç©ºã®å¿œç­”ã§ã—ãŸ)";
            }

            // --- main ---
            const body = issue?.body || "";
            const title = issue?.title || "";
            const imageUrls = extractImageUrls(body);

            // APIã‚­ãƒ¼æœªè¨­å®šãªã‚‰ã€ãã®å ´ã§ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦æ­¢ã‚ã‚‹
            if (!apiKey) {
              const msg = [
                "## Botè¿”ä¿¡ï¼ˆTASKï¼‰",
                "",
                "ï¼ˆå†…éƒ¨ã‚¨ãƒ©ãƒ¼ï¼‰OPENAI_API_KEY ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆSecrets æœªè¨­å®šï¼‰",
                "",
                "### æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ1ã¤ã ã‘ï¼‰",
                "Repository ã® **Settings â†’ Secrets and variables â†’ Actions** ã‚’é–‹ãã€",
                "Secrets ã« **PENAI_API_KEY**ï¼ˆã¾ãŸã¯ OPENAI_API_KEYï¼‰ ãŒå…¥ã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
                "",
                "â€»ã‚­ãƒ¼æœ¬ä½“ã¯Issueæœ¬æ–‡ã‚„ã‚³ãƒ¡ãƒ³ãƒˆã«è²¼ã‚‰ãªã„ã§ãã ã•ã„ã€‚"
              ].join("\n");
              await github.rest.issues.createComment({ owner, repo, issue_number: issue.number, body: msg });
              return;
            }

            const prompt = [
              "ã‚ãªãŸã¯ã€AIæˆ¦ç•¥ä¼šè­°å®¤ã€ã®Issueã‚’æ•´ç†ã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚",
              "æ—¥æœ¬èªã§ã€çŸ­ãã€å®Ÿå‹™çš„ã«å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚",
              "",
              "å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼š",
              "## Botè¿”ä¿¡ï¼ˆTASKï¼‰",
              "",
              "### è¦æ—¨",
              "ï¼ˆ2ã€œ4è¡Œï¼‰",
              "",
              "### æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ1ã¤ã ã‘ï¼‰",
              "ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»Šã™ãã‚„ã‚‹1æ‰‹ã ã‘ï¼‰",
              "",
              "### æ‰‹é †ï¼ˆStep 1â†’ï¼‰",
              "Step 1: ...",
              "Step 2: ...",
              "",
              "### ã†ã¾ãã„ã‹ãªã„æ™‚",
              "ï¼ˆã‚ˆãã‚ã‚‹åŸå› ã‚’2ã€œ4å€‹ï¼‰",
              "",
              "### æ³¨æ„ç‚¹",
              "ï¼ˆAPIã‚­ãƒ¼ã¯è²¼ã‚‰ãªã„ã€ãªã©ï¼‰",
              "",
              "å…¥åŠ›ï¼ˆIssueï¼‰ï¼š",
              `ã‚¿ã‚¤ãƒˆãƒ«: ${title}`,
              "æœ¬æ–‡:",
              body
            ].join("\n");

            let replyText;
            try {
              replyText = await callOpenAI({ prompt });
            } catch (e) {
              replyText = [
                "## Botè¿”ä¿¡ï¼ˆTASKï¼‰",
                "",
                "### è¦æ—¨",
                "Botå´ã§AIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
                "",
                "### æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ1ã¤ã ã‘ï¼‰",
                "Actions ã®å®Ÿè¡Œãƒ­ã‚°ã‚’é–‹ã„ã¦ã€èµ¤ã„ã‚¨ãƒ©ãƒ¼è¡Œï¼ˆã„ã¡ã°ã‚“ä¸‹ï¼‰ã‚’ã“ã®Issueã«è²¼ã£ã¦ãã ã•ã„ã€‚",
                "",
                "### æ‰‹é †ï¼ˆStep 1â†’ï¼‰",
                "Step 1: Actions â†’ è©²å½“Run â†’ Logs ã‚’é–‹ã",
                "Step 2: ã„ã¡ã°ã‚“ä¸‹ã®èµ¤ã„è¡Œã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€ã“ã®Issueã«è²¼ã‚‹",
                "",
                "### ã†ã¾ãã„ã‹ãªã„æ™‚",
                "- Secretsåã®ä¸ä¸€è‡´ï¼ˆPENAI_API_KEY / OPENAI_API_KEYï¼‰",
                "- ãƒ¢ãƒ‡ãƒ«åãŒç„¡åŠ¹",
                "- OpenAIå´ã®ä¸€æ™‚ã‚¨ãƒ©ãƒ¼",
                "",
                "### æ³¨æ„ç‚¹",
                "- APIã‚­ãƒ¼æœ¬ä½“ã¯è²¼ã‚‰ãªã„"
              ].join("\n");
            }

            const preview = buildImagePreviewBlock(imageUrls);
            const tail = "\n---\n\næ‰¿èªã—ã¦æ¬¡ã¸é€²ã‚ã‚‹ã¨ãã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã« `/approve` ã¨æ›¸ã„ã¦ãã ã•ã„ã€‚\n";

            await github.rest.issues.createComment({
              owner, repo, issue_number: issue.number,
              body: replyText + "\n\n" + preview + tail
            });
