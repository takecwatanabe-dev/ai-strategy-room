# ==============================================================
# AI戦略会議室｜Issue LLM Bot
# Version: v1.0.4
# Date: 2025-12-16 11:49 JST
# Changes:
# - YAML構文崩れ（L57付近）を根治：イベント読み取り/プロンプト生成をPythonに集約
# - /approve または /check のコメント時だけ返信（それ以外のコメントは成功終了でスキップ）
# - OpenAI Responses API の本文抽出を堅牢化（output_text or output[].content[].text）
# - 添付画像URLを最大4枚まで <details> で自動プレビュー付与
# ==============================================================

name: Issue LLM Bot

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  bot:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

      - name: Build prompt from event
        id: ctx
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import json, os, re, textwrap

          event_path = os.environ.get("GITHUB_EVENT_PATH")
          event_name = os.environ.get("GITHUB_EVENT_NAME", "")

          with open(event_path, "r", encoding="utf-8") as f:
            e = json.load(f)

          issue = e.get("issue") or {}
          comment_obj = e.get("comment") or {}

          issue_number = issue.get("number") or ""
          issue_title  = issue.get("title") or ""
          issue_body   = issue.get("body") or ""
          comment_body = comment_obj.get("body") or ""

          # /approve または /check のときだけ動く（それ以外はスキップ）
          should_run = True
          if event_name == "issue_comment":
            if ("/approve" not in comment_body) and ("/check" not in comment_body):
              should_run = False

          # 画像URL（最大4）
          text_all = (issue_body or "") + "\n" + (comment_body or "")
          urls = re.findall(r'https?://[^\s)"]+', text_all)
          img_urls = []
          for u in urls:
            if ("user-images.githubusercontent.com" in u) or ("/assets/" in u and "github.com/" in u) or ("githubusercontent.com" in u and "user-attachments" in u):
              img_urls.append(u)
          img_urls = img_urls[:4]

          base = """あなたは「戦略的会議室」の議事進行AIです。
          次のIssue/コメントを読み、必ず【出力形式】だけで日本語で返信してください。

          【出力形式】
          1) 要旨（1〜2行）
          2) 次の1アクション（クリック/入力まで具体）

          【注意】
          - 余計な前置きは不要
          - 画像プレビューはシステム側で付けるので、本文に画像URLは貼らない
          """

          context = f"""---- INPUT ----
          Event: {event_name}
          Issue #: {issue_number}
          Title:
          {issue_title}

          Body:
          {issue_body}
          """

          if event_name == "issue_comment":
            context += f"""

          Comment:
          {comment_body}
          """

          prompt = textwrap.dedent(base).strip() + "\n\n" + textwrap.dedent(context).strip() + "\n"

          with open("prompt.txt", "w", encoding="utf-8") as f:
            f.write(prompt)

          with open("images.txt", "w", encoding="utf-8") as f:
            for u in img_urls:
              f.write(u + "\n")

          # GitHub Outputs
          out_path = os.environ.get("GITHUB_OUTPUT")
          def out(k, v):
            with open(out_path, "a", encoding="utf-8") as o:
              o.write(f"{k}={v}\n")

          out("issue_number", str(issue_number))
          out("should_run", "true" if should_run else "false")
          PY

      - name: Skip (no command)
        if: ${{ steps.ctx.outputs.should_run != 'true' }}
        shell: bash
        run: |
          echo "Skip: comment does not include /approve or /check"

      - name: Call OpenAI (Responses API)
        if: ${{ steps.ctx.outputs.should_run == 'true' }}
        id: llm
        shell: bash
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail

          PROMPT_JSON=$(jq -Rs . < prompt.txt)

          OPENAI_JSON=$(curl -sS -X POST https://api.openai.com/v1/responses \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"gpt-4o\",
              \"input\":
