# ISSUE LLM BOT â€” v0.1.0-imgdetails-stable-01
# Build: 2025-12-16 16:20 JST
# Policy:
#  - [TASK] Issue: è‡ªå‹•è¿”ä¿¡ï¼ˆè¦æ—¨ï¼‹æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
#  - /check or /approve ã‚³ãƒ¡ãƒ³ãƒˆ: è‡ªå‹•è¿”ä¿¡
#  - ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ã€Œãã®ã‚³ãƒ¡ãƒ³ãƒˆã«ç”»åƒãŒã‚ã‚‹æ™‚ã ã‘ã€å‡ºã™ï¼ˆéå»ã‚³ãƒ¡ãƒ³ãƒˆ/æœ¬æ–‡ã¯æ‹¾ã‚ãªã„ï¼‰
#  - <details><summary>ğŸ“· æ·»ä»˜ç”»åƒï¼ˆNæšï¼‰</summary> ã§æŠ˜ã‚ŠãŸãŸã¿ã€ç”»åƒã®é–“ã«ç©ºè¡Œã‚’1ã¤

name: issue-llm-bot

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  llm_task:
    runs-on: ubuntu-latest

    steps:
      - name: Load Event Context
        id: ctx
        shell: bash
        run: |
          set -eu

          EVENT_NAME="${GITHUB_EVENT_NAME}"

          ISSUE_NUMBER="$(jq -r '.issue.number // empty' "$GITHUB_EVENT_PATH")"
          ISSUE_TITLE="$(jq -r '.issue.title // ""' "$GITHUB_EVENT_PATH")"
          ISSUE_BODY="$(jq -r '.issue.body // ""' "$GITHUB_EVENT_PATH")"
          COMMENT_BODY="$(jq -r '.comment.body // ""' "$GITHUB_EVENT_PATH")"

          {
            echo "EVENT_NAME=$EVENT_NAME"
            echo "ISSUE_NUMBER=$ISSUE_NUMBER"
            echo "ISSUE_TITLE<<'EOF'"
            echo "$ISSUE_TITLE"
            echo "EOF"
            echo "ISSUE_BODY<<'EOF'"
            echo "$ISSUE_BODY"
            echo "EOF"
            echo "COMMENT_BODY<<'EOF'"
            echo "$COMMENT_BODY"
            echo "EOF"
          } >> "$GITHUB_ENV"

          echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Decide Should Reply
        id: decide
        shell: bash
        run: |
          set -eu

          SHOULD_REPLY="false"
          COMMAND=""

          if [[ "$EVENT_NAME" == "issues" ]]; then
            # [TASK] ã§å§‹ã¾ã‚‹Issueã ã‘è‡ªå‹•è¿”ä¿¡
            if printf "%s" "$ISSUE_TITLE" | grep -Eq '^\[TASK\]'; then
              SHOULD_REPLY="true"
              COMMAND="task"
            fi
          elif [[ "$EVENT_NAME" == "issue_comment" ]]; then
            # /check /approveï¼ˆã‚¹ãƒ©ãƒƒã‚·ãƒ¥è¤‡æ•°ã‚‚è¨±å®¹ï¼‰
            if printf "%s" "$COMMENT_BODY" | grep -Eq '^\s*/+(check|approve)\b'; then
              SHOULD_REPLY="true"
              COMMAND="$(printf "%s" "$COMMENT_BODY" | sed -nE 's/^\s*\/+(check|approve)\b.*/\1/p' | head -n1)"
            fi
          fi

          echo "should_reply=$SHOULD_REPLY" >> "$GITHUB_OUTPUT"
          echo "command=$COMMAND" >> "$GITHUB_OUTPUT"

          echo "::notice::should_reply=$SHOULD_REPLY / command=$COMMAND"

      - name: Extract Images From Current Comment Only
        id: img
        if: steps.decide.outputs.should_reply == 'true' && env.EVENT_NAME == 'issue_comment'
        env:
          COMMENT_BODY: ${{ env.COMMENT_BODY }}
        shell: bash
        run: |
          set -eu

          python3 - << 'PY'
          import os, re

          text = os.environ.get("COMMENT_BODY","") or ""

          # ã€Œãã®ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã€ã‹ã‚‰ã ã‘æŠ½å‡ºï¼ˆéå»ã‚³ãƒ¡ãƒ³ãƒˆ/Issueæœ¬æ–‡ã¯è¦‹ãªã„ï¼‰
          patterns = [
            r'!\[[^\]]*\]\((https?://[^)]+)\)',
            r'(https?://github\.com/user-attachments/assets/[^\s)]+)',
            r'(https?://private-user-images\.githubusercontent\.com/[^\s)]+)',
            r'(https?://user-images\.githubusercontent\.com/[^\s)]+)',
            r'(https?://[^ \n)]+?\.(?:png|jpe?g|gif|webp)(?:\?[^ \n)]+)?)',
          ]

          urls = []
          seen = set()
          for p in patterns:
            for u in re.findall(p, text, flags=re.IGNORECASE):
              u = (u or "").strip().strip('"').strip("'")
              if not u:
                continue
              if u not in seen:
                seen.add(u)
                urls.append(u)

          with open("image_urls.txt","w",encoding="utf-8") as f:
            for u in urls:
              f.write(u + "\n")

          print(len(urls))
          PY

          IMAGE_COUNT="$(wc -l < image_urls.txt | tr -d ' ')"
          SHOULD_RUN="false"
          if [[ "${IMAGE_COUNT:-0}" -gt 0 ]]; then SHOULD_RUN="true"; fi

          echo "image_count=$IMAGE_COUNT" >> "$GITHUB_OUTPUT"
          echo "should_run=$SHOULD_RUN" >> "$GITHUB_OUTPUT"

          echo "::notice::image_count=$IMAGE_COUNT / image-preview=$SHOULD_RUN"

      - name: Build Image Preview Markdown
        id: preview
        if: steps.img.outputs.should_run == 'true'
        shell: bash
        run: |
          set -eu

          IMAGE_COUNT="${{ steps.img.outputs.image_count }}"

          {
            echo "<details><summary>ğŸ“· æ·»ä»˜ç”»åƒï¼ˆ${IMAGE_COUNT}æšï¼‰</summary>"
            echo ""
            i=0
            while IFS= read -r url; do
              [[ -z "$url" ]] && continue
              i=$((i+1))
              if [[ "$i" -gt 1 ]]; then
                echo ""   # â† ç”»åƒã®é–“ã«ç©ºè¡Œ1ã¤
              fi
              echo "![](${url})"
            done < image_urls.txt
            echo ""
            echo "</details>"
          } > image_preview.md

      - name: Generate Bot Text (fallback if no OpenAI key)
        id: gen
        if: steps.decide.outputs.should_reply == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        shell: bash
        run: |
          set -eu

          COMMAND="${{ steps.decide.outputs.command }}"

          # ã¾ãšã¯å®‰å®šå„ªå…ˆï¼šOpenAIãŒç„¡ãã¦ã‚‚å¿…ãšè¿”ä¿¡ã™ã‚‹
          if [[ -z "${OPENAI_API_KEY:-}" ]]; then
            {
              echo "1. è¦æ—¨"
              if [[ "$COMMAND" == "task" ]]; then
                echo "IssueãŒ [TASK] ã®ãŸã‚ã€è‡ªå‹•è¿”ä¿¡ã—ã¦ã„ã¾ã™ã€‚"
              else
                echo "/$COMMAND ã‚’å—ã‘å–ã‚Šã¾ã—ãŸã€‚"
              fi
              echo ""
              echo "2. æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"
              echo "Actions ã®å®Ÿè¡Œãƒ­ã‚°ã‚’é–‹ãã€ç›´è¿‘RunãŒ success ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
              echo ""
              echo "3. å—ã‘å…¥ã‚Œæ¡ä»¶"
              echo "ãƒ»BotãŒè¿”ä¿¡ã™ã‚‹"
              echo "ãƒ»ç”»åƒãŒã‚ã‚‹æ™‚ã ã‘ã€ŒğŸ“· æ·»ä»˜ç”»åƒï¼ˆNæšï¼‰ã€ãŒå‡ºã‚‹"
              echo "ãƒ»ç”»åƒã®é–“ã«ç©ºè¡ŒãŒå…¥ã‚‹"
              echo ""
              echo "4. æ³¨æ„ç‚¹"
              echo "ãƒ»YAMLã¯ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆï¼ˆè¡Œé ­ã®ç©ºç™½ï¼‰ãŒå´©ã‚Œã‚‹ã¨å‹•ãã¾ã›ã‚“ï¼ˆè¡Œé †ã‚ˆã‚Šé‡è¦ï¼‰"
            } > bot_text.md

            echo "self_check=PASS" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # OpenAIã‚ã‚Šï¼šæœ¬æ–‡ã‚’å°‘ã—è³¢ãã™ã‚‹ï¼ˆå¤±æ•—ã—ã¦ã‚‚fallbackï¼‰
          cat > prompt.txt <<'EOF'
ã‚ãªãŸã¯GitHub Issueé‹ç”¨ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚å¿…ãšæ—¥æœ¬èªã§ã€æ¬¡ã®å½¢å¼ã§çŸ­ãæ›¸ã„ã¦ãã ã•ã„ã€‚

å¿…é ˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼š
1. è¦æ—¨ï¼ˆ1ã€œ2è¡Œï¼‰
2. æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¯ãƒªãƒƒã‚¯/å…¥åŠ›ã¾ã§å…·ä½“ï¼‰
3. å—ã‘å…¥ã‚Œæ¡ä»¶ï¼ˆç®‡æ¡æ›¸ã3ã€œ5ï¼‰
4. æ³¨æ„ç‚¹ï¼ˆç®‡æ¡æ›¸ã1ã€œ3ï¼‰

åˆ¶ç´„ï¼š
- éå»ã‚³ãƒ¡ãƒ³ãƒˆã‚„Issueæœ¬æ–‡ã®ç”»åƒã¯å‚ç…§ã—ãªã„ï¼ˆç”»åƒã¯ã“ã®å¾Œã«åˆ¥æ ã§ä»˜ãï¼‰
- æŠ€è¡“ç”¨èªã¯å¿…è¦æœ€å°é™ã€‚ã‚«ã‚¿ã‚«ãƒŠèªã¯çŸ­ã„è£œè¶³ã‚’ï¼ˆã€€ï¼‰ã§ä»˜ã‘ã‚‹
EOF

          {
            echo ""
            echo "-----"
            echo "Event: $EVENT_NAME"
            echo "Issue: #$ISSUE_NUMBER"
            echo "Title:"
            echo "$ISSUE_TITLE"
            echo ""
            echo "Body:"
            echo "$ISSUE_BODY"
            if [[ "$EVENT_NAME" == "issue_comment" ]]; then
              echo ""
              echo "Comment:"
              echo "$COMMENT_BODY"
            fi
          } >> prompt.txt

          payload="$(jq -n --arg model "gpt-4o-mini" --rawfile user prompt.txt '{
            model: $model,
            temperature: 0.2,
            messages: [
              {role:"system", content:"You are a helpful assistant."},
              {role:"user", content:$user}
            ]
          }')"

          resp="$(curl -sS https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer '"$OPENAI_API_KEY"'" \
            -H "Content-Type: application/json" \
            -d "$payload" || true)"

          text="$(printf "%s" "$resp" | jq -r '.choices[0].message.content // empty' || true)"

          if [[ -z "${text:-}" ]]; then
            # fallback
            {
              echo "1. è¦æ—¨"
              echo "Botè¿”ä¿¡ã®ç”Ÿæˆã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸãŸã‚ã€ç°¡æ˜“è¿”ä¿¡ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚"
              echo ""
              echo "2. æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"
              echo "Actionsãƒ­ã‚°ã§ã‚¨ãƒ©ãƒ¼è¡Œï¼ˆèµ¤ï¼‰ã‚’1ã¤ã ã‘ç‰¹å®šã—ã¦è²¼ã£ã¦ãã ã•ã„ã€‚"
              echo ""
              echo "3. å—ã‘å…¥ã‚Œæ¡ä»¶"
              echo "ãƒ»BotãŒè¿”ä¿¡ã™ã‚‹"
              echo "ãƒ»ç”»åƒãŒã‚ã‚‹æ™‚ã ã‘ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå‡ºã‚‹"
              echo ""
              echo "4. æ³¨æ„ç‚¹"
              echo "ãƒ»YAMLã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆå´©ã‚ŒãŒæœ€é »å‡ºã§ã™"
            } > bot_text.md
          else
            printf "%s\n" "$text" > bot_text.md
          fi

          # Self-check
          if grep -q "è¦æ—¨" bot_text.md && grep -q "æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³" bot_text.md; then
            echo "self_check=PASS" >> "$GITHUB_OUTPUT"
          else
            echo "self_check=FAIL" >> "$GITHUB_OUTPUT"
          fi

      - name: Compose Final Comment
        id: compose
        if: steps.decide.outputs.should_reply == 'true'
        shell: bash
        run: |
          set -eu
          cp bot_text.md final_comment.md

          # ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ã€Œãã®ã‚³ãƒ¡ãƒ³ãƒˆã«ç”»åƒãŒã‚ã‚‹æ™‚ã ã‘ã€
          if [[ -f image_preview.md ]]; then
            echo "" >> final_comment.md
            cat image_preview.md >> final_comment.md
          fi

      - name: Post Comment to Issue
        if: steps.decide.outputs.should_reply == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -eu

          OWNER="${{ github.repository_owner }}"
          REPO_NAME="$(echo "${{ github.repository }}" | cut -d/ -f2)"
          ISSUE_NUMBER="${{ steps.ctx.outputs.issue_number }}"

          body="$(cat final_comment.md)"

          gh api "repos/${OWNER}/${REPO_NAME}/issues/${ISSUE_NUMBER}/comments" \
            -f body="$body"

          echo "::notice::posted comment to #$ISSUE_NUMBER (self_check=${{ steps.gen.outputs.self_check || 'N/A' }})"
