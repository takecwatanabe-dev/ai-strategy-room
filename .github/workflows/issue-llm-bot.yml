# Issue LLM Bot v0.1.0
# Build: 2025-12-13 JST
# Purpose:
#  - [TASK] で始まるIssueが opened / reopened されたら、自動でコメント返信する
#  - OpenAI → 失敗したら Gemini にフォールバック
# Notes:
#  - APIキーは secrets から参照（ログに出さない）
#  - secrets名: OPENAI_API_KEY / GEMINI_API_KEY

name: Issue LLM Bot

on:
  issues:
    types: [opened, reopened]

permissions:
  issues: write
  contents: read

jobs:
  reply:
    if: startsWith(github.event.issue.title, '[TASK]')
    runs-on: ubuntu-latest

    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Generate reply (OpenAI -> fallback Gemini)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          python - <<'PY'
          import os, json, urllib.request

          title = (os.getenv("ISSUE_TITLE") or "").strip()
          body  = (os.getenv("ISSUE_BODY")  or "").strip()

          prompt = f"""あなたはプロジェクト補助AIです。
          ユーザーは「コピペ量を減らしたい」ので、回答は短く・実行しやすく。

          次の形式で日本語Markdownで返してください:
          1) 要旨（1〜2行）
          2) 次の1アクション（クリック/入力まで具体）
          3) うまくいかない時の分岐（A/Bで2つまで）
          4) 注意点（秘密情報は貼らない、など1〜2行）

          --- Issue Title ---
          {title}

          --- Issue Body ---
          {body}
          """

          def call_openai(p: str) -> str:
            api_key = (os.getenv("OPENAI_API_KEY") or "").strip()
            if not api_key:
              raise RuntimeError("OPENAI_API_KEY missing")

            url = "https://api.openai.com/v1/chat/completions"
            payload = {
              "model": "gpt-4o-mini",
              "messages": [
                {"role": "system", "content": "You are a helpful assistant."},
                {"role": "user", "content": p}
              ],
              "temperature": 0.2
            }

            req = urllib.request.Request(
              url,
              data=json.dumps(payload).encode("utf-8"),
              headers={
                "Authorization": f"Bearer {api_key}",
                "Content-Type": "application/json"
              }
            )
            with urllib.request.urlopen(req, timeout=40) as r:
              data = json.loads(r.read().decode("utf-8"))
            return data["choices"][0]["message"]["content"].strip()

          def call_gemini(p: str) -> str:
            api_key = (os.getenv("GEMINI_API_KEY") or "").strip()
            if not api_key:
              raise RuntimeError("GEMINI_API_KEY missing")

            url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key={api_key}"
            payload = {
              "contents": [{"role": "user", "parts": [{"text": p}]}],
              "generationConfig": {"temperature": 0.2}
            }

            req = urllib.request.Request(
              url,
              data=json.dumps(payload).encode("utf-8"),
              headers={"Content-Type": "application/json"}
            )
            with urllib.request.urlopen(req, timeout=40) as r:
              data = json.loads(r.read().decode("utf-8"))

            cand = (data.get("candidates") or [{}])[0]
            parts = (((cand.get("content") or {}).get("parts")) or [])
            text = "".join([x.get("text", "") for x in parts]).strip()
            if not text:
              raise RuntimeError("Gemini empty response")
            return text

          used = ""
          try:
            reply = call_openai(prompt)
            used = "OpenAI"
          except Exception as e:
            try:
              reply = call_gemini(prompt)
              used = "Gemini"
            except Exception as e2:
              reply = (
                "自動返信に失敗しました。\n\n"
                f"- OpenAI: {type(e).__name__}\n"
                f"- Gemini: {type(e2).__name__}\n\n"
                "（管理者向け）Actionsのログを確認してください。"
              )
              used = "FallbackError"

          reply = reply + f"\n\n---\n_bot: {used}_"

          with open("reply.md", "w", encoding="utf-8") as f:
            f.write(reply)

          print("reply.md generated")
          PY

      - name: Post comment to issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('reply.md', 'utf8');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body
            });
