# ================================================================
# AI戦略会議室 | Issue LLM Bot
# Version: v1.0.6
# Date: 2025-12-16 13:20 JST
# Changes:
#  - /approve または /check コメントに画像がある場合のみプレビュー生成
#  - 画像が無い場合はプレビュー全体を出力しない（スキップ）
#  - 過去Issue本文や過去コメントの画像は一切参照しない（完全独立）
# ================================================================

name: Issue LLM Bot

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  bot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build prompt & selective preview (Python)
        id: build
        env:
          EVENT_NAME: ${{ github.event_name }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          python - <<'PY'
          import os, re, json
          from pathlib import Path

          Path(".tmp").mkdir(parents=True, exist_ok=True)

          event = (os.getenv("EVENT_NAME") or "").strip()
          issue_number = (os.getenv("ISSUE_NUMBER") or "").strip()
          title = (os.getenv("ISSUE_TITLE") or "").strip()
          issue_body = os.getenv("ISSUE_BODY") or ""
          comment_body = os.getenv("COMMENT_BODY") or ""

          def has_cmd(s: str) -> bool:
            return bool(re.search(r'(^|\s)/(approve|check)(\s|$)', s or "", flags=re.IGNORECASE))

          def extract_images(text: str):
            urls = []
            if not text:
              return []
            # Markdown ![](URL)
            urls += re.findall(r'!\[[^\]]*\]\((https?://[^)\s]+)\)', text)
            # HTML <img src="URL">
            urls += re.findall(r'<img[^>]+src=["\'](https?://[^"\']+)["\']', text, flags=re.IGNORECASE)
            # remove duplicates
            seen, out = set(), []
            for u in urls:
              if u not in seen:
                seen.add(u)
                out.append(u)
            return out[:4]

          should_run = False
          image_urls = []

          if event == "issue_comment" and has_cmd(comment_body):
            should_run = True
            image_urls = extract_images(comment_body)

          Path(".tmp/image_urls.json").write_text(json.dumps(image_urls, ensure_ascii=False), encoding="utf-8")

          # build request JSON
          prompt = f"""# 要約
          1) 要旨（1〜2行）
          2) 次の1アクション（クリック/入力まで具体）
          3) 受け入れ条件（チェック項目）
          4) 注意点（秘密情報は書かない）

          # Issue {issue_number}: {title}
          {issue_body}

          # コメント
          {comment_body}
          """

          Path(".tmp/prompt.txt").write_text(prompt, encoding="utf-8")

          Path(os.environ["GITHUB_OUTPUT"]).write_text(f"should_run={'true' if should_run else 'false'}\n", encoding="utf-8")
          PY

      - name: Skip if not approved
        if: steps.build.outputs.should_run != 'true'
        run: echo "Skip (not /approve or /check comment)."

      - name: Call OpenAI Responses API
        if: steps.build.outputs.should_run == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          from pathlib import Path
          prompt = Path(".tmp/prompt.txt").read_text(encoding="utf-8")
          images = json.loads(Path(".tmp/image_urls.json").read_text(encoding="utf-8"))
          content = [{"type":"input_text","text":prompt}]
          for u in images:
            content.append({"type":"input_image","image_url":u})
          data = {
            "model":"gpt-4o-mini",
            "input":[{"role":"user","content":content}],
            "temperature":0.2
          }
          Path(".tmp/request.json").write_text(json.dumps(data,ensure_ascii=False),encoding="utf-8")
          PY

          curl -sS https://api.openai.com/v1/responses \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d @.tmp/request.json > .tmp/response.json

      - name: Post comment to Issue
        if: steps.build.outputs.should_run == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - <<'PY'
          import json
          from pathlib import Path

          resp = json.loads(Path(".tmp/response.json").read_text(encoding="utf-8"))
          text = resp.get("output_text")
          if not text:
            text = "（Bot）返信本文の抽出に失敗しました。Actionsログを確認してください。"

          images = json.loads(Path(".tmp/image_urls.json").read_text(encoding="utf-8"))
          preview = ""
          if images:
            preview = "\n\n<details>\n<summary>添付画像（プレビュー）</summary>\n\n" + \
                      "\n".join([f'<img src="{u}" width="720">' for u in images]) + \
                      "\n\n</details>\n"

          body = text.strip() + preview

          Path(".tmp/comment.json").write_text(json.dumps({"body":body},ensure_ascii=False),encoding="utf-8")
          PY

          curl -sS -X POST \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
            -d @.tmp/comment.json > /dev/null
