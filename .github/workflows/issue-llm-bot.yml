# ================================================================
# AIæˆ¦ç•¥ä¼šè­°å®¤ï½œIssue LLM Bot
# Version: v1.0.5-fixed
# Date: 2025-12-16 12:23 JST
# Changes:
# - YAMLæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ä¿®æ­£ï¼ˆL57å¯¾å¿œï¼‰
# - æœ¬æ–‡HTMLã®èª¤ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å¯¾ç­–ï¼ˆjqã‚¨ã‚¹ã‚±ãƒ¼ãƒ—è¿½åŠ ï¼‰
# - BotãŒæœ¬æ–‡å…¨ä½“ã‚’ç”»åƒã¨ã—ã¦èª¤å‡ºåŠ›ã™ã‚‹å•é¡Œã‚’ä¿®æ­£
# ================================================================

name: Issue LLM Bot

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  bot:
    runs-on: ubuntu-latest
    steps:
      - name: Set up job
        run: echo "ðŸš€ Start Issue LLM Bot"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Build prompt & images (Python)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "âš™ï¸ Building prompt..."

          # ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥ã§åˆ†å²
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_BODY="${{ github.event.comment.body }}"
            PROMPT_TEXT="Comment on Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}"
          else
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_BODY="${{ github.event.issue.body }}"
            PROMPT_TEXT="Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}"
          fi

          # âœ… æœ¬æ–‡ã®HTMLã‚¿ã‚°ã‚„ç”»åƒURLã‚’æ–‡å­—åˆ—åŒ–ã—ã¦å®‰å…¨ã«æ‰±ã†
          ISSUE_BODY=$(echo "$ISSUE_BODY" | jq -Rs . | jq -r .)

          echo "Prompt created for Issue #${ISSUE_NUMBER}"

      - name: Skip if not approved
        if: ${{ !contains(github.event.comment.body, '/approve') && github.event_name == 'issue_comment' }}
        run: echo "â­ï¸ Skipping non-approved comment"

      - name: Call OpenAI Responses API
        if: ${{ contains(github.event.comment.body, '/check') || github.event_name == 'issues' }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ðŸ§  Calling OpenAI API..."
          PROMPT_JSON=$(jq -n --arg prompt "$PROMPT_TEXT\n\n$ISSUE_BODY" '{model:"gpt-4o-mini",input:$prompt}')
          echo "$PROMPT_JSON" > prompt.json

          curl -s https://api.openai.com/v1/responses \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d @prompt.json \
            -o response.json

          jq . response.json

      - name: Post comment to Issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ’¬ Posting response to issue..."
          BODY=$(jq -r '.output[0].content[0].text // "No response generated."' response.json)
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -f body="$BODY"

      - name: Complete job
        run: echo "âœ… Job completed successfully"
