name: AI Room Mock

on:
  issue_comment:
    types: [created]

permissions:
  issues: write

jobs:
  ai_room_mock:
    runs-on: ubuntu-latest
    if: |
      github.event.comment.user.type != 'Bot' &&
      github.actor != 'github-actions[bot]' &&
      contains(github.event.comment.body, '/room')

    steps:
      - name: Post Mock Response (3 headings + optional image preview)
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.payload.issue?.number;
            const commentBody  = context.payload.comment?.body || "";

            if (!issue_number) return;

            // ç”»åƒURLã¯ã€Œãã®ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã€ã‹ã‚‰ã ã‘æŠ½å‡ºï¼ˆéå»/æœ¬æ–‡ã¯æ‹¾ã‚ãªã„ï¼‰
            const patterns = [
              /!\[[^\]]*\]\((https?:\/\/[^\s)]+)\)/g,                 // Markdown ![](...)
              /<img[^>]+src=["'](https?:\/\/[^"']+)["'][^>]*>/gi,     // HTML <img src="">
              /(https?:\/\/github\.com\/user-attachments\/assets\/[^\s)]+)/g,
              /(https?:\/\/user-images\.githubusercontent\.com\/[^\s)]+)/g,
              /(https?:\/\/private-user-images\.githubusercontent\.com\/[^\s)]+)/g
            ];

            let urls = [];
            for (const re of patterns) {
              let m;
              while ((m = re.exec(commentBody)) !== null) {
                const u = (m[1] || m[0] || "").trim();
                if (u) urls.push(u);
              }
            }
            urls = [...new Set(urls)];

            // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆ0æšãªã‚‰å‡ºã•ãªã„ï¼‰
            let preview = "";
            if (urls.length > 0) {
              const imgs = urls.map(u => `![](${u})`).join("\n\n"); // ç©ºè¡Œ1ã¤
              preview =
                `<details><summary>ğŸ“· æ·»ä»˜ç”»åƒï¼ˆ${urls.length}æšï¼‰</summary>\n\n` +
                `${imgs}\n\n</details>`;
            }

            // 3ã‚«ãƒ©ãƒ åˆ†é›¢ç”¨ãƒ¢ãƒƒã‚¯ï¼ˆè¦‹å‡ºã—å›ºå®šï¼‰
            const mock = [
              "### ğŸ¤ YUIï¼ˆãƒ¢ãƒƒã‚¯æ–‡ï¼‰",
              "ã“ã“ã«Yuiã®è¿”ç­”ãŒå…¥ã‚Šã¾ã™ã€‚",
              "",
              "### ğŸ¦ REXï¼ˆãƒ¢ãƒƒã‚¯æ–‡ï¼‰",
              "ã“ã“ã«Rexã®è¿”ç­”ãŒå…¥ã‚Šã¾ã™ã€‚",
              "",
              "### âœ¨ GEMINIï¼ˆãƒ¢ãƒƒã‚¯æ–‡ï¼‰",
              "ã“ã“ã«Geminiã®è¿”ç­”ãŒå…¥ã‚Šã¾ã™ã€‚"
            ].join("\n");

            let body = mock;
            if (preview) body = `${preview}\n\n---\n\n${mock}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body
            });
