# ==============================================================
# AI戦略会議室｜Rex Dispatch Workflow
# Version: v1.0.1
# Date: 2025-12-16 11:11 JST
# 修正内容:
# - YAML構文エラー（line 141付近）修正
# - context_textブロックを安全なPython文法で再構成
# ==============================================================

name: Rex Dispatch
on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/rex-dispatch.yml"

jobs:
  run-dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          pip install requests PyYAML

      - name: Generate Rex Instruction
        id: generate
        run: |
          import os, textwrap, json

          def shorten(text, length=1200):
              s = str(text or "")
              return (s[:length] + "…(略)") if len(s) > length else s

          issue_url = os.getenv("GITHUB_SERVER_URL") + "/" + os.getenv("GITHUB_REPOSITORY") + "/issues/" + os.getenv("GITHUB_REF_NAME", "main")
          issue_title = "AI会議室ディスパッチ"
          issue_body = "会議ログの内容を取得中です。"
          comments = [{"user": "system", "body": "コメントテスト"}]

          # --- ここが今回修正箇所 ---
          context_text = (
              "【元Issue】\n"
              f"URL: {issue_url}\n"
              f"Title: {issue_title}\n\n"
              "Body:\n"
              f"{issue_body}\n\n"
              "【直近コメント（最大12件）】\n"
              + "\n\n".join([f"- {x['user']}:\n{shorten(x['body'], 1200)}" for x in comments])
          )
          # -----------------------------

          prompt = textwrap.dedent(f"""
          あなたは「戦略的会議室」の実装担当です。
          次のIssue情報をもとに、Rex（実装担当）が作業できる「実装指示書」を日本語Markdownで出力してください。

          出力形式（Markdown）:
          1. 目的（1〜2行）
          2. 対応概要（簡潔）
          3. 実装手順（Step形式）
          4. チェック項目（3点以内）
          5. 注意点（構文・依存関係など）

          --- 入力 ---
          {context_text}
          """)

          with open("rex_prompt.txt", "w", encoding="utf-8") as f:
              f.write(prompt)

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: rex-prompt
          path: rex_prompt.txt
